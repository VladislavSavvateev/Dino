00000000                            ; This is a example of start of ROM.
00000000                            
00000000                            		include	macro.asm												; macroses
00000000                            
00000000                            ; =============================================================
00000000                            ; Joypad button indexes & values
00000000                            ; For theld and tpress macros
00000000                            ; -------------------------------------------------------------
00000000                            
00000000                            ; $FFFFF602	= SonicControl|Held
00000000                            ; $FFFFF603	= SonicControl|Press
00000000                            ; $FFFFF604	= Joypad|Held
00000000                            ; $FFFFF605	= Joypad|Press  
00000000                            
00000000                            
00000000 =00000000                  _normal = $0000
00000000 =00000200                  _moving	= $0200
00000000 =00000400                  _linear = $0400
00000000                            
00000000 =FFFFF602                  SonicControl	equ	$FFFFF602
00000000 =FFFFF604                  Joypad		equ	$FFFFF604
00000000                            
00000000 =FFFFF616                  ScrollBuffer	equ	$FFFFF616
00000000 =00000000                  Y_A			equ		0
00000000 =00000002                  Y_B			equ		2
00000000 =FFFFD5EA                  X_A			equ		-$2A16
00000000 =FFFFD5EC                  X_B			equ		-$2A14
00000000                            
00000000 =00000000                  Held		equ	0
00000000 =00000001                  Press		equ	1
00000000                            
00000000 =00000007                  iStart		equ 	7
00000000 =00000006                  iA		equ 	6
00000000 =00000005                  iC		equ 	5
00000000 =00000004                  iB		equ 	4
00000000 =00000003                  iRight		equ 	3
00000000 =00000002                  iLeft		equ 	2
00000000 =00000001                  iDown		equ 	1
00000000 =00000000                  iUp		equ 	0
00000000                            
00000000 =00000080                  Start		equ 	1<<7
00000000 =00000040                  A		equ 	1<<6
00000000 =00000020                  C		equ 	1<<5
00000000 =00000010                  B		equ 	1<<4
00000000 =00000008                  Right		equ 	1<<3
00000000 =00000004                  Left		equ 	1<<2
00000000 =00000002                  Down		equ 	1<<1
00000000 =00000001                  Up		equ 	1
00000000                            
00000000                            ; =============================================================
00000000                            ; Macro to check button presses
00000000                            ; Arguments:	1 - buttons to check
00000000                            ;		2 - bitfield to check
00000000                            ; -------------------------------------------------------------
00000000                            tpress	macro
00000000                            	move.b	(\2+1),d0
00000000                            	andi.b	#\1,d0
00000000                            	endm
00000000                            
00000000                            ; =============================================================
00000000                            ; Macro to check if buttons are held
00000000                            ; Arguments:	1 - buttons to check
00000000                            ;		2 - bitfield to check
00000000                            ; -------------------------------------------------------------
00000000                            theld	macro
00000000                            	move.b	\2,d0
00000000                            	andi.b	#\1,d0
00000000                            	endm
00000000                            
00000000                            ; =============================================================
00000000                            ; Macro to align data
00000000                            ; Arguments:	1 - align value
00000000                            ; -------------------------------------------------------------
00000000                            align	macro
00000000                            	cnop 0,\1
00000000                            	endm
00000000                            
00000000                            ; =============================================================
00000000                            ; Macro to set VRAM write access
00000000                            ; Arguments:	1 - raw VRAM offset
00000000                            ;		2 - register to write access bitfield in (Optional)
00000000                            ; -------------------------------------------------------------
00000000                            vram	macro
00000000                            	if (narg=1)
00000000                            		move.l	#($40000000+((\1&$3FFF)<<16)+((\1&$C000)>>14)),($C00004).l
00000000                            	else
00000000                            		move.l	#($40000000+((\1&$3FFF)<<16)+((\1&$C000)>>14)),\2
00000000                            	endc
00000000                            	endm
00000000                            
00000000                            ; =============================================================
00000000                            ; Macro to raise an error in vectors
00000000                            ; Arguments:	1 - error number
00000000                            ;		2 - branch location
00000000                            ;		3 - if exists, adds 2 to stack pointer
00000000                            ; -------------------------------------------------------------
00000000                            raise	macro
00000000                            		move.w	#\1,(-$7FC0).w
00000000                            		jmp	ErrorScreen+$38(pc)
00000000                            	endm
00000000                            	
00000000                            
00000000                            
00000000                            ; =============================================================
00000000                            stopZ80		macro
00000000                             		move.w	#$100,($A11100).l
00000000                            		nop
00000000                            		nop
00000000                            		nop
00000000                            
00000000                            @wait\@:	btst	#0,($A11100).l
00000000                            		bne.s	@wait\@
00000000                            		endm
00000000                            
00000000                            ; =============================================================
00000000                            
00000000                            startZ80	macro
00000000                            		move.w	#0,($A11100).l	; start	the Z80
00000000                            		endm
00000000                            
00000000                            ; =============================================================
00000000                            
00000000                            waitYM		macro
00000000                            @wait\@:	move.b	($A04000).l,d2
00000000                            		btst	#7,d2
00000000                            		bne.s	@wait\@
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to easy play DAC samples
00000000                            ; Arguments:	1 - track number (must be in hex!!) e.g. F; F=$8F
00000000                            ; -------------------------------------------------------------
00000000                            PlayDAC		macro
00000000                            		move.w	#$FFFFFF80,d0
00000000                            		add.w	#$\1,d0
00000000                            		jsr		PlaySample
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to easy play music and sounds
00000000                            ; Arguments:	1 - music or sound number
00000000                            ; -------------------------------------------------------------
00000000                            PlaySoMu	macro
00000000                            		move.b	#$\1,d0
00000000                            		jsr		PlaySound
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to simple fade out music
00000000                            ; Arguments:	not used
00000000                            ; -------------------------------------------------------------
00000000                            FadeOut		macro
00000000                            		move.b	#$E0,d0
00000000                            		jsr		PlaySound_Special
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to simple stop music
00000000                            ; Arguments:	not used
00000000                            ; -------------------------------------------------------------
00000000                            StopMusic	macro
00000000                            		move.b	#$E4,d0
00000000                            		jsr		PlaySound_Special
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to simple speed up music
00000000                            ; Arguments:	not used
00000000                            ; -------------------------------------------------------------
00000000                            SpeedUp		macro
00000000                            		move.b	#$E2,d0
00000000                            		jsr		PlaySound_Special
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to simple back music to normal speed
00000000                            ; Arguments:	not used
00000000                            ; -------------------------------------------------------------
00000000                            BackToNormalSpeed	macro
00000000                            		move.b	#$E3,d0
00000000                            		jsr		PlaySound_Special
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to set object VRAM settings
00000000                            ; Arguments:	1 - VRAM pointer
00000000                            ;				2 - pallet row
00000000                            ;				3 - reverse
00000000                            ; -------------------------------------------------------------
00000000                            SetVRAM	macro
00000000                            		move.w	(((\2+\3)*$1000)+\1),$4(a0)
00000000                            		endm
00000000                            ; =============================================================
00000000                            ; Macro to load art
00000000                            ; Arguments:	artoff - art offset (Nemesis)
00000000                            ;				vram_art - where store art in VRAM
00000000                            ;				paloff - pallet offset
00000000                            ;				palshft - pallet RAM shift
00000000                            ;				palclr - how many colors transfer
00000000                            ;				mapoff - map offset (Enigma)
00000000                            ;				enidec_param - parameter of EniDec
00000000                            ;				vram_map - where store map in VRAM
00000000                            ;				cols - cols
00000000                            ;				rows - rows
00000000                            ; -------------------------------------------------------------
00000000                            LoadArt	macro artoff, vram_art, paloff, palshft, palclr, mapoff, enidec_param, vram_map, cols, rows
00000000                            		vram	\vram_art
00000000                                    lea		\artoff,a0
00000000                                    jsr		NemDec
00000000                            		
00000000                            		lea		\paloff,a1
00000000                            		lea		$FFFFFB00+\palshft,a2
00000000                            		moveq	#\palclr-1,d0
00000000                            @loop\@:
00000000                            		move.w	(a1)+,(a2)+
00000000                            		dbf		d0,@loop\@
00000000                            		
00000000                                    lea    	($FF0000).l,a1
00000000                                    lea    	\mapoff,a0
00000000                                    move.w	#\enidec_param,d0
00000000                                    jsr		EniDec
00000000                            
00000000                            		lea		($FF0000).l,a1
00000000                                    vram	\vram_map,d0
00000000                                    moveq   #\cols,d1
00000000                                    moveq   #\rows,d2
00000000                                    jsr		ShowVDPGraphics
00000000                            		endm
00000000                            		
00000000                            LoadArtUnc	macro offset, size, vram
00000000                            		move.l	#($40000000+((\vram&$3FFF)<<16)+((\vram&$C000)>>14)),($C00004).l
00000000                            		move.l	#(\size/4)-1,d0
00000000                            		lea		\offset,a0
00000000                            @loop\@	move.l	(a0)+,$C00000
00000000                            		dbf		d0,@loop\@
00000000                            		endm
00000000                            
00000000                            LoadMapUnc	macro offset, size, vram, arg, cols, rows
00000000                            		lea		$FF0000,a0
00000000                            		lea		\offset,a1
00000000                            		move.l	#(\size/2)-1,d1
00000000                            @loop\@	move.w	(a1)+,d0
00000000                            		add.w	#\arg,d0
00000000                            		move.w	d0,(a0)+
00000000                            		dbf		d1,@loop\@
00000000                            
00000000                            		lea		($FF0000).l,a1
00000000                                    move.l	#($40000000+((\vram&$3FFF)<<16)+((\vram&$C000)>>14)),d0
00000000                                    moveq   #\cols-1,d1
00000000                                    moveq   #\rows-1,d2
00000000                                    jsr		ShowVDPGraphics
00000000                            		endm
00000000                            
00000000                            LoadPal	macro offset, shift, colors
00000000                            		lea		\offset,a0
00000000                            		lea		$FFFFFB00+\shift,a1
00000000                            		move.l	#\colors-1,d0
00000000                            @loop\@	move.w	(a0)+,(a1)+
00000000                            		dbf		d0,@loop\@
00000000                            		endm
00000000                            		endm
00000000                            
00000000                            StartOfRom:
00000000                            Vectors:
00000000 00FF FE00 0000 0000 0000+  		dc.l	$FFFE00,	EntryPoint,	ErrorTrap,	ErrorTrap			; $00 - $03 vectors
00000010 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $04 - $07 vectors
00000020 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $08 - $0B vectors
00000030 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $0C - $0F vectors
00000040 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $10 - $13 vectors
00000050 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $14 - $17 vectors
00000060 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $18 - $1B vectors
00000070 0000 0000 0000 0000 0000+  		dc.l	HBlank,		ErrorTrap,	VBlank,		ErrorTrap			; $1C - $1F vectors
00000080 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $20 - $23 vectors
00000090 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $24 - $27 vectors
000000A0 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $28 - $2B vectors
000000B0 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $2C - $2F vectors
000000C0 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $30 - $33 vectors
000000D0 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $34 - $37 vectors
000000E0 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $38 - $3B vectors
000000F0 0000 0000 0000 0000 0000+  		dc.l	ErrorTrap,	ErrorTrap,	ErrorTrap,	ErrorTrap			; $3C - $3F vectors
00000100 5345 4741 204D 4547 4120+  Console:	dc.b 'SEGA MEGA DRIVE '										; Console Name
00000110 28D0 A129 5653 2032 3031+  Date:		dc.b '(С)VS 2015.unk  '										; Release Date
00000121 2020 2020 2020 2020 2020+  Title_Local:	dc.b '                                                '	; Local Title
00000151 2020 2020 2020 2020 2020+  Title_Int:	dc.b '                                                '		; International Title
00000181 534F 4D45 5345 5249 414C+  Serial:		dc.b 'SOMESERIALNMBR'										; Serial Number of cartridge
0000018F 0000                       Checksum:	dc.w 0														; Checksum of ROM
00000191 4A20 2020 2020 2020 2020+  		dc.b 'J               '											; Controller functions
000001A1 0000 0000                  RomStartLoc:	dc.l StartOfRom											; Offset of start of ROM
000001A5 0000 0000                  RomEndLoc:	dc.l EndOfRom-1												; Offset of end of ROM
000001A9 00FF 0000                  RamStartLoc:	dc.l $FF0000											; Offset of start of ROM
000001AD 00FF FFFF                  RamEndLoc:	dc.l $FFFFFF												; Offset of end of ROM
000001B1 5241 F820                  SRAMSupport:	dc.l $5241F820											; SRAM value (change to $5241F820 for enable SRAM)
000001B5 0020 0000                  		dc.l $200000													; Offset of start of SRAM
000001B9 0020 3FFF                  		dc.l $203FFF													; Offset of end of SRAM
000001BD 2020 2020 2020 2020 2020+  Notes:		dc.b '                                                    '	; Notes
000001F1 4A55 4520 2020 2020 2020+  Region:		dc.b 'JUE            '										; Region
00000200                            
00000200                            ; ===========================================================================
00000200                            ErrorTrap:
00000200 4E71                       		nop
00000202 4E71                       		nop
00000204 60FA                       		bra.s	ErrorTrap			; fuck the system!
00000206                            ; ===========================================================================
00000206                            EntryPoint:
00000206 4AB9 00A1 0008             		tst.l	($A10008).l			; test port A
0000020C 6600                       		bne.s	PortA_Ok			; if it OK, branch
0000020E 4A79 00A1 000C             		tst.w	($A1000C).l			; test port C
00000214                            
00000214                            PortA_Ok:
00000214 6600                       		bne.s	PortC_Ok			; if it OK, branch
00000216 4BFA 0000                  		lea	SetupValues(pc),a5		; load setup values to a5
0000021A 4C9D 00E0                  		movem.w	(a5)+,d5-d7			; load values to d5-d7
0000021E 4CDD 1F00                  		movem.l	(a5)+,a0-a4			; load addresses to a0-a4
00000222 1029 EF01                  		move.b	-$10FF(a1),d0		; move byte from $A10001 to d0
00000226 0200 000F                  		andi.b	#$F,d0				; d0 And $F
0000022A 6700                       		beq.s	SkipSecurity		; if it zero, branch
0000022C 237C 5345 4741 2F00        		move.l	#'SEGA',$2F00(a1)	; write a control word to $A13F00
00000234                            
00000234                            SkipSecurity:
00000234 3014                       		move.w	(a4),d0				; check for working VDP
00000236 7000                       		moveq	#0,d0				; clear d0
00000238 2C40                       		movea.l	d0,a6				; clear a6
0000023A 4E66                       		move.l	a6,usp				; set usp register to #0
0000023C 7217                       		moveq	#$17,d1				; set repeat time
0000023E                            
0000023E                            VDPInitLoop:
0000023E 1A1D                       		move.b	(a5)+,d5			; move setup byte to d0
00000240 3885                       		move.w	d5,(a4)				; move setup byte from d0 to VDP
00000242 DA47                       		add.w	d7,d5				; next VDP register
00000244 51C9 FFF8                  		dbf	d1,VDPInitLoop			; repeat all program #$17 times
00000248 289D                       		move.l	(a5)+,(a4)			; send request to VDP
0000024A 3680                       		move.w	d0,(a3)				; clear screen
0000024C 3287                       		move.w	d7,(a1)				; stop Z80
0000024E 3487                       		move.w	d7,(a2)				; reset Z80
00000250                            
00000250                            WaitForZ80:
00000250 0111                       		btst	d0,(a1)				; Z80 is stopped?
00000252 66FC                       		bne.s	WaitForZ80			; if not, branch
00000254 7425                       		moveq	#$25,d2				; set repeat time
00000256                            
00000256                            Z80InitLoop:
00000256 10DD                       		move.b	(a5)+,(a0)+			; move command to Z80
00000258 51CA FFFC                  		dbf	d2,Z80InitLoop			; repeat al program #$25 times
0000025C 3480                       		move.w	d0,(a2)				; send byte to Z80
0000025E 3280                       		move.w	d0,(a1)				; start Z80
00000260 3487                       		move.w	d7,(a2)				; reset Z80
00000262                            
00000262                            ClrRAMLoop:
00000262 2D00                       		move.l	d0,-(a6)			; send clear long word to RAM
00000264 51CE FFFC                  		dbf	d6,ClrRAMLoop			; repeat all program #$3FFF times
00000268 289D                       		move.l	(a5)+,(a4)			; setup VDP
0000026A 289D                       		move.l	(a5)+,(a4)			; setup VDP for CRAM write
0000026C 761F                       		moveq	#$1F,d3				; set repeat time
0000026E                            
0000026E                            ClrCRAMLoop:
0000026E 2680                       		move.l	d0,(a3)				; send clear long word to CRAM
00000270 51CB FFFC                  		dbf	d3,ClrCRAMLoop			; repeat all program #$1F times
00000274 289D                       		move.l	(a5)+,(a4)			; set VRAM for write
00000276 7813                       		moveq	#$13,d4				; set repeat time
00000278                            
00000278                            ClrVDPStuff:
00000278 2680                       		move.l	d0,(a3)				; send clear long word to VRAM
0000027A 51CC FFFC                  		dbf	d4,ClrVDPStuff			; repeat all program #$13 times
0000027E 7A03                       		moveq	#3,d5				; set repeat time
00000280                            
00000280                            PSGInitLoop:
00000280 175D 0011                  		move.b	(a5)+,$11(a3)		; send volume level to PSG
00000284 51CD FFFA                  		dbf	d5,PSGInitLoop			; repeat all program #3 times
00000288 3480                       		move.w	d0,(a2)				; clear reset address of Z80
0000028A 4CD6 7FFF                  		movem.l	(a6),d0-a6			; clear all registers
0000028E 46FC 2700                  		move	#$2700,sr			; off exceptions
00000292                            
00000292                            PortC_Ok:
00000292 6000                       		bra.s	GameProgram			; start program
00000294                            ; ===========================================================================
00000294 8000                       SetupValues:	dc.w $8000		; XREF: PortA_Ok
00000296 3FFF                       		dc.w $3FFF
00000298 0100                       		dc.w $100
0000029A                            
0000029A 00A0 0000                  		dc.l $A00000		; начало RAM Z80
0000029E 00A1 1100                  		dc.l $A11100		; шина запросов Z80
000002A2 00A1 1200                  		dc.l $A11200		; сброс Z80
000002A6 00C0 0000                  		dc.l $C00000
000002AA 00C0 0004                  		dc.l $C00004		; адрес регистров VDP
000002AE                            
000002AE 0414 303C                  		dc.b 4,	$14, $30, $3C	; значения регистров VDP
000002B2 076C 0000                  		dc.b 7,	$6C, 0,	0
000002B6 0000 FF00                  		dc.b 0,	0, $FF,	0
000002BA 8137 0001                  		dc.b $81, $37, 0, 1
000002BE 0100 00FF                  		dc.b 1,	0, 0, $FF
000002C2 FF00 0080                  		dc.b $FF, 0, 0,	$80
000002C6                            
000002C6 4000 0080                  		dc.l $40000080
000002CA                            
000002CA AF01 D91F 1127 0021 2600+  		dc.b $AF, 1, $D9, $1F, $11, $27, 0, $21, $26, 0, $F9, $77 ; инструкции Z80
000002D6 EDB0 DDE1 FDE1 ED47 ED4F   		dc.b $ED, $B0, $DD, $E1, $FD, $E1, $ED,	$47, $ED, $4F
000002E0 D1E1 F108 D9C1 D1E1 F1F9+  		dc.b $D1, $E1, $F1, 8, $D9, $C1, $D1, $E1, $F1,	$F9, $F3
000002EB ED56 36E9 E9               		dc.b $ED, $56, $36, $E9, $E9
000002F0                            
000002F0 8104                       		dc.w $8104		; значение видеорежима VDP
000002F2 8F02                       		dc.w $8F02		; value	for VDP	increment
000002F4 C000 0000                  		dc.l $C0000000		; value	for CRAM write mode
000002F8 4000 0010                  		dc.l $40000010
000002FC                            
000002FC 9FBF DFFF                  		dc.b $9F, $BF, $DF, $FF	; values for PSG channel volumes
00000300                            ; ===========================================================================
00000300                            
00000300                            GameProgram:
00000300 4A79 00C0 0004             		tst.w	($C00004).l				; test VDP
00000306 0839 0006 00A1 000D        		btst	#6,($A1000D).l			; test 6 bit from $A1000D
0000030E 6700                       		beq.s	CheckSumCheck			; if it zero, branch
00000310 0CB8 696E 6974 FFFC        		cmpi.l	#'init',($FFFFFFFC).w   ; has checksum routine already run?
00000318 6700 0000                  		beq.w	GameInit				; if yes, branch
0000031C                            
0000031C                            CheckSumCheck:
0000031C 4DF8 FE00                  		lea	($FFFFFE00).w,a6
00000320 7E00                       		moveq	#0,d7
00000322 3C3C 007F                  		move.w	#$7F,d6
00000326                            
00000326 2CC7                       @ClearLoop:	move.l	d7,(a6)+
00000328 51CE FFFC                  		dbf	d6,@ClearLoop	; repeat $7F more times
0000032C 1039 00A1 0001             		move.b	($A10001).l,d0
00000332 0200 00C0                  		andi.b	#$C0,d0
00000336 11C0 FFF8                  		move.b	d0,($FFFFFFF8).w
0000033A 21FC 696E 6974 FFFC        		move.l	#'init',($FFFFFFFC).w ; set flag so checksum won't be run again
00000342                            
00000342                            GameInit:
00000342 4DF9 00FF 0000             		lea	($FF0000).l,a6
00000348 7E00                       		moveq	#0,d7
0000034A 3C3C 3F5F                  		move.w	#$3F7F-$20,d6
0000034E                            
0000034E                            GameClrRAM:
0000034E 2CC7                       		move.l	d7,(a6)+
00000350 51CE FFFC                  		dbf	d6,GameClrRAM	; fill RAM ($0000-$FDFF) with $0
00000354 6100 0000                  		bsr.w	VDPSetupGame
00000358 6100 0000                  		bsr.w	SoundDriverLoad
0000035C 4EB9 0000 0000             		jsr		UpdateMusic
00000362 6100 0000                  		bsr.w	JoypadInit
00000366 11FC 0000 F600             		move.b	#0,($FFFFF600).w ; set Game Mode to Sega Screen
0000036C                            
0000036C                            ; ===========================================================================
0000036C                            MainGameLoop:
0000036C 4EB9 0000 0000             		jsr		MainScreen
00000372 60F8                       		bra.s	MainGameLoop
00000374                            		
00000374                            
00000374                            ; ===========================================================================
00000374                            ; Main Screen
00000374                            ; ===========================================================================
00000374                            		include _screens\Main.asm
00000374                            ; =====================================================================
00000374                            ; Main Screen
00000374                            ; $FFFF1000 - action number
00000374                            ; =====================================================================
00000374                            MainScreen:
00000374 4DF9 00C0 0004             		lea		$C00004,a6	; load VDP
0000037A 3CBC 8004                  		move.w	#$8004,(a6)	; Reg#00: H-Int disabled, line counter disabled
0000037E 3CBC 8174                  		move.w	#$8174,(a6)	; Reg#01: DISPLAY on, V-Int enabled, DMA on, 224
00000382 3CBC 8230                  		move.w	#$8230,(a6)	; Reg#02: Plan A is $C000
00000386 3CBC 8407                  		move.w	#$8407,(a6)	; Reg#04: Plan B is $E000
0000038A 3CBC 8700                  		move.w	#$8700,(a6)	; Reg#07: backColor is 0, 0
0000038E 3CBC 8B03                  		move.w	#$8B03,(a6)	; Reg#11: Scrolling: V(F), H(EL)
00000392 3CBC 9011                  		move.w	#$9011,(a6)	; Reg#16: 512x512
00000396                            		
00000396                            		; load background
00000396 23FC 4020 0000 00C0 0004+  		LoadArtUnc	Main_Art, 1856, $0020
000003B6 41F9 0000 0000 43F8 FB00+  		LoadPal		Main_Pal, $00, 16
000003C8 41F9 00FF 0000 43F9 0000+  		LoadMapUnc	Main_Map, 3584, $E000, 1, 64, 28
000003FA                            		
000003FA                            		; load foreground
000003FA 23FC 4760 0000 00C0 0004+  		LoadArtUnc	Logo_Art, 5888, $0760
0000041A 41F9 00FF 0000 43F9 0000+  		LoadMapUnc	Logo_Map, 2240, $C000, 59, 40, 28
0000044E                            		
0000044E                            		; load Dino
0000044E 23FC 5E60 0000 00C0 0004+  		LoadArtUnc	Dino_Art, 1600, $1E60
0000046E                            		
0000046E                            		; play music
0000046E 103C 0081                  		move.b	#$81,d0
00000472 4EB9 0000 0000             		jsr		PlaySound
00000478                            		
00000478                            @loop
00000478 11FC 0002 F62A             		move.b	#2,($FFFFF62A).w
0000047E 4EB9 0000 0000             		jsr		DelayProgram
00000484                            		
00000484 5478 FE04                  		addq.w	#2,($FFFFFE04).w
00000488 4EB9 0000 0000             		jsr		MainScreen_Parallax
0000048E 4EB9 0000 0000             		jsr		MainScreen_Action
00000494 4EB9 0000 0000             		jsr		ClearSprites
0000049A 4EB9 0000 0000             		jsr		ObjectRun
000004A0                            		
000004A0 4EF8 0478                  		jmp		@loop
000004A4                            		
000004A4                            MainScreen_Action:
000004A4 7000                       		moveq	#0,d0
000004A6 1039 FFFF 1000             		move.b	$FFFF1000,d0
000004AC 303B 0000                  		move.w	@Actions(pc,d0.w),d0
000004B0 4EFB 0000                  		jmp		@Actions(pc,d0.w)
000004B4                            ; ---------------------------------------------------------------------------
000004B4                            @Actions:
000004B4 0000                       		dc.w	@WaitForStart-@Actions
000004B6 0000                       		dc.w	@LogoUp-@Actions
000004B8 0000                       		dc.w	@Nothing-@Actions
000004BA                            ; ---------------------------------------------------------------------------
000004BA                            @WaitForStart:
000004BA 0838 0007 F605             		btst	#iStart,Joypad|Press
000004C0 6700                       		beq.s	@rts
000004C2 5439 FFFF 1000             		addq.b	#2,$FFFF1000
000004C8 11FC 0001 8000             		move.b	#1,$FFFF8000
000004CE 31FC 0058 8008             		move.w	#$58,$FFFF8008
000004D4 4E75                       @rts	rts
000004D6                            ; ---------------------------------------------------------------------------
000004D6                            @LogoUp:		
000004D6 0C78 0096 8008             		cmp.w	#$96,$FFFF8008
000004DC 6700                       		beq.s	@checkDino
000004DE 5278 8008                  		addq.w	#1,$FFFF8008
000004E2                            		
000004E2                            @checkDino:
000004E2 0C78 0092 F616             		cmp.w	#146,ScrollBuffer|Y_A
000004E8 6700                       		beq.s	@nextRoutine
000004EA 5278 F616                  		addq.w	#1,ScrollBuffer|Y_A
000004EE 4E75                       		rts
000004F0                            
000004F0                            @nextRoutine:	
000004F0 5439 FFFF 1000             		addq.b	#2,$FFFF1000
000004F6 4E75                       		rts
000004F8                            ; ---------------------------------------------------------------------------
000004F8                            @Nothing:
000004F8 4E75                       		rts
000004FA                            				
000004FA                            ; ---------------------------------------------------------------------------
000004FA                            ; Parallax
000004FA                            ; ---------------------------------------------------------------------------
000004FA                            MainScreen_Parallax:
000004FA 43F9 0000 0000             		lea	@ParallaxScript,a1
00000500 4EF9 0000 0000             		jmp	ExecuteParallaxScript
00000506                            ; ---------------------------------------------------------------
00000506                            @ParallaxScript:
00000506                            		;		Mode			Speed coef.	Number of lines
00000506 0209 0100 0045             		dc.w	_moving|$09,	$0100,		69
0000050C 0207 0100 0018             		dc.w	_moving|$07,	$0100,		24
00000512 0206 0100 0018             		dc.w	_moving|$06,	$0100,		24
00000518 0205 0100 0010             		dc.w	_moving|$05,	$0100,		16
0000051E 0204 0100 0010             		dc.w	_moving|$04,	$0100,		16
00000524 0203 0100 0010             		dc.w	_moving|$03,	$0100,		16
0000052A 0202 0100 0010             		dc.w	_moving|$02,	$0100,		16
00000530 0200 0100 002B             		dc.w	_moving,		$0100,		43
00000536 FFFF                       		dc.w	-1
00000538                            ; ---------------------------------------------------------------------------
00000538                            ; Main Screen - Graphics
00000538                            ; ---------------------------------------------------------------------------
00000538                            Main_Art:
00000538                            		incbin	artunc\background.bin
00000C78                            Main_Map:
00000C78                            		incbin	mapunc\background.bin
00001A78                            Main_Pal:
00001A78                            		incbin	pallete\dino.pal
00001A8C                            		
00001A8C                            Logo_Art:
00001A8C                            		incbin	artunc\logo.bin
0000318C                            Logo_Map:
0000318C                            		incbin	mapunc\logo.bin
0000318C                            		incbin	mapunc\logo.bin
00003A4C                            		
00003A4C                            ; ===========================================================================
00003A4C                            ; Object Engine
00003A4C                            ; ===========================================================================
00003A4C                            		include _obj\Routines.asm
00003A4C                            ; =====================================================================
00003A4C                            ; ObjectRun - procedure for run object code
00003A4C                            ; Arguments:	none
00003A4C                            ; Return:		none
00003A4C                            ; =====================================================================
00003A4C                            ObjectRun:
00003A4C 41F8 8000                  		lea		$FFFF8000,a0	; load object RAM
00003A50 7E00                       		moveq	#0,d7
00003A52 7E4F                       		move.l	#79,d7			; set numbers of objects - 1
00003A54                            @loop:
00003A54 7000                       		moveq	#0,d0
00003A56 1010                       		move.b	(a0),d0
00003A58 6700                       		beq.s	@rts
00003A5A 5300                       		subq.b	#1,d0
00003A5C 43F9 0000 0000             		lea		ObjectOffsets,a1
00003A62 D040                       		add.w	d0,d0
00003A64 D040                       		add.w	d0,d0
00003A66 D3C0                       		adda.l	d0,a1
00003A68 2251                       		movea.l	(a1),a1
00003A6A 4E91                       		jsr		(a1)
00003A6C 41E8 0040                  		lea		$40(a0),a0
00003A70 51CF FFE2                  		dbf		d7,@loop
00003A74 4E75                       @rts	rts
00003A76                            
00003A76                            ; =====================================================================
00003A76                            ; FindFreeObject - function for find free space in Object RAM
00003A76                            ; Arguments:	none
00003A76                            ; Return:		a0 - offset in RAM
00003A76                            ; =====================================================================
00003A76                            FindFreeObject:
00003A76 41F8 8000                  		lea		$FFFF8000,a0	; load object RAM
00003A7A 7E00                       		moveq	#0,d7			; clear d7
00003A7C 7E4F                       		move.l	#79,d7			; set number of max objects - 1
00003A7E                            @loop:
00003A7E 7000                       		moveq	#0,d0			; clear d0
00003A80 1010                       		move.b	(a0),d0			; copy ID object to d0
00003A82 6700                       		beq.s	@rts			; if ID = 0, exit proc
00003A84 41E8 0040                  		lea		$40(a0),a0		; next object
00003A88 51CF FFF4                  		dbf		d7,@loop		; if it's last object, exit loop 
00003A8C 4E75                       @rts	rts						; return
00003A8E                            
00003A8E                            ; =====================================================================
00003A8E                            ; FindFreeSprite - function for find free space in Sprite RAM
00003A8E                            ; Arguments:	none
00003A8E                            ; Return:		a1 - offset in RAM
00003A8E                            ; =====================================================================
00003A8E                            FindFreeSprite:
00003A8E 43F8 F800                  		lea		$FFFFF800,a1	; load sprite RAM
00003A92 7000                       		moveq	#0,d0			; clear d0
00003A94 704F                       		move.l	#79,d0			; set max number of sprites
00003A96 4A29 0003                  @loop:	tst.b	3(a1)			; link is zero?
00003A9A 6700                       		beq.s	@rts			; if yes, branch (clear sprite
00003A9C                            								; has zero link)
00003A9C 43E9 0008                  		lea		8(a1),a1		; if no, load next place
00003AA0 51C8 FFF4                  		dbf		d0,@loop		; if it's last place, exit loop
00003AA4 4E75                       @rts	rts						; return
00003AA6                            		
00003AA6                            ; =====================================================================
00003AA6                            ; GetSpritesCount - function for getting sprites count
00003AA6                            ; Arguments:	none
00003AA6                            ; Return:		d0 - sprites count
00003AA6                            ; =====================================================================
00003AA6                            GetSpritesCount:
00003AA6 43F8 8000                  		lea		$FFFF8000,a1	; load sprite RAM
00003AAA 7000                       		moveq	#0,d0			; set counter to zero
00003AAC 723F                       		move.l	#63,d1			; set max number of objects
00003AAE 4A11                       @loop:	tst.b	(a1)			; object is zero?
00003AB0 6700                       		beq.s	@cont			; if yes, branch
00003AB2 5200                       		add.b	#1,d0			; if not, increment d0
00003AB4 43E9 0040                  @cont	lea		$40(a1),a1		; next object
00003AB8 51C9 FFF4                  		dbf		d1,@loop		; loop
00003ABC 4E75                       		rts
00003ABE                            		
00003ABE                            ; =====================================================================
00003ABE                            ; DisplaySprite - procedure for copy mapping to Sprite RAM
00003ABE                            ; Arguments:	2(a0) 	- artpointer (for shifting art)
00003ABE                            ;				4(a0) 	- mappings (for copy to RAM)
00003ABE                            ;				8(a0) 	- X-position on screen
00003ABE                            ;				$C(a0) 	- Y-position on screen
00003ABE                            ;				$10(a0)	- number of frame
00003ABE                            ; Return:		none
00003ABE                            ; =====================================================================
00003ABE                            DisplaySprite:
00003ABE 4EB8 3A8E                  		jsr		FindFreeSprite	; try to find free space for sprite
00003AC2 2468 0004                  		movea.l	4(a0),a2		; load object mappings
00003AC6 7000                       		moveq	#0,d0			; clear d0
00003AC8 1028 0010                  		move.b	$10(a0),d0		; load current frame
00003ACC D040                       		add.w	d0,d0			; multiple by 2 to word
00003ACE                            		
00003ACE                            		; What? I used this? fuck, i just forgot about (an,dn.w)...
00003ACE                            		
00003ACE                            		; adda.l	d0,a2			; get offset to shift to mapping
00003ACE                            		; move.w	(a2),d0			; get shift
00003ACE                            		; movea.l	4(a0),a2		; load object mappings again
00003ACE                            		; adda.l	d0,a2			; get 
00003ACE                            		
00003ACE D4F2 0000                  		adda.w	(a2,d0.w),a2	; get mapping
00003AD2 7000                       		moveq	#0,d0			; clear d0
00003AD4 101A                       		move.b	(a2)+,d0		; get number of sprites
00003AD6 5300                       		subq.b	#1,d0			; subtract 1
00003AD8                            @loop:
00003AD8 7200                       		moveq	#0,d1			; clear d1
00003ADA 121A                       		move.b	(a2)+,d1		; get Y-pos from mapping
00003ADC D268 000C                  		add.w	$C(a0),d1		; add Y-pos from object
00003AE0 32C1                       		move.w	d1,(a1)+		; move Y-pos
00003AE2 7200                       		moveq	#0,d1			; clear d1
00003AE4 12DA                       		move.b	(a2)+,(a1)+		; move size
00003AE6 1229 FFF8                  		move.b	-8(a1),d1		; get link from previous sprite
00003AEA 5201                       		add.b	#1,d1			; increment link
00003AEC 12C1                       		move.b	d1,(a1)+		; move link
00003AEE 121A                       		move.b	(a2)+,d1		; get art pointer from mapping
00003AF0 E149                       		lsl.w	#8,d1			; I hate Sega Genesis for his unable
00003AF2 121A                       		move.b	(a2)+,d1		; to read/write a words from non-odd address
00003AF4 D268 0002                  		add.w	2(a0),d1		; add art pointer from object to d1
00003AF8 32C1                       		move.w	d1,(a1)+		; move art pointer
00003AFA 7200                       		moveq	#0,d1			; clear d1
00003AFC 121A                       		move.b	(a2)+,d1		; get X-pos from mapping
00003AFE D268 0008                  		add.w	$8(a0),d1		; add X-pos from object
00003B02 32C1                       		move.w	d1,(a1)+		; move X-pos
00003B04 51C8 FFD2                  		dbf		d0,@loop		; loop
00003B08 4E75                       		rts						; return
00003B0A                            		
00003B0A                            		
00003B0A                            SpeedToPos:
00003B0A 2428 0008                  		move.l	8(a0),d2
00003B0E 2628 000C                  		move.l	$C(a0),d3
00003B12 3028 0010                  		move.w	$10(a0),d0	; load horizontal speed
00003B16 48C0                       		ext.l	d0
00003B18 E180                       		asl.l	#8,d0		; multiply speed by $100
00003B1A D480                       		add.l	d0,d2		; add to x-axis	position
00003B1C 3028 0012                  		move.w	$12(a0),d0	; load vertical	speed
00003B20 48C0                       		ext.l	d0
00003B22 E180                       		asl.l	#8,d0		; multiply speed by $100
00003B24 D680                       		add.l	d0,d3		; add to y-axis	position
00003B26 2142 0008                  		move.l	d2,8(a0)	; update x-axis	position
00003B2A 2143 000C                  		move.l	d3,$C(a0)	; update y-axis	position
00003B2E 4E75                       		rts	
00003B30                            ; =====================================================================
00003B30                            ; ClearSprites - procedure for clear sprites
00003B30                            ; Arguments:	none
00003B30                            ; Return:		none
00003B30                            ; =====================================================================
00003B30                            ClearSprites:
00003B30 41F8 F800                  		lea		$FFFFF800,a0
00003B34 704F                       		move.l	#79,d0
00003B36 20FC 0000 0000             @loop:	move.l	#0,(a0)+
00003B3C 20FC 0000 0000             		move.l	#0,(a0)+
00003B42 51C8 FFF2                  		dbf		d0,@loop
00003B46 4E75                       		rts
00003B48                            		
00003B48                            ; =====================================================================
00003B48                            ; AnimateSprite - function for animate sprite
00003B48                            ; Arguments:	$11(a0) - number of animation
00003B48                            ;				$12(a0) - offset of animation
00003B48                            ;				$16(a0) - status of animation
00003B48                            ;				$17(a0) - value of animation timer
00003B48                            ;				$18(a0) - setup of animation timer
00003B48                            ;				$19(a0) - current byte of animation
00003B48                            ; Return:		$10(a0) - new frame
00003B48                            ;				$16(a0) - new status of animation
00003B48                            ;				$17(a0) - value of animation timer
00003B48                            ; =====================================================================
00003B48                            AnimateSprite:
00003B48 0C28 0001 0016             		cmp.b	#1,$16(a0)		; animation is stopped?
00003B4E 6600                       		bne.s	@check_load		; if not, check load
00003B50 4E75                       		rts						; if yes, GTFO
00003B52                            		
00003B52                            @check_load:
00003B52 0C28 0002 0016             		cmp.b	#2,$16(a0)		; need to load new animation?
00003B58 6600                       		bne.s	@check_timer	; if not, check timer
00003B5A 117C 0000 0019             		move.b	#0,$19(a0)		; set first byte of animation
00003B60 2268 0012                  		movea.l	$12(a0),a1		; load animation to a1
00003B64 7000                       		moveq	#0,d0			; clear	d0
00003B66 1028 0011                  		move.b	$11(a0),d0		; get animation number
00003B6A D040                       		add.w	d0,d0			; double it!
00003B6C D2F1 0000                  		adda.w	(a1,d0.w),a1	; get animation
00003B70 1151 0018                  		move.b	(a1),$18(a0)	; set new setup of timer
00003B74 4EF9 0000 0000             		jmp		@change_frame	; get a frame
00003B7A                            		
00003B7A                            @check_timer:
00003B7A 5328 0017                  		sub.b	#1,$17(a0)		; subtract 1 from timer
00003B7E 6700                       		beq.s	@change_frame	; if timer is over, change frame
00003B80 4E75                       		rts						; return
00003B82                            		
00003B82                            @change_frame:
00003B82 7000                       		moveq	#0,d0			; clear d0
00003B84 1028 0011                  		move.b	$11(a0),d0		; get number of animation
00003B88 D040                       		add.w	d0,d0			; multiple d0 to 2
00003B8A 2268 0012                  		movea.l	$12(a0),a1		; load animation to a1
00003B8E D2F1 0000                  		adda.w	(a1,d0.w),a1	; get animation
00003B92 5228 0019                  		add.b	#1,$19(a0)		; next byte of animation
00003B96 7000                       		moveq	#0,d0			; clear d0
00003B98 1028 0019                  		move.b	$19(a0),d0		; get number of byte
00003B9C D2C0                       		adda.w	d0,a1			; get this byte
00003B9E 4A11                       		tst.b	(a1)			; it's reserved bytes?
00003BA0 6B00                       		bmi.s	@commands		; if yes, branch
00003BA2 1151 0010                  		move.b	(a1),$10(a0)	; set new frame
00003BA6 1168 0018 0017             		move.b	$18(a0),$17(a0)	; set new timer value
00003BAC 117C 0000 0016             		move.b	#0,$16(a0)		; set normal status of animation
00003BB2 4E75                       		rts						; return
00003BB4                            		
00003BB4                            @commands:
00003BB4 0C11 00F0                  		cmp.b	#$F0,(a1)		; it's "end byte"?
00003BB8 6600                       		bne.s	@loop_byte		; if not, branch
00003BBA 117C 0001 0016             		move.b	#1,$16(a0)		; set stop status of animation
00003BC0 4E75                       		rts						; return
00003BC2                            		
00003BC2                            @loop_byte:
00003BC2 0C11 00F1                  		cmp.b	#$F1,(a1)		; it's "loop byte"?
00003BC6 6600                       		bne.s	@rts			; if not, branch
00003BC8 117C 0000 0019             		move.b	#0,$19(a0)		; set first byte
00003BCE 4EF8 3B82                  		jmp		@change_frame	; get new frame
00003BD2                            
00003BD2 4E75                       @rts	rts						; return
00003BD4                            
00003BD4                            @setup:
00003BD4                            		
00003BD4                            		
00003BD4                            ; =====================================================================
00003BD4                            		
00003BD4                            ObjectOffsets:
00003BD4 0000 0000                  		dc.l	Obj_Dino
00003BD8                            		
00003BD8                            ; =====================================================================
00003BD8                            ; Object Includes
00003BD8                            ; =====================================================================
00003BD8                            		include	_obj\Dino.asm
00003BD8                            ; ===========================================================================
00003BD8                            ; Object #01 - Dino
00003BD8                            ; Start position:
00003BD8                            ;	X - $96
00003BD8                            ;	Y - $130
00003BD8                            ; Additional Byte:
00003BD8                            ;	$20 - state
00003BD8                            ;		#0 - on ground
00003BD8                            ;		#1 - jumping
00003BD8                            ;		#2 - falling down
00003BD8                            ;	$21 - vertical speed
00003BD8                            ;	$22 - "control block" flag
00003BD8                            ; ===========================================================================
00003BD8 =00000009                  GRAVITY equ 9
00003BD8 =00000012                  MAX_HEIGHT equ 18
00003BD8                            
00003BD8                            Obj_Dino:
00003BD8 7000                       		moveq	#0,d0							; clear routine counter
00003BDA 1028 0001                  		move.b	1(a0),d0						; move current routine
00003BDE 303B 0000                  		move.w	Obj_Dino_Routines(pc,d0.w),d0	; get routine offset
00003BE2 4EFB 0000                  		jmp		Obj_Dino_Routines(pc,d0.w)		; jump to the routine
00003BE6                            ; ---------------------------------------------------------------------------
00003BE6                            Obj_Dino_Routines:
00003BE6 0000                       		dc.w	Obj_Dino_Main-Obj_Dino_Routines
00003BE8 0000                       		dc.w	Obj_Dino_Loop-Obj_Dino_Routines
00003BEA                            ; ---------------------------------------------------------------------------
00003BEA                            Obj_Dino_Main:
00003BEA 5428 0001                  		addq.b	#2,1(a0)			; next routine
00003BEE 317C 00F3 0002             		move.w	#243,2(a0)			; art pointer
00003BF4                            		;move.w	#$96,8(a0)			; X
00003BF4 317C 0130 000C             		move.w	#$130,$C(a0)		; Y
00003BFA 217C 0000 0000 0004        		move.l	#Dino_Map,4(a0)		; mapping
00003C02 217C 0000 0000 0012        		move.l	#Dino_Anim,$12(a0)	; animations
00003C0A 117C 0000 0011             		move.b	#0,$11(a0)			; set run animation
00003C10 117C 0002 0016             		move.b	#2,$16(a0)			; load animation
00003C16                            
00003C16                            Obj_Dino_Loop:
00003C16 4EB8 3B48                  		jsr		AnimateSprite
00003C1A 4EB9 0000 0000             		jsr		Obj_Dino_Control
00003C20 4EF8 3ABE                  		jmp		DisplaySprite	; display sprite
00003C24                            		
00003C24                            Obj_Dino_Control:
00003C24 4A28 0022                  		tst.b	$22(a0)
00003C28 6700                       		beq.s	@cont
00003C2A 4E75                       		rts
00003C2C                            		
00003C2C 7000                       @cont	moveq	#0,d0
00003C2E 1028 0020                  		move.b	$20(a0),d0
00003C32 303B 0000                  		move.w	Obj_Dino_Control_States(pc,d0.w),d0
00003C36 4EFB 0000                  		jmp		Obj_Dino_Control_States(pc,d0.w)
00003C3A                            ; ---------------------------------------------------------------------------
00003C3A                            Obj_Dino_Control_States:
00003C3A 0000                       		dc.w	Obj_Dino_Control_OnGround-Obj_Dino_Control_States
00003C3C 0000                       		dc.w	Obj_Dino_Control_Jumping-Obj_Dino_Control_States
00003C3E 0000                       		dc.w	Obj_Dino_Control_Falling-Obj_Dino_Control_States
00003C40                            ; ---------------------------------------------------------------------------
00003C40                            Obj_Dino_Control_OnGround:
00003C40 0238 0070 F605             		andi.b	#A+B+C,Joypad|Press
00003C46 6700                       		beq.s	@rts
00003C48 5428 0020                  		addq.b	#2,$20(a0)
00003C4C 117C 0012 0021             		move.b	#MAX_HEIGHT,$21(a0)
00003C52 4E75                       @rts	rts
00003C54                            ; ---------------------------------------------------------------------------
00003C54                            Obj_Dino_Control_Jumping:
00003C54 7000                       		moveq	#0,d0
00003C56 1028 0021                  		move.b	$21(a0),d0
00003C5A 0C00 0009                  		cmp.b	#GRAVITY,d0
00003C5E 6F00                       		ble.s	@ok
00003C60 103C 0009                  		move.b	#GRAVITY,d0
00003C64 9168 000C                  @ok		sub.w	d0,$C(a0)
00003C68 1028 0021                  		move.b	$21(a0),d0
00003C6C 5300                       		subi.b	#1,d0
00003C6E 6600                       		bne.s	@still
00003C70 5428 0020                  		addq.b	#2,$20(a0)
00003C74 103C 0001                  		move.b	#1,d0
00003C78 1140 0021                  @still	move.b	d0,$21(a0)
00003C7C 4E75                       		rts
00003C7E                            ; ---------------------------------------------------------------------------
00003C7E                            Obj_Dino_Control_Falling:
00003C7E 7000                       		moveq	#0,d0
00003C80 1028 0021                  		move.b	$21(a0),d0
00003C84 0C00 0009                  		cmp.b	#GRAVITY,d0
00003C88 6F00                       		ble.s	@ok
00003C8A 103C 0009                  		move.b	#GRAVITY,d0
00003C8E D168 000C                  @ok		add.w	d0,$C(a0)
00003C92 1028 0021                  		move.b	$21(a0),d0
00003C96 5200                       		addi.b	#1,d0
00003C98 0C00 0013                  		cmp.b	#MAX_HEIGHT+1,d0
00003C9C 6600                       		bne.s	@still
00003C9E 117C 0000 0020             		move.b	#0,$20(a0)
00003CA4 103C 0000                  		move.b	#0,d0
00003CA8 1140 0021                  @still	move.b	d0,$21(a0)
00003CAC 4E75                       		rts
00003CAE                            		
00003CAE                            ; ---------------------------------------------------------------------------
00003CAE                            ; Dino - Graphics
00003CAE                            ; ---------------------------------------------------------------------------
00003CAE                            Dino_Art:
00003CAE                            		incbin	artunc\dino.bin
000042EE                            Dino_Pal:
000042EE                            		incbin	pallete\dino.pal
00004302                            Dino_Map:
00004302                            		include	_maps\Dino.asm
00004302                            ; --------------------------------------------------------------------------------
00004302                            ; Sprite mappings - output from SonMapEd - Sonic 1 format
00004302                            ; --------------------------------------------------------------------------------
00004302                            
00004302                            SME_mSBbv:	
00004302 0000 0000                  		dc.w SME_mSBbv_C-SME_mSBbv, SME_mSBbv_21-SME_mSBbv	
00004306 0000 0000                  		dc.w SME_mSBbv_3B-SME_mSBbv, SME_mSBbv_55-SME_mSBbv	
0000430A 0000 0000                  		dc.w SME_mSBbv_6A-SME_mSBbv, SME_mSBbv_7F-SME_mSBbv	
0000430E 04                         SME_mSBbv_C:	dc.b 4	
0000430F 0009 0000 10               		dc.b 0, 9, 0, 0, $10	
00004314 1009 0006 08               		dc.b $10, 9, 0, 6, 8	
00004319 0802 0010 00               		dc.b 8, 2, 0, $10, 0	
0000431E 2005 0013 08               		dc.b $20, 5, 0, $13, 8	
00004323 05                         SME_mSBbv_21:	dc.b 5	
00004324 0009 0000 10               		dc.b 0, 9, 0, 0, $10	
00004329 1009 0006 08               		dc.b $10, 9, 0, 6, 8	
0000432E 0802 0010 00               		dc.b 8, 2, 0, $10, 0	
00004333 2001 0013 08               		dc.b $20, 1, 0, $13, 8	
00004338 2000 0017 10               		dc.b $20, 0, 0, $17, $10	
0000433D 05                         SME_mSBbv_3B:	dc.b 5	
0000433E 0009 0000 10               		dc.b 0, 9, 0, 0, $10	
00004343 1009 0006 08               		dc.b $10, 9, 0, 6, 8	
00004348 0802 0010 00               		dc.b 8, 2, 0, $10, 0	
0000434D 2000 0018 08               		dc.b $20, 0, 0, $18, 8	
00004352 2001 0015 10               		dc.b $20, 1, 0, $15, $10	
00004357 04                         SME_mSBbv_55:	dc.b 4	
00004358 0009 001A 10               		dc.b 0, 9, 0, $1A, $10	
0000435D 1009 0006 08               		dc.b $10, 9, 0, 6, 8	
00004362 0802 0010 00               		dc.b 8, 2, 0, $10, 0	
00004367 2005 0013 08               		dc.b $20, 5, 0, $13, 8	
0000436C 04                         SME_mSBbv_6A:	dc.b 4	
0000436D 100D 0024 00               		dc.b $10, $D, 0, $24, 0	
00004372 1009 002C 20               		dc.b $10, 9, 0, $2C, $20	
00004377 2008 000C 08               		dc.b $20, 8, 0, $C, 8	
0000437C 2800 0019 10               		dc.b $28, 0, 0, $19, $10	
00004381 04                         SME_mSBbv_7F:	dc.b 4	
00004382 100D 0024 00               		dc.b $10, $D, 0, $24, 0	
00004387 1009 002C 20               		dc.b $10, 9, 0, $2C, $20	
0000438C 200C 0020 08               		dc.b $20, $C, 0, $20, 8	
00004391 2800 2819 08               		dc.b $28, 0, $28, $19, 8	
00004396                            		even
00004396                            		even
00004396                            Dino_Anim:
00004396                            		include	_anim\Dino.asm
00004396 0000                       		dc.w	Dino_Run-Dino_Anim
00004398 0000                       		dc.w	Dino_Static-Dino_Anim
0000439A 0000                       		dc.w	Dino_Dies-Dino_Anim
0000439C 0000                       		dc.w	Dino_Duck-Dino_Anim	; dino duck, ahahah
0000439E                            		
0000439E                            Dino_Run:
0000439E 0701 02F1                  		dc.b	7, 1, 2, $F1
000043A2                            		
000043A2                            Dino_Static:
000043A2 0200 F000                  		dc.b	2, 0, $F0, 0
000043A6                            		
000043A6                            Dino_Dies:
000043A6 0203 F000                  		dc.b	2, 3, $F0, 0
000043AA                            		
000043AA                            Dino_Duck:
000043AA 0704 05F1                  		dc.b	7, 4, 5, $F1
000043AA 0704 05F1                  		dc.b	7, 4, 5, $F1
000043AA 0704 05F1                  		dc.b	7, 4, 5, $F1
000043AA 0704 05F1                  		dc.b	7, 4, 5, $F1
000043AE                            ; ===========================================================================
000043AE                            ; Parallax Engine
000043AE                            ; ===========================================================================
000043AE                            		include "_proc\Parallax Engine.asm"
000043AE                            ; ===============================================================
000043AE                            ; ---------------------------------------------------------------
000043AE                            ; Vladikcomper's Parallax Engine
000043AE                            ; Version 0.50
000043AE                            ; ---------------------------------------------------------------
000043AE                            ; 2014, Vladikcomper
000043AE                            ; ---------------------------------------------------------------
000043AE                            
000043AE                            ; Variables
000043AE =FFFFCC00                  HScroll		equ	$FFFFCC00
000043AE =FFFFF700                  FG_XPos		equ	$FFFFF700
000043AE =FFFFFE04                  FrameCounter	equ	$FFFFFE04
000043AE                            
000043AE                            ; ---------------------------------------------------------------
000043AE                            ; Main routine that runs the script
000043AE                            ; ---------------------------------------------------------------
000043AE                            ; INPUT:
000043AE                            ;	a1	Script
000043AE                            ; ---------------------------------------------------------------
000043AE                            
000043AE                            ExecuteParallaxScript:
000043AE 41F8 CC00                  	lea	HScroll,a0
000043B2                            
000043B2 3038 F700                  	move	FG_XPos,d0			; d0 = BG Position
000043B6 4840                       	swap	d0
000043B8 4240                       	clr.w	d0
000043BA 7E00                       	moveq	#0,d7
000043BC                            	
000043BC                            @ProcessBlock:
000043BC 1E19                       	move.b	(a1)+,d7			; load scrolling mode for the current block in script
000043BE 6B00                       	bmi.s	@Return				; if end of list reached, branch
000043C0 3C3B 7000                  	move.w	@ParallaxRoutines(pc,d7),d6
000043C4 1E19                       	move.b	(a1)+,d7			; load scrolling mode parameter
000043C6 4EFB 6000                  	jmp	@ParallaxRoutines(pc,d6)
000043CA                            
000043CA                            @Return:
000043CA 4E75                       	rts
000043CC                            
000043CC                            ; ---------------------------------------------------------------
000043CC                            @ParallaxRoutines:
000043CC 0000                       	dc.w	@Parallax_Normal-@ParallaxRoutines
000043CE 0000                       	dc.w	@Parallax_Moving-@ParallaxRoutines  
000043D0 0000                       	dc.w	@Parallax_Linear-@ParallaxRoutines
000043D2                            
000043D2                            ; ---------------------------------------------------------------
000043D2                            ; Scrolling routine: Static solid block
000043D2                            ; ---------------------------------------------------------------
000043D2                            ; Input:
000043D2                            ;	d7	.w	$00PP, where PP is parameter
000043D2                            ;
000043D2                            ; Notice:
000043D2                            ;	Don't pollute the high byte of d7!
000043D2                            ;
000043D2                            ; ---------------------------------------------------------------
000043D2                            
000043D2                            @Parallax_Normal:
000043D2                            
000043D2                            	; Calculate positions
000043D2 2200                       	move.l	d0,d1				; d1 = X (16.16)
000043D4 4841                       	swap	d1				; d1 = X (Int)
000043D6 C2D9                       	mulu.w	(a1)+,d1			; d1 = X*Coef (24.8)
000043D8 E189                       	lsl.l	#8,d1				; d1 = X*Coef (16.16)
000043DA 3238 F700                  	move.w	FG_XPos,d1
000043DE 4441                       	neg.w	d1
000043E0 4841                       	swap	d1
000043E2 4441                       	neg.w	d1				; d1 = $00BB, where BB is -X*Coef
000043E4                            
000043E4                            	; Execute code according to number of lines set
000043E4 3C19                       	move.w	(a1)+,d6			; d6 = N, where N is Number of lines
000043E6 3A06                       	move.w	d6,d5				; d5 = N    
000043E8 EA4D                       	lsr.w	#5,d5				; d5 = N/32
000043EA 0246 001F                  	andi.w	#31,d6				; d6 = N%32
000043EE 4446                       	neg.w	d6				; d6 = -N%32
000043F0 0646 0020                  	add.w	#32,d6				; d6 = 32-N%32
000043F4 DC46                       	add.w	d6,d6
000043F6 4EFB 6000                  	jmp	@0(pc,d6)
000043FA                            
000043FA                            	; Main functional block (2 bytes per loop)
000043FA                            @0	rept	32
000043FA                            	move.l	d1,(a0)+
000043FA 20C1 20C1 20C1 20C1 20C1+  	endr
0000443A 51CD FFBE                  	dbf	d5,@0
0000443E                            
0000443E 4EF8 43BC                  	jmp	@ProcessBlock			; process next bloku!
00004442                            	
00004442                            ; ---------------------------------------------------------------
00004442                            ; Scrolling routine: Moving solid block
00004442                            ; ---------------------------------------------------------------
00004442                            ; Input:
00004442                            ;	d7	.w	$00PP, where PP is parameter
00004442                            ;
00004442                            ; Notice:
00004442                            ;	Don't pollute the high byte of d7!
00004442                            ;
00004442                            ; ---------------------------------------------------------------
00004442                            
00004442                            @Parallax_Moving:
00004442                            
00004442                            	; Calculate positions
00004442 2200                       	move.l	d0,d1				; d1 = X (16.16)
00004444 4841                       	swap	d1				; d1 = X (Int)
00004446 C2D9                       	mulu.w	(a1)+,d1			; d1 = X*Coef (24.8)
00004448 E189                       	lsl.l	#8,d1				; d1 = X*Coef (16.16)
0000444A 3238 F700                  	move.w	FG_XPos,d1
0000444E 4441                       	neg.w	d1
00004450 4841                       	swap	d1
00004452 4441                       	neg.w	d1				; d1 = $00BB, where BB is -X*Coef
00004454                            	
00004454                            	; Add frame factor
00004454 3638 FE04                  	move.w	FrameCounter,d3
00004458 EE6B                       	lsr.w	d7,d3
0000445A 9243                       	sub.w	d3,d1
0000445C                            
0000445C                            	; Execute code according to number of lines set
0000445C 3C19                       	move.w	(a1)+,d6			; d6 = N, where N is Number of lines
0000445E 3A06                       	move.w	d6,d5				; d5 = N    
00004460 EA4D                       	lsr.w	#5,d5				; d5 = N/32
00004462 0246 001F                  	andi.w	#31,d6				; d6 = N%32
00004466 4446                       	neg.w	d6				; d6 = -N%32
00004468 0646 0020                  	add.w	#32,d6				; d6 = 32-N%32
0000446C DC46                       	add.w	d6,d6
0000446E 4EFB 608A                  	jmp	@0(pc,d6)
00004472                            
00004472                            
00004472                            ; ---------------------------------------------------------------
00004472                            ; Scrolling routine: Linear Parallax / Psedo-surface
00004472                            ; ---------------------------------------------------------------
00004472                            ; Input:
00004472                            ;	d7	.w	$00PP, where PP is parameter
00004472                            ;
00004472                            ; Notice:
00004472                            ;	Don't pollute the high byte of d7!
00004472                            ;
00004472                            ; ---------------------------------------------------------------
00004472                            
00004472                            @Parallax_Linear:
00004472                            
00004472                            	; Calculate positions
00004472 2200                       	move.l	d0,d1				; d1 = X (16.16)
00004474 4841                       	swap	d1				; d1 = X (Int)
00004476 C2D9                       	mulu.w	(a1)+,d1			; d1 = X*Coef (24.8)
00004478 E189                       	lsl.l	#8,d1				; d1 = X*Coef (16.16)
0000447A 4481                       	neg.l	d1				; d1 = Initial position
0000447C 2401                       	move.l	d1,d2
0000447E EEA2                       	asr.l	d7,d2				; d2 = Linear factor
00004480                            
00004480 3638 F700                  	move.w	FG_XPos,d3
00004484 4443                       	neg.w	d3
00004486 4843                       	swap	d3
00004488                            
00004488                            	; Execute code according to number of lines set
00004488 3C19                       	move.w	(a1)+,d6			; d6 = N, where N is Number of lines
0000448A 3A06                       	move.w	d6,d5				; d5 = N    
0000448C E84D                       	lsr.w	#4,d5				; d5 = N/16
0000448E 0246 000F                  	andi.w	#15,d6				; d6 = N%16
00004492 4446                       	neg.w	d6				; d6 = -N%16
00004494 0646 0010                  	add.w	#16,d6				; d6 = 16-N%16
00004498 3806                       	move.w	d6,d4
0000449A DC46                       	add.w	d6,d6
0000449C DC46                       	add.w	d6,d6
0000449E DC44                       	add.w	d4,d6
000044A0 DC46                       	add.w	d6,d6
000044A2 4EFB 6000                  	jmp	@1(pc,d6)
000044A6                            
000044A6                            	; Main functional block (10 bytes per loop)
000044A6                            @1	rept	16
000044A6                            	swap	d1
000044A6                            	move.w	d1,d3
000044A6                            	move.l	d3,(a0)+
000044A6                            	swap	d1
000044A6                            	add.l	d2,d1
000044A6 4841 3601 20C3 4841 D282+  	endr
00004546 51CD FF5E                  	dbf	d5,@1
0000454A                            
0000454A 4EF8 43BC                  	jmp	@ProcessBlock			; process next bloku!
0000454E                            
0000454E                            
0000454E                            ; ===========================================================================
0000454E                            ; VBLANK
0000454E                            ; ===========================================================================
0000454E                            		include	"_proc\VBLANK.asm"
0000454E                            ; ===========================================================================
0000454E                            ; Subroutine that runs during Vertical Interruption
0000454E                            ; ===========================================================================
0000454E                            
0000454E                            ;loc_B10:
0000454E                            VBlank:					; XREF: Vectors
0000454E 48E7 FFFE                  		movem.l	d0-a6,-(sp)	; save all the registers to the stack
00004552 4A38 F62A                  		tst.b	($FFFFF62A).w	; is VBlank routine set to #0?
00004556 6700                       		beq.s	VBlank_Sub00	; if yes, branch
00004558 3039 00C0 0004             		move.w	($C00004).l,d0
0000455E 23FC 4000 0010 00C0 0004   		move.l	#$40000010,($C00004).l
00004568 23F8 F616 00C0 0000        		move.l	($FFFFF616).w,($C00000).l
00004570 0838 0006 FFF8             		btst	#6,($FFFFFFF8).w ; is Sega PAL (European)?
00004576 6700                       		beq.s	loc_B42		;  , 
00004578 303C 0700                  		move.w	#$700,d0
0000457C 51C8 FFFE                  		dbf	d0,*		; delay processor
00004580                            
00004580                            loc_B42:
00004580 1038 F62A                  		move.b	($FFFFF62A).w,d0 ; load VBlank routine number
00004584 11FC 0000 F62A             		move.b	#0,($FFFFF62A).w ; clear it
0000458A 31FC 0001 F644             		move.w	#1,($FFFFF644).w
00004590 0240 003E                  		andi.w	#$3E,d0
00004594 303B 0000                  		move.w	VBlank_Routines(pc,d0.w),d0
00004598 4EBB 0000                  		jsr	VBlank_Routines(pc,d0.w)
0000459C                            
0000459C                            loc_B5E:				; XREF: VBlank_Sub00
0000459C 4EB9 0000 0000             		jsr	UpdateMusic
000045A2                            
000045A2                            loc_B64:				; XREF: loc_D50
000045A2 52B8 FE0C                  		addq.l	#1,($FFFFFE0C).w
000045A6 4CDF 7FFF                  		movem.l	(sp)+,d0-a6	; load saved registers from the stack
000045AA 4E73                       		rte
000045AC                            
000045AC                            ; ===========================================================================
000045AC                            ;off_B6E:
000045AC                            VBlank_Routines:
000045AC 0000                       		dc.w VBlank_Sub00-VBlank_Routines ; $00
000045AE 0000                       		dc.w VBlank_Sub02-VBlank_Routines ; $02
000045B0 0000                       		dc.w VBlank_Sub04-VBlank_Routines ; $04
000045B2 0000                       		dc.w VBlank_Sub06-VBlank_Routines ; $06
000045B4 0000                       		dc.w VBlank_Sub08-VBlank_Routines ; $08
000045B6 0000                       		dc.w VBlank_Sub0A-VBlank_Routines ; $0A
000045B8 0000                       		dc.w VBlank_Sub0C-VBlank_Routines ; $0C
000045BA 0000                       		dc.w VBlank_Sub0E-VBlank_Routines ; $0E
000045BC 0000                       		dc.w VBlank_Sub10-VBlank_Routines ; $10
000045BE 0000                       		dc.w VBlank_Sub12-VBlank_Routines ; $12
000045C0 0000                       		dc.w VBlank_Sub14-VBlank_Routines ; $14
000045C2 0000                       		dc.w VBlank_Sub16-VBlank_Routines ; $16
000045C4 0000                       		dc.w VBlank_Sub0C-VBlank_Routines ; $18
000045C6                            ; ===========================================================================
000045C6                            
000045C6                            ;loc_B88:				; XREF: VBlank; VBlank_Routines
000045C6                            VBlank_Sub00:
000045C6 0C38 008C F600             		cmpi.b	#$8C,($FFFFF600).w	; is mode pre-Level?
000045CC 6700                       		beq.s	loc_B9A			; if yes, branch
000045CE 0C38 000C F600             		cmpi.b	#$C,($FFFFF600).w	; is mode Level?
000045D4 6600 FFC6                  		bne.w	loc_B5E			; if yes, branch
000045D8                            
000045D8                            loc_B9A:
000045D8 0C38 0001 FE10             		cmpi.b	#1,($FFFFFE10).w	; is level LZ ?
000045DE 6600 FFBC                  		bne.w	loc_B5E			;  , 
000045E2 3039 00C0 0004             		move.w	($C00004).l,d0
000045E8 0838 0006 FFF8             		btst	#6,($FFFFFFF8).w	; is Sega PAL (European)?
000045EE 6700                       		beq.s	loc_BBA			;  , 
000045F0 303C 0700                  		move.w	#$700,d0
000045F4 51C8 FFFE                  		dbf	d0,*			; delay processor
000045F8                            
000045F8                            loc_BBA:
000045F8 31FC 0001 F644             		move.w	#1,($FFFFF644).w	; enable HBlank
000045FE                            ;		move.w	#$100,($A11100).l
000045FE                            ;
000045FE                            ;loc_BC8:
000045FE                            ;		btst	#0,($A11100).l
000045FE                            ;		bne.s	loc_BC8
000045FE 4A38 F64E                  		tst.b	($FFFFF64E).w		; is water above top of screen?
00004602 6600                       		bne.s	loc_BFE			; if yes, branch
00004604 4BF9 00C0 0004             		lea	($C00004).l,a5
0000460A 2ABC 9400 9340             		move.l	#$94009340,(a5)
00004610 2ABC 96FD 9580             		move.l	#$96FD9580,(a5)
00004616 3ABC 977F                  		move.w	#$977F,(a5)
0000461A 3ABC C000                  		move.w	#$C000,(a5)
0000461E 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
00004624 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004628 6000                       		bra.s	loc_C22
0000462A                            ; ===========================================================================
0000462A                            
0000462A                            loc_BFE:				; XREF: loc_BC8
0000462A 4BF9 00C0 0004             		lea	($C00004).l,a5
00004630 2ABC 9400 9340             		move.l	#$94009340,(a5)
00004636 2ABC 96FD 9540             		move.l	#$96FD9540,(a5)
0000463C 3ABC 977F                  		move.w	#$977F,(a5)
00004640 3ABC C000                  		move.w	#$C000,(a5)
00004644 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
0000464A 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
0000464E                            
0000464E                            loc_C22:				; XREF: loc_BC8
0000464E 3AB8 F624                  		move.w	($FFFFF624).w,(a5)
00004652                            ;		move.w	#0,($A11100).l
00004652 6000 FF48                  		bra.w	loc_B5E
00004656                            ; ===========================================================================
00004656                            
00004656                            ;loc_C32:
00004656                            VBlank_Sub02:				; XREF: VBlank_Routines
00004656 6100 0000                  		bsr.w	sub_106E
0000465A                            
0000465A                            ;loc_F9A:
0000465A                            VBlank_Sub14:				; XREF: VBlank_Routines
0000465A 4A78 F614                  		tst.w	($FFFFF614).w
0000465E 6700 0000                  		beq.w	locret_C42
00004662 5378 F614                  		subq.w	#1,($FFFFF614).w
00004666                            
00004666                            locret_C42:
00004666 4E75                       		rts	
00004668                            ; ===========================================================================
00004668                            
00004668                            ;loc_C44:
00004668                            VBlank_Sub04:				; XREF: VBlank_Routines
00004668 6100 0000                  		bsr.w	sub_106E
0000466C 4A78 F614                  		tst.w	($FFFFF614).w		; is there time	left on	the demo?
00004670 6700 0000                  		beq.w	locret_C5C		; if time is over, branch
00004674 5378 F614                  		subq.w	#1,($FFFFF614).w	; subtract 1 from time left
00004678                            
00004678                            locret_C5C:
00004678 4E75                       		rts	
0000467A                            ; ===========================================================================
0000467A                            
0000467A                            ;loc_C5E:
0000467A                            VBlank_Sub06:				; XREF: VBlank_Routines
0000467A 6100 0000                  		bsr.w	sub_106E
0000467E 4E75                       		rts
00004680                            ; ===========================================================================
00004680                            
00004680                            ;loc_C64:
00004680                            VBlank_Sub10:				; XREF: VBlank_Routines
00004680 0C38 0010 F600             		cmpi.b	#$10,($FFFFF600).w ; is	game mode = $10	(special stage)	?
00004686 6700 0000                  		beq.w	VBlank_Sub0A		; if yes, branch
0000468A                            
0000468A                            ;loc_C5E:
0000468A                            VBlank_Sub08:				; XREF: VBlank_Routines
0000468A                            ;		move.w	#$100,($A11100).l ;  Z80
0000468A                            ;
0000468A                            ;loc_C76:
0000468A                            ;		btst	#0,($A11100).l	; has Z80 stopped?
0000468A                            ;		bne.s	loc_C76		;  , 
0000468A 6100 0000                  		bsr.w	ReadJoypads
0000468E 4A38 F64E                  		tst.b	($FFFFF64E).w
00004692 6600                       		bne.s	loc_CB0
00004694 4BF9 00C0 0004             		lea	($C00004).l,a5
0000469A 2ABC 9400 9340             		move.l	#$94009340,(a5)
000046A0 2ABC 96FD 9580             		move.l	#$96FD9580,(a5)
000046A6 3ABC 977F                  		move.w	#$977F,(a5)
000046AA 3ABC C000                  		move.w	#$C000,(a5)
000046AE 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
000046B4 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000046B8 6000                       		bra.s	loc_CD4
000046BA                            ; ===========================================================================
000046BA                            
000046BA                            loc_CB0:				; XREF: loc_C76
000046BA 4BF9 00C0 0004             		lea	($C00004).l,a5
000046C0 2ABC 9400 9340             		move.l	#$94009340,(a5)
000046C6 2ABC 96FD 9540             		move.l	#$96FD9540,(a5)
000046CC 3ABC 977F                  		move.w	#$977F,(a5)
000046D0 3ABC C000                  		move.w	#$C000,(a5)
000046D4 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
000046DA 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000046DE                            
000046DE                            loc_CD4:				; XREF: loc_C76
000046DE 3AB8 F624                  		move.w	($FFFFF624).w,(a5)
000046E2 4BF9 00C0 0004             		lea	($C00004).l,a5
000046E8 2ABC 9401 93C0             		move.l	#$940193C0,(a5)
000046EE 2ABC 96E6 9500             		move.l	#$96E69500,(a5)
000046F4 3ABC 977F                  		move.w	#$977F,(a5)
000046F8 3ABC 7C00                  		move.w	#$7C00,(a5)
000046FC 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
00004702 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004706 4BF9 00C0 0004             		lea	($C00004).l,a5
0000470C 2ABC 9401 9340             		move.l	#$94019340,(a5)
00004712 2ABC 96FC 9500             		move.l	#$96FC9500,(a5)
00004718 3ABC 977F                  		move.w	#$977F,(a5)
0000471C 3ABC 7800                  		move.w	#$7800,(a5)
00004720 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
00004726 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
0000472A 4EB9 0000 0000             		jsr	(ProcessDMAQueue).l
00004730                            
00004730                            loc_D50:
00004730 4CF8 00FF F700             		movem.l	($FFFFF700).w,d0-d7
00004736 48F8 00FF FF10             		movem.l	d0-d7,($FFFFFF10).w
0000473C 4CF8 0003 F754             		movem.l	($FFFFF754).w,d0-d1
00004742 48F8 0003 FF30             		movem.l	d0-d1,($FFFFFF30).w
00004748 11FC 0001 F64F             		move.b	#1,($FFFFF64F).w
0000474E 588F                       		addq.l	#4,sp
00004750 6000 FE50                  		bra.w	loc_B64
00004754                            
00004754                            VBlank_Sub0A:				; XREF: VBlank_Routines
00004754                            ;		move.w	#$100,($A11100).l ;  Z80
00004754                            ;
00004754                            ;loc_DAE:
00004754                            ;		btst	#0,($A11100).l	; has Z80 stopped?
00004754                            ;		bne.s	loc_DAE		;  , 
00004754 6100 0000                  		bsr.w	ReadJoypads
00004758 4BF9 00C0 0004             		lea	($C00004).l,a5
0000475E 2ABC 9400 9340             		move.l	#$94009340,(a5)
00004764 2ABC 96FD 9580             		move.l	#$96FD9580,(a5)
0000476A 3ABC 977F                  		move.w	#$977F,(a5)
0000476E 3ABC C000                  		move.w	#$C000,(a5)
00004772 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
00004778 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
0000477C 4BF9 00C0 0004             		lea	($C00004).l,a5
00004782 2ABC 9401 9340             		move.l	#$94019340,(a5)
00004788 2ABC 96FC 9500             		move.l	#$96FC9500,(a5)
0000478E 3ABC 977F                  		move.w	#$977F,(a5)
00004792 3ABC 7800                  		move.w	#$7800,(a5)
00004796 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
0000479C 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000047A0 4BF9 00C0 0004             		lea	($C00004).l,a5
000047A6 2ABC 9401 93C0             		move.l	#$940193C0,(a5)
000047AC 2ABC 96E6 9500             		move.l	#$96E69500,(a5)
000047B2 3ABC 977F                  		move.w	#$977F,(a5)
000047B6 3ABC 7C00                  		move.w	#$7C00,(a5)
000047BA 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
000047C0 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000047C4                            ;		move.w	#0,($A11100).l
000047C4 4EB9 0000 0000             		jsr	ProcessDMAQueue
000047CA                            
000047CA                            loc_E64:
000047CA 4A78 F614                  		tst.w	($FFFFF614).w
000047CE 6700 0000                  		beq.w	locret_E70
000047D2 5378 F614                  		subq.w	#1,($FFFFF614).w
000047D6                            
000047D6                            locret_E70:
000047D6 4E75                       		rts	
000047D8                            ; ===========================================================================
000047D8                            
000047D8                            ;loc_E72:
000047D8                            VBlank_Sub0C:				; XREF: VBlank_Routines
000047D8                            ;		move.w	#$100,($A11100).l ;  Z80
000047D8                            ;
000047D8                            ;loc_E7A:
000047D8                            ;		btst	#0,($A11100).l	; has Z80 stopped?
000047D8                            ;		bne.s	loc_E7A		;  , 
000047D8 6100 0000                  		bsr.w	ReadJoypads
000047DC 4A38 F64E                  		tst.b	($FFFFF64E).w
000047E0 6600                       		bne.s	loc_EB4
000047E2 4BF9 00C0 0004             		lea	($C00004).l,a5
000047E8 2ABC 9400 9340             		move.l	#$94009340,(a5)
000047EE 2ABC 96FD 9580             		move.l	#$96FD9580,(a5)
000047F4 3ABC 977F                  		move.w	#$977F,(a5)
000047F8 3ABC C000                  		move.w	#$C000,(a5)
000047FC 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
00004802 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004806 6000                       		bra.s	loc_ED8
00004808                            ; ===========================================================================
00004808                            
00004808                            loc_EB4:				; XREF: loc_E7A
00004808 4BF9 00C0 0004             		lea	($C00004).l,a5
0000480E 2ABC 9400 9340             		move.l	#$94009340,(a5)
00004814 2ABC 96FD 9540             		move.l	#$96FD9540,(a5)
0000481A 3ABC 977F                  		move.w	#$977F,(a5)
0000481E 3ABC C000                  		move.w	#$C000,(a5)
00004822 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
00004828 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
0000482C                            
0000482C                            loc_ED8:				; XREF: loc_E7A
0000482C 3AB8 F624                  		move.w	($FFFFF624).w,(a5)
00004830 4BF9 00C0 0004             		lea	($C00004).l,a5
00004836 2ABC 9401 93C0             		move.l	#$940193C0,(a5)
0000483C 2ABC 96E6 9500             		move.l	#$96E69500,(a5)
00004842                            
00004842                            loc_EEE:
00004842 3ABC 977F                  		move.w	#$977F,(a5)
00004846 3ABC 7C00                  		move.w	#$7C00,(a5)
0000484A 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
00004850 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004854 4BF9 00C0 0004             		lea	($C00004).l,a5
0000485A 2ABC 9401 9340             		move.l	#$94019340,(a5)
00004860 2ABC 96FC 9500             		move.l	#$96FC9500,(a5)
00004866 3ABC 977F                  		move.w	#$977F,(a5)
0000486A 3ABC 7800                  		move.w	#$7800,(a5)
0000486E 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
00004874 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004878 4EB9 0000 0000             		jsr	ProcessDMAQueue
0000487E                            
0000487E                            loc_F54:
0000487E                            ;		move.w	#0,($A11100).l	;  Z80
0000487E 4CF8 00FF F700             		movem.l	($FFFFF700).w,d0-d7
00004884 48F8 00FF FF10             		movem.l	d0-d7,($FFFFFF10).w
0000488A 4CF8 0003 F754             		movem.l	($FFFFF754).w,d0-d1
00004890 48F8 0003 FF30             		movem.l	d0-d1,($FFFFFF30).w
00004896 4E75                       		rts	
00004898                            ; ===========================================================================
00004898                            
00004898                            ;loc_F8A:
00004898                            VBlank_Sub0E:				; XREF: VBlank_Routines
00004898 6100 0000                  		bsr.w	sub_106E
0000489C 5238 F628                  		addq.b	#1,($FFFFF628).w
000048A0 11FC 000E F62A             		move.b	#$E,($FFFFF62A).w
000048A6 4E75                       		rts	
000048A8                            ; ===========================================================================
000048A8                            
000048A8                            ;loc_F9A:
000048A8                            VBlank_Sub12:				; XREF: VBlank_Routines
000048A8 6100 0000                  		bsr.w	sub_106E
000048AC 3AB8 F624                  		move.w	($FFFFF624).w,(a5)
000048B0                            ; ===========================================================================
000048B0                            
000048B0                            ;loc_F9A:
000048B0                            VBlank_Sub16:				; XREF: VBlank_Routines
000048B0                            ;		move.w	#$100,($A11100).l ;  Z80
000048B0                            ;
000048B0                            ;loc_FAE:
000048B0                            ;		btst	#0,($A11100).l	; has Z80 stopped?
000048B0                            ;		bne.s	loc_FAE		;  , 
000048B0 6100 0000                  		bsr.w	ReadJoypads
000048B4 4BF9 00C0 0004             		lea	($C00004).l,a5
000048BA 2ABC 9400 9340             		move.l	#$94009340,(a5)
000048C0 2ABC 96FD 9580             		move.l	#$96FD9580,(a5)
000048C6 3ABC 977F                  		move.w	#$977F,(a5)
000048CA 3ABC C000                  		move.w	#$C000,(a5)
000048CE 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
000048D4 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000048D8 4BF9 00C0 0004             		lea	($C00004).l,a5
000048DE 2ABC 9401 9340             		move.l	#$94019340,(a5)
000048E4 2ABC 96FC 9500             		move.l	#$96FC9500,(a5)
000048EA 3ABC 977F                  		move.w	#$977F,(a5)
000048EE 3ABC 7800                  		move.w	#$7800,(a5)
000048F2 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
000048F8 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000048FC 4BF9 00C0 0004             		lea	($C00004).l,a5
00004902 2ABC 9401 93C0             		move.l	#$940193C0,(a5)
00004908 2ABC 96E6 9500             		move.l	#$96E69500,(a5)
0000490E 3ABC 977F                  		move.w	#$977F,(a5)
00004912 3ABC 7C00                  		move.w	#$7C00,(a5)
00004916 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
0000491C 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004920                            ;		move.w	#0,($A11100).l	;  Z80
00004920 4EB9 0000 0000             		jsr	ProcessDMAQueue
00004926                            
00004926                            loc_1060:
00004926 4A78 F614                  		tst.w	($FFFFF614).w
0000492A 6700 0000                  		beq.w	locret_106C
0000492E 5378 F614                  		subq.w	#1,($FFFFF614).w
00004932                            
00004932                            locret_106C:
00004932 4E75                       		rts	
00004934                            
00004934                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004934                            
00004934                            
00004934                            sub_106E:				; XREF: VBlank_Sub02; et al
00004934                            ;		move.w	#$100,($A11100).l ;  Z80
00004934                            ;
00004934                            ;loc_1076:
00004934                            ;		btst	#0,($A11100).l	; has Z80 stopped?
00004934                            ;		bne.s	loc_1076	;  , 
00004934 6100 0000                  		bsr.w	ReadJoypads
00004938 4A38 F64E                  		tst.b	($FFFFF64E).w
0000493C 6600                       		bne.s	loc_10B0
0000493E 4BF9 00C0 0004             		lea	($C00004).l,a5
00004944 2ABC 9400 9340             		move.l	#$94009340,(a5)
0000494A 2ABC 96FD 9580             		move.l	#$96FD9580,(a5)
00004950 3ABC 977F                  		move.w	#$977F,(a5)
00004954 3ABC C000                  		move.w	#$C000,(a5)
00004958 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
0000495E 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004962 6000                       		bra.s	loc_10D4
00004964                            ; ===========================================================================
00004964                            
00004964                            loc_10B0:				; XREF: sub_106E
00004964 4BF9 00C0 0004             		lea	($C00004).l,a5
0000496A 2ABC 9400 9340             		move.l	#$94009340,(a5)
00004970 2ABC 96FD 9540             		move.l	#$96FD9540,(a5)
00004976 3ABC 977F                  		move.w	#$977F,(a5)
0000497A 3ABC C000                  		move.w	#$C000,(a5)
0000497E 31FC 0080 F640             		move.w	#$80,($FFFFF640).w
00004984 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
00004988                            
00004988                            loc_10D4:				; XREF: sub_106E
00004988 4BF9 00C0 0004             		lea	($C00004).l,a5
0000498E 2ABC 9401 9340             		move.l	#$94019340,(a5)
00004994 2ABC 96FC 9500             		move.l	#$96FC9500,(a5)
0000499A 3ABC 977F                  		move.w	#$977F,(a5)
0000499E 3ABC 7800                  		move.w	#$7800,(a5)
000049A2 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
000049A8 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000049AC 4BF9 00C0 0004             		lea	($C00004).l,a5
000049B2 2ABC 9401 93C0             		move.l	#$940193C0,(a5)
000049B8 2ABC 96E6 9500             		move.l	#$96E69500,(a5)
000049BE 3ABC 977F                  		move.w	#$977F,(a5)
000049C2 3ABC 7C00                  		move.w	#$7C00,(a5)
000049C6 31FC 0083 F640             		move.w	#$83,($FFFFF640).w
000049CC 3AB8 F640                  		move.w	($FFFFF640).w,(a5)
000049D0                            ;		move.w	#0,($A11100).l	;  Z80
000049D0 4E75                       		rts
000049D2                            ; End of function sub_106E
000049D2                            ; End of function sub_106E
000049D2                            
000049D2                            ; ===========================================================================
000049D2                            ; HBLANK
000049D2                            ; ===========================================================================
000049D2                            		include	"_proc\HBLANK.asm"
000049D2                            ; ---------------------------------------------------------------------------
000049D2                            ; Subroutine which runs during Horizontal Interruption
000049D2                            ; Moves pallets from the RAM to CRAM
000049D2                            ; ---------------------------------------------------------------------------
000049D2                            
000049D2                            ;PalToCRAM:
000049D2                            HBlank:
000049D2 46FC 2700                  		move	#$2700,sr	;  
000049D6 4A78 F644                  		tst.w	($FFFFF644).w	; was the pallete set to change?
000049DA 6700                       		beq.s	HBlank_Rts	;  , 
000049DC 31FC 0000 F644             		move.w	#0,($FFFFF644).w
000049E2 48E7 00C0                  		movem.l	a0-a1,-(sp)	; move registers to the stack
000049E6 43F9 00C0 0000             		lea	($C00000).l,a1
000049EC 41F8 FA80                  		lea	($FFFFFA80).w,a0 ; load	pallet from RAM
000049F0 237C C000 0000 0004        		move.l	#$C0000000,4(a1) ;  VDP    CRAM
000049F8 2298                       		move.l	(a0)+,(a1)	; move pallet to CRAM
000049FA 2298                       		move.l	(a0)+,(a1)
000049FC 2298                       		move.l	(a0)+,(a1)
000049FE 2298                       		move.l	(a0)+,(a1)
00004A00 2298                       		move.l	(a0)+,(a1)
00004A02 2298                       		move.l	(a0)+,(a1)
00004A04 2298                       		move.l	(a0)+,(a1)
00004A06 2298                       		move.l	(a0)+,(a1)
00004A08 2298                       		move.l	(a0)+,(a1)
00004A0A 2298                       		move.l	(a0)+,(a1)
00004A0C 2298                       		move.l	(a0)+,(a1)
00004A0E 2298                       		move.l	(a0)+,(a1)
00004A10 2298                       		move.l	(a0)+,(a1)
00004A12 2298                       		move.l	(a0)+,(a1)
00004A14 2298                       		move.l	(a0)+,(a1)
00004A16 2298                       		move.l	(a0)+,(a1)
00004A18 2298                       		move.l	(a0)+,(a1)
00004A1A 2298                       		move.l	(a0)+,(a1)
00004A1C 2298                       		move.l	(a0)+,(a1)
00004A1E 2298                       		move.l	(a0)+,(a1)
00004A20 2298                       		move.l	(a0)+,(a1)
00004A22 2298                       		move.l	(a0)+,(a1)
00004A24 2298                       		move.l	(a0)+,(a1)
00004A26 2298                       		move.l	(a0)+,(a1)
00004A28 2298                       		move.l	(a0)+,(a1)
00004A2A 2298                       		move.l	(a0)+,(a1)
00004A2C 2298                       		move.l	(a0)+,(a1)
00004A2E 2298                       		move.l	(a0)+,(a1)
00004A30 2298                       		move.l	(a0)+,(a1)
00004A32 2298                       		move.l	(a0)+,(a1)
00004A34 2298                       		move.l	(a0)+,(a1)
00004A36 2298                       		move.l	(a0)+,(a1)
00004A38 337C 8ADF 0004             		move.w	#$8ADF,4(a1)
00004A3E 4CDF 0300                  		movem.l	(sp)+,a0-a1	; load saved registers from the stack
00004A42 4A38 F64F                  		tst.b	($FFFFF64F).w
00004A46 6600                       		bne.s	loc_119E
00004A48                            
00004A48                            HBlank_Rts:
00004A48 4E73                       		rte
00004A4A                            ; ===========================================================================
00004A4A                            
00004A4A                            loc_119E:				; XREF: PalToCRAM
00004A4A 4238 F64F                  		clr.b	($FFFFF64F).w
00004A4E 48E7 FFFE                  		movem.l	d0-a6,-(sp)	; move all the registers to the stack
00004A52 4EB9 0000 0000             		jsr	UpdateMusic
00004A58 4CDF 7FFF                  		movem.l	(sp)+,d0-a6	; load saved registers from the stack
00004A5C 4E73                       		rte	
00004A5E                            ; End of function PalToCRAM
00004A5E                            ; End of function PalToCRAM
00004A5E                            
00004A5E                            ; ===========================================================================
00004A5E                            ; VDP procedures
00004A5E                            ; ===========================================================================
00004A5E                            		include	"_proc\VDP procedures.asm"
00004A5E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004A5E                            
00004A5E                            
00004A5E                            VDPSetupGame:				; XREF: GameClrRAM; ChecksumError
00004A5E 41F9 00C0 0004             		lea	($C00004).l,a0
00004A64 43F9 00C0 0000             		lea	($C00000).l,a1
00004A6A 45F9 0000 0000             		lea	(VDPSetupArray).l,a2
00004A70 7E12                       		moveq	#$12,d7
00004A72                            
00004A72                            VDP_Loop:
00004A72 309A                       		move.w	(a2)+,(a0)
00004A74 51CF FFFC                  		dbf	d7,VDP_Loop	; set the VDP registers
00004A78                            
00004A78 3039 0000 0000             		move.w	(VDPSetupArray+2).l,d0
00004A7E 31C0 F60C                  		move.w	d0,($FFFFF60C).w
00004A82 31FC 8ADF F624             		move.w	#$8ADF,($FFFFF624).w
00004A88 7000                       		moveq	#0,d0
00004A8A 23FC C000 0000 00C0 0004   		move.l	#$C0000000,($C00004).l ;  VDP    CRAM
00004A94 3E3C 003F                  		move.w	#$3F,d7
00004A98                            
00004A98                            VDP_ClrCRAM:
00004A98 3280                       		move.w	d0,(a1)
00004A9A 51CF FFFC                  		dbf	d7,VDP_ClrCRAM	;  CRAM
00004A9E                            
00004A9E 42B8 F616                  		clr.l	($FFFFF616).w
00004AA2 42B8 F61A                  		clr.l	($FFFFF61A).w
00004AA6 2F01                       		move.l	d1,-(sp)
00004AA8 4BF9 00C0 0004             		lea	($C00004).l,a5
00004AAE 3ABC 8F01                  		move.w	#$8F01,(a5)
00004AB2 2ABC 94FF 93FF             		move.l	#$94FF93FF,(a5)
00004AB8 3ABC 9780                  		move.w	#$9780,(a5)
00004ABC 2ABC 4000 0080             		move.l	#$40000080,(a5)
00004AC2 33FC 0000 00C0 0000        		move.w	#0,($C00000).l	;  
00004ACA                            
00004ACA                            loc_128E:
00004ACA 3215                       		move.w	(a5),d1
00004ACC 0801 0001                  		btst	#1,d1
00004AD0 66F8                       		bne.s	loc_128E
00004AD2                            
00004AD2 3ABC 8F02                  		move.w	#$8F02,(a5)
00004AD6 221F                       		move.l	(sp)+,d1
00004AD8 4E75                       		rts	
00004ADA                            ; End of function VDPSetupGame
00004ADA                            
00004ADA                            ; ===========================================================================
00004ADA 8004 8134 8230 8328        VDPSetupArray:	dc.w $8004, $8134, $8230, $8328	; XREF: VDPSetupGame
00004AE2 8407 857C 8600 8700        		dc.w $8407, $857C, $8600, $8700
00004AEA 8800 8900 8A00 8B00        		dc.w $8800, $8900, $8A00, $8B00
00004AF2 8C81 8D3F 8E00 8F02        		dc.w $8C81, $8D3F, $8E00, $8F02
00004AFA 9001 9100 9200             		dc.w $9001, $9100, $9200
00004B00                            
00004B00                            ; ---------------------------------------------------------------------------
00004B00                            ; Subroutine to	clear the screen
00004B00                            ; ---------------------------------------------------------------------------
00004B00                            
00004B00                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004B00                            
00004B00                            
00004B00                            ClearScreen:
00004B00 4BF9 00C0 0004             		lea	($C00004).l,a5
00004B06 3ABC 8F01                  		move.w	#$8F01,(a5)
00004B0A 2ABC 940F 93FF             		move.l	#$940F93FF,(a5)
00004B10 3ABC 9780                  		move.w	#$9780,(a5)
00004B14 2ABC 4000 0083             		move.l	#$40000083,(a5)
00004B1A 33FC 0000 00C0 0000        		move.w	#0,($C00000).l
00004B22                            
00004B22                            loc_12E6:
00004B22 3215                       		move.w	(a5),d1
00004B24 0801 0001                  		btst	#1,d1
00004B28 66F8                       		bne.s	loc_12E6
00004B2A                            
00004B2A 3ABC 8F02                  		move.w	#$8F02,(a5)
00004B2E 4BF9 00C0 0004             		lea	($C00004).l,a5
00004B34 3ABC 8F01                  		move.w	#$8F01,(a5)
00004B38 2ABC 940F 93FF             		move.l	#$940F93FF,(a5)
00004B3E 3ABC 9780                  		move.w	#$9780,(a5)
00004B42 2ABC 6000 0083             		move.l	#$60000083,(a5)
00004B48 33FC 0000 00C0 0000        		move.w	#0,($C00000).l
00004B50                            
00004B50                            loc_1314:
00004B50 3215                       		move.w	(a5),d1
00004B52 0801 0001                  		btst	#1,d1
00004B56 66F8                       		bne.s	loc_1314
00004B58                            
00004B58 3ABC 8F02                  		move.w	#$8F02,(a5)
00004B5C 21FC 0000 0000 F616        		move.l	#0,($FFFFF616).w
00004B64 21FC 0000 0000 F61A        		move.l	#0,($FFFFF61A).w
00004B6C 43F8 F800                  		lea	($FFFFF800).w,a1
00004B70 7000                       		moveq	#0,d0
00004B72 323C 00A0                  		move.w	#$A0,d1
00004B76                            
00004B76                            loc_133A:
00004B76 22C0                       		move.l	d0,(a1)+
00004B78 51C9 FFFC                  		dbf	d1,loc_133A
00004B7C                            
00004B7C 43F8 CC00                  		lea	($FFFFCC00).w,a1
00004B80 7000                       		moveq	#0,d0
00004B82 323C 0100                  		move.w	#$100,d1
00004B86                            
00004B86                            loc_134A:
00004B86 22C0                       		move.l	d0,(a1)+
00004B88 51C9 FFFC                  		dbf	d1,loc_134A
00004B8C 4E75                       		rts	
00004B8E                            ; End of function ClearScreen
00004B8E                            
00004B8E                            ; ---------------------------------------------------------------------------
00004B8E                            ; Subroutine to	display	patterns via the VDP
00004B8E                            ; ---------------------------------------------------------------------------
00004B8E                            
00004B8E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004B8E                            
00004B8E                            
00004B8E                            ShowVDPGraphics:			; XREF: SegaScreen; TitleScreen; SS_BGLoad
00004B8E 4DF9 00C0 0000             		lea	($C00000).l,a6
00004B94 283C 0080 0000             		move.l	#$800000,d4
00004B9A                            ;loc_142C:
00004B9A                            VDPGfx_Loop:
00004B9A 2D40 0004                  		move.l	d0,4(a6)	; set VDP access
00004B9E 3601                       		move.w	d1,d3		; load cols counter to d3
00004BA0                            ;loc_1432:
00004BA0                            VDPGfx_Char:
00004BA0 3C99                       		move.w	(a1)+,(a6)	; move plane mappings to VRAM
00004BA2 51CB FFFC                  		dbf	d3,VDPGfx_Char	; repeat for the amount of cols
00004BA6                            
00004BA6 D084                       		add.l	d4,d0		; switch to the next screen row
00004BA8 51CA FFF0                          dbf	d2,VDPGfx_Loop	; repeat for the amount of rows
00004BAC 4E75                       		rts
00004BAE                            ; End of function ShowVDPGraphics
00004BAE                            ; End of function ShowVDPGraphics
00004BAE                            
00004BAE                            ; ===========================================================================
00004BAE                            ; DMA procedures
00004BAE                            ; ===========================================================================
00004BAE                            		include	"_proc\DMA procedures.asm"
00004BAE                            
00004BAE                            ; ---------------------------------------------------------------------------
00004BAE                            ; Subroutine for queueing VDP commands (seems to only queue transfers to VRAM),
00004BAE                            ; to be issued the next time ProcessDMAQueue is called.
00004BAE                            ; Can be called a maximum of 18 times before the buffer needs to be cleared
00004BAE                            ; by issuing the commands (this subroutine DOES check for overflow)
00004BAE                            ; ---------------------------------------------------------------------------
00004BAE                             
00004BAE                            ; ||||||||||||||| S U B R O U T I N E |||||||||||||||||||||||||||||||||||||||
00004BAE                            
00004BAE                            QueueDMATransfer:
00004BAE 2278 C8FC                  		movea.l	($FFFFC8FC).w,a1
00004BB2 B2FC C8FC                  		cmpa.w	#$C8FC,a1
00004BB6 6700                       		beq.s	QueueDMATransfer_Done ; return if there's no more room in the buffer
00004BB8                             
00004BB8 303C 9300                  		move.w	#$9300,d0 ; command to specify DMA transfer length & $00FF
00004BBC 1003                       		move.b	d3,d0
00004BBE 32C0                       		move.w	d0,(a1)+ ; store command
00004BC0                             
00004BC0 303C 9400                  		move.w	#$9400,d0 ; command to specify DMA transfer length & $FF00
00004BC4 E04B                       		lsr.w	#8,d3
00004BC6 1003                       		move.b	d3,d0
00004BC8 32C0                       		move.w	d0,(a1)+ ; store command
00004BCA                             
00004BCA 303C 9500                  		move.w	#$9500,d0 ; command to specify source address & $0001FE
00004BCE E289                       		lsr.l	#1,d1
00004BD0 1001                       		move.b	d1,d0
00004BD2 32C0                       		move.w	d0,(a1)+ ; store command
00004BD4                             
00004BD4 303C 9600                  		move.w	#$9600,d0 ; command to specify source address & $01FE00
00004BD8 E089                       		lsr.l	#8,d1
00004BDA 1001                       		move.b	d1,d0
00004BDC 32C0                       		move.w	d0,(a1)+ ; store command
00004BDE                             
00004BDE 303C 9700                  		move.w	#$9700,d0 ; command to specify source address & $FE0000
00004BE2 E089                       		lsr.l	#8,d1
00004BE4 1001                       		move.b	d1,d0
00004BE6 32C0                       		move.w	d0,(a1)+ ; store command
00004BE8                             
00004BE8 0282 0000 FFFF             		andi.l	#$FFFF,d2 ; command to specify destination address and begin DMA
00004BEE E58A                       		lsl.l	#2,d2
00004BF0 E44A                       		lsr.w	#2,d2
00004BF2 4842                       		swap	d2
00004BF4 0082 4000 0080             		ori.l	#$40000080,d2 ; set bits to specify VRAM transfer
00004BFA 22C2                       		move.l	d2,(a1)+ ; store command
00004BFC                             
00004BFC 21C9 C8FC                  		move.l	a1,($FFFFC8FC).w ; set the next free slot address
00004C00 B2FC C8FC                  		cmpa.w	#$C8FC,a1
00004C04 6700                       		beq.s	QueueDMATransfer_Done ; return if there's no more room in the buffer
00004C06 32BC 0000                  		move.w	#0,(a1) ; put a stop token at the end of the used part of the buffer
00004C0A                            
00004C0A                            QueueDMATransfer_Done:
00004C0A 4E75                       		rts
00004C0C                            ; End of function QueueDMATransfer
00004C0C                             
00004C0C                             
00004C0C                            ; ---------------------------------------------------------------------------
00004C0C                            ; Subroutine for issuing all VDP commands that were queued
00004C0C                            ; ---------------------------------------------------------------------------
00004C0C                             
00004C0C                            ; ||||||||||||||| S U B R O U T I N E |||||||||||||||||||||||||||||||||||||||
00004C0C                            
00004C0C                            ProcessDMAQueue:
00004C0C 4BF9 00C0 0004             		lea	($C00004).l,a5
00004C12 43F8 C800                  		lea	($FFFFC800).w,a1
00004C16                            
00004C16                            ProcessDMAQueue_Loop:
00004C16 3019                       		move.w	(a1)+,d0
00004C18 6700                       		beq.s	ProcessDMAQueue_Done ; branch if we reached a stop token
00004C1A 3A80                       		move.w	d0,(a5)		; transfer length
00004C1C 3A99                       		move.w	(a1)+,(a5)	; transfer length
00004C1E 3A99                       		move.w	(a1)+,(a5)	; source address
00004C20 3A99                       		move.w	(a1)+,(a5)	; source address
00004C22 3A99                       		move.w	(a1)+,(a5)	; source address
00004C24 3A99                       		move.w	(a1)+,(a5)	; destination
00004C26 3A99                       		move.w	(a1)+,(a5)	; destination
00004C28 B2FC C8FC                  		cmpa.w	#$C8FC,a1
00004C2C 66E8                       		bne.s	ProcessDMAQueue_Loop ; loop if we haven't reached the end of the buffer
00004C2E                            
00004C2E                            ProcessDMAQueue_Done:
00004C2E 31FC 0000 C800             		move.w	#0,($FFFFC800).w
00004C34 21FC FFFF C800 C8FC        		move.l	#$FFFFC800,($FFFFC8FC).w
00004C3C 4E75                       		rts
00004C3E                            ; End of function ProcessDMAQueue
00004C3E                            ; End of function ProcessDMAQueue
00004C3E                            
00004C3E                            ; ===========================================================================
00004C3E                            ; Nemesis decompression	algorithm
00004C3E                            ; ===========================================================================
00004C3E                            		include	"_proc\Nemesis Decompression.asm"
00004C3E                            ; ---------------------------------------------------------------------------
00004C3E                            ; Nemesis decompression	algorithm
00004C3E                            ; ---------------------------------------------------------------------------
00004C3E                            
00004C3E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004C3E                            
00004C3E                            
00004C3E                            NemDec:
00004C3E 48E7 FFDC                  		movem.l	d0-a1/a3-a5,-(sp)	; save registers to the stack
00004C42 47F9 0000 0000             		lea	(loc_1502).l,a3
00004C48 49F9 00C0 0000             		lea	($C00000).l,a4
00004C4E 6000                       		bra.s	loc_145C
00004C50                            ; ===========================================================================
00004C50 48E7 FFDC                  		movem.l	d0-a1/a3-a5,-(sp)	; save registers to the stack
00004C54 47F9 0000 0000             		lea	(loc_1518).l,a3
00004C5A                            
00004C5A                            loc_145C:				; XREF: NemDec
00004C5A 43F8 AA00                  		lea	($FFFFAA00).w,a1
00004C5E 3418                       		move.w	(a0)+,d2
00004C60 E34A                       		lsl.w	#1,d2
00004C62 6400                       		bcc.s	loc_146A
00004C64 D6FC 000A                  		adda.w	#$A,a3
00004C68                            
00004C68                            loc_146A:
00004C68 E54A                       		lsl.w	#2,d2
00004C6A 3A42                       		movea.w	d2,a5
00004C6C 7608                       		moveq	#8,d3
00004C6E 7400                       		moveq	#0,d2
00004C70 7800                       		moveq	#0,d4
00004C72 6100 0000                  		bsr.w	NemDec4
00004C76 1A18                       		move.b	(a0)+,d5
00004C78 E145                       		asl.w	#8,d5
00004C7A 1A18                       		move.b	(a0)+,d5
00004C7C 3C3C 0010                  		move.w	#$10,d6
00004C80 6100                       		bsr.s	NemDec2
00004C82 4CDF 3BFF                  		movem.l	(sp)+,d0-a1/a3-a5	; load saved registers
00004C86 4E75                       		rts	
00004C88                            ; End of function NemDec
00004C88                            
00004C88                            
00004C88                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004C88                            
00004C88                            
00004C88                            NemDec2:				; XREF: NemDec
00004C88 3E06                       		move.w	d6,d7
00004C8A 5147                       		subq.w	#8,d7
00004C8C 3205                       		move.w	d5,d1
00004C8E EE69                       		lsr.w	d7,d1
00004C90 0C01 00FC                  		cmpi.b	#-4,d1
00004C94 6400                       		bcc.s	loc_14D6
00004C96 0241 00FF                  		andi.w	#$FF,d1
00004C9A D241                       		add.w	d1,d1
00004C9C 1031 1000                  		move.b	(a1,d1.w),d0
00004CA0 4880                       		ext.w	d0
00004CA2 9C40                       		sub.w	d0,d6
00004CA4 0C46 0009                  		cmpi.w	#9,d6
00004CA8 6400                       		bcc.s	loc_14B2
00004CAA 5046                       		addq.w	#8,d6
00004CAC E145                       		asl.w	#8,d5
00004CAE 1A18                       		move.b	(a0)+,d5
00004CB0                            
00004CB0                            loc_14B2:
00004CB0 1231 1001                  		move.b	1(a1,d1.w),d1
00004CB4 3001                       		move.w	d1,d0
00004CB6 0241 000F                  		andi.w	#$F,d1
00004CBA 0240 00F0                  		andi.w	#$F0,d0
00004CBE                            
00004CBE                            loc_14C0:				; XREF: NemDec3
00004CBE E848                       		lsr.w	#4,d0
00004CC0                            
00004CC0                            loc_14C2:				; XREF: NemDec3
00004CC0 E98C                       		lsl.l	#4,d4
00004CC2 8801                       		or.b	d1,d4
00004CC4 5343                       		subq.w	#1,d3
00004CC6 6600                       		bne.s	loc_14D0
00004CC8 4ED3                       		jmp	(a3)
00004CCA                            ; End of function NemDec2
00004CCA                            
00004CCA                            
00004CCA                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004CCA                            
00004CCA                            
00004CCA                            NemDec3:				; XREF: loc_1502
00004CCA 7800                       		moveq	#0,d4
00004CCC 7608                       		moveq	#8,d3
00004CCE                            
00004CCE                            loc_14D0:				; XREF: NemDec2
00004CCE 51C8 FFF0                  		dbf	d0,loc_14C2
00004CD2 60B4                       		bra.s	NemDec2
00004CD4                            ; ===========================================================================
00004CD4                            
00004CD4                            loc_14D6:				; XREF: NemDec2
00004CD4 5D46                       		subq.w	#6,d6
00004CD6 0C46 0009                  		cmpi.w	#9,d6
00004CDA 6400                       		bcc.s	loc_14E4
00004CDC 5046                       		addq.w	#8,d6
00004CDE E145                       		asl.w	#8,d5
00004CE0 1A18                       		move.b	(a0)+,d5
00004CE2                            
00004CE2                            loc_14E4:				; XREF: NemDec3
00004CE2 5F46                       		subq.w	#7,d6
00004CE4 3205                       		move.w	d5,d1
00004CE6 EC69                       		lsr.w	d6,d1
00004CE8 3001                       		move.w	d1,d0
00004CEA 0241 000F                  		andi.w	#$F,d1
00004CEE 0240 0070                  		andi.w	#$70,d0
00004CF2 0C46 0009                  		cmpi.w	#9,d6
00004CF6 64C6                       		bcc.s	loc_14C0
00004CF8 5046                       		addq.w	#8,d6
00004CFA E145                       		asl.w	#8,d5
00004CFC 1A18                       		move.b	(a0)+,d5
00004CFE 60BE                       		bra.s	loc_14C0
00004D00                            ; End of function NemDec3
00004D00                            
00004D00                            ; ===========================================================================
00004D00                            
00004D00                            loc_1502:				; XREF: NemDec
00004D00 2884                       		move.l	d4,(a4)
00004D02 534D                       		subq.w	#1,a5
00004D04 380D                       		move.w	a5,d4
00004D06 66C2                       		bne.s	NemDec3
00004D08 4E75                       		rts	
00004D0A                            ; ===========================================================================
00004D0A B982                       		eor.l	d4,d2
00004D0C 2882                       		move.l	d2,(a4)
00004D0E 534D                       		subq.w	#1,a5
00004D10 380D                       		move.w	a5,d4
00004D12 66B6                       		bne.s	NemDec3
00004D14 4E75                       		rts	
00004D16                            ; ===========================================================================
00004D16                            
00004D16                            loc_1518:				; XREF: NemDec
00004D16 28C4                       		move.l	d4,(a4)+
00004D18 534D                       		subq.w	#1,a5
00004D1A 380D                       		move.w	a5,d4
00004D1C 66AC                       		bne.s	NemDec3
00004D1E 4E75                       		rts	
00004D20                            ; ===========================================================================
00004D20 B982                       		eor.l	d4,d2
00004D22 28C2                       		move.l	d2,(a4)+
00004D24 534D                       		subq.w	#1,a5
00004D26 380D                       		move.w	a5,d4
00004D28 66A0                       		bne.s	NemDec3
00004D2A 4E75                       		rts	
00004D2C                            
00004D2C                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004D2C                            
00004D2C                            
00004D2C                            NemDec4:				; XREF: NemDec
00004D2C 1018                       		move.b	(a0)+,d0
00004D2E                            
00004D2E                            loc_1530:
00004D2E 0C00 00FF                  		cmpi.b	#-1,d0
00004D32 6600                       		bne.s	loc_1538
00004D34 4E75                       		rts	
00004D36                            ; ===========================================================================
00004D36                            
00004D36                            loc_1538:				; XREF: NemDec4
00004D36 3E00                       		move.w	d0,d7
00004D38                            
00004D38                            loc_153A:
00004D38 1018                       		move.b	(a0)+,d0
00004D3A 0C00 0080                  		cmpi.b	#$80,d0
00004D3E 64EE                       		bcc.s	loc_1530
00004D40 1200                       		move.b	d0,d1
00004D42 0247 000F                  		andi.w	#$F,d7
00004D46 0241 0070                  		andi.w	#$70,d1
00004D4A 8E41                       		or.w	d1,d7
00004D4C 0240 000F                  		andi.w	#$F,d0
00004D50 1200                       		move.b	d0,d1
00004D52 E149                       		lsl.w	#8,d1
00004D54 8E41                       		or.w	d1,d7
00004D56 7208                       		moveq	#8,d1
00004D58 9240                       		sub.w	d0,d1
00004D5A 6600                       		bne.s	loc_1568
00004D5C 1018                       		move.b	(a0)+,d0
00004D5E D040                       		add.w	d0,d0
00004D60 3387 0000                  		move.w	d7,(a1,d0.w)
00004D64 60D2                       		bra.s	loc_153A
00004D66                            ; ===========================================================================
00004D66                            
00004D66                            loc_1568:				; XREF: NemDec4
00004D66 1018                       		move.b	(a0)+,d0
00004D68 E368                       		lsl.w	d1,d0
00004D6A D040                       		add.w	d0,d0
00004D6C 7A01                       		moveq	#1,d5
00004D6E E36D                       		lsl.w	d1,d5
00004D70 5345                       		subq.w	#1,d5
00004D72                            
00004D72                            loc_1574:
00004D72 3387 0000                  		move.w	d7,(a1,d0.w)
00004D76 5440                       		addq.w	#2,d0
00004D78 51CD FFF8                  		dbf	d5,loc_1574
00004D7C 60BA                       		bra.s	loc_153A
00004D7E                            ; End of function NemDec4
00004D7E                            ; End of function NemDec4
00004D7E                            
00004D7E                            ; ===========================================================================
00004D7E                            ; Enigma decompression algorithm
00004D7E                            ; ===========================================================================
00004D7E                            		include	"_proc\Enigma Decompression.asm"
00004D7E                            ; ---------------------------------------------------------------------------
00004D7E                            ; Enigma decompression algorithm
00004D7E                            ; ---------------------------------------------------------------------------
00004D7E                            
00004D7E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004D7E                            
00004D7E                            
00004D7E                            EniDec:
00004D7E 48E7 FF7C                  		movem.l	d0-d7/a1-a5,-(sp)	; save registers to the stack
00004D82 3640                       		movea.w	d0,a3
00004D84 1018                       		move.b	(a0)+,d0
00004D86 4880                       		ext.w	d0
00004D88 3A40                       		movea.w	d0,a5
00004D8A 1818                       		move.b	(a0)+,d4
00004D8C E70C                       		lsl.b	#3,d4
00004D8E 3458                       		movea.w	(a0)+,a2
00004D90 D4CB                       		adda.w	a3,a2
00004D92 3858                       		movea.w	(a0)+,a4
00004D94 D8CB                       		adda.w	a3,a4
00004D96 1A18                       		move.b	(a0)+,d5
00004D98 E145                       		asl.w	#8,d5
00004D9A 1A18                       		move.b	(a0)+,d5
00004D9C 7C10                       		moveq	#$10,d6
00004D9E                            
00004D9E                            loc_173E:				; XREF: loc_1768
00004D9E 7007                       		moveq	#7,d0
00004DA0 3E06                       		move.w	d6,d7
00004DA2 9E40                       		sub.w	d0,d7
00004DA4 3205                       		move.w	d5,d1
00004DA6 EE69                       		lsr.w	d7,d1
00004DA8 0241 007F                  		andi.w	#$7F,d1
00004DAC 3401                       		move.w	d1,d2
00004DAE 0C41 0040                  		cmpi.w	#$40,d1
00004DB2 6400                       		bcc.s	loc_1758
00004DB4 7006                       		moveq	#6,d0
00004DB6 E24A                       		lsr.w	#1,d2
00004DB8                            
00004DB8                            loc_1758:
00004DB8 6100 0000                  		bsr.w	sub_188C
00004DBC 0242 000F                  		andi.w	#$F,d2
00004DC0 E849                       		lsr.w	#4,d1
00004DC2 D241                       		add.w	d1,d1
00004DC4 4EFB 1000                  		jmp	loc_17B4(pc,d1.w)
00004DC8                            ; End of function EniDec
00004DC8                            
00004DC8                            ; ===========================================================================
00004DC8                            
00004DC8                            loc_1768:				; XREF: loc_17B4
00004DC8 32CA                       		move.w	a2,(a1)+
00004DCA 524A                       		addq.w	#1,a2
00004DCC 51CA FFFA                  		dbf	d2,loc_1768
00004DD0 60CC                       		bra.s	loc_173E
00004DD2                            ; ===========================================================================
00004DD2                            
00004DD2                            loc_1772:				; XREF: loc_17B4
00004DD2 32CC                       		move.w	a4,(a1)+
00004DD4 51CA FFFC                  		dbf	d2,loc_1772
00004DD8 60C4                       		bra.s	loc_173E
00004DDA                            ; ===========================================================================
00004DDA                            
00004DDA                            loc_177A:				; XREF: loc_17B4
00004DDA 6100 0000                  		bsr.w	loc_17DC
00004DDE                            
00004DDE                            loc_177E:
00004DDE 32C1                       		move.w	d1,(a1)+
00004DE0 51CA FFFC                  		dbf	d2,loc_177E
00004DE4 60B8                       		bra.s	loc_173E
00004DE6                            ; ===========================================================================
00004DE6                            
00004DE6                            loc_1786:				; XREF: loc_17B4
00004DE6 6100 0000                  		bsr.w	loc_17DC
00004DEA                            
00004DEA                            loc_178A:
00004DEA 32C1                       		move.w	d1,(a1)+
00004DEC 5241                       		addq.w	#1,d1
00004DEE 51CA FFFA                  		dbf	d2,loc_178A
00004DF2 60AA                       		bra.s	loc_173E
00004DF4                            ; ===========================================================================
00004DF4                            
00004DF4                            loc_1794:				; XREF: loc_17B4
00004DF4 6100 0000                  		bsr.w	loc_17DC
00004DF8                            
00004DF8                            loc_1798:
00004DF8 32C1                       		move.w	d1,(a1)+
00004DFA 5341                       		subq.w	#1,d1
00004DFC 51CA FFFA                  		dbf	d2,loc_1798
00004E00 609C                       		bra.s	loc_173E
00004E02                            ; ===========================================================================
00004E02                            
00004E02                            loc_17A2:				; XREF: loc_17B4
00004E02 0C42 000F                  		cmpi.w	#$F,d2
00004E06 6700                       		beq.s	loc_17C4
00004E08                            
00004E08                            loc_17A8:
00004E08 6100 0000                  		bsr.w	loc_17DC
00004E0C 32C1                       		move.w	d1,(a1)+
00004E0E 51CA FFF8                  		dbf	d2,loc_17A8
00004E12 608A                       		bra.s	loc_173E
00004E14                            ; ===========================================================================
00004E14                            
00004E14                            loc_17B4:				; XREF: EniDec
00004E14 60B2                       		bra.s	loc_1768
00004E16                            ; ===========================================================================
00004E16 60B0                       		bra.s	loc_1768
00004E18                            ; ===========================================================================
00004E18 60B8                       		bra.s	loc_1772
00004E1A                            ; ===========================================================================
00004E1A 60B6                       		bra.s	loc_1772
00004E1C                            ; ===========================================================================
00004E1C 60BC                       		bra.s	loc_177A
00004E1E                            ; ===========================================================================
00004E1E 60C6                       		bra.s	loc_1786
00004E20                            ; ===========================================================================
00004E20 60D2                       		bra.s	loc_1794
00004E22                            ; ===========================================================================
00004E22 60DE                       		bra.s	loc_17A2
00004E24                            ; ===========================================================================
00004E24                            
00004E24                            loc_17C4:				; XREF: loc_17A2
00004E24 5348                       		subq.w	#1,a0
00004E26 0C46 0010                  		cmpi.w	#$10,d6
00004E2A 6600                       		bne.s	loc_17CE
00004E2C 5348                       		subq.w	#1,a0
00004E2E                            
00004E2E                            loc_17CE:
00004E2E 3008                       		move.w	a0,d0
00004E30 E248                       		lsr.w	#1,d0
00004E32 6400                       		bcc.s	loc_17D6
00004E34 5248                       		addq.w	#1,a0
00004E36                            
00004E36                            loc_17D6:
00004E36 4CDF 3EFF                  		movem.l	(sp)+,d0-d7/a1-a5
00004E3A 4E75                       		rts	
00004E3C                            ; ===========================================================================
00004E3C                            
00004E3C                            loc_17DC:				; XREF: loc_17A2
00004E3C 360B                       		move.w	a3,d3
00004E3E 1204                       		move.b	d4,d1
00004E40 D201                       		add.b	d1,d1
00004E42 6400                       		bcc.s	loc_17EE
00004E44 5346                       		subq.w	#1,d6
00004E46 0D05                       		btst	d6,d5
00004E48 6700                       		beq.s	loc_17EE
00004E4A 0043 8000                  		ori.w	#-$8000,d3
00004E4E                            
00004E4E                            loc_17EE:
00004E4E D201                       		add.b	d1,d1
00004E50 6400                       		bcc.s	loc_17FC
00004E52 5346                       		subq.w	#1,d6
00004E54 0D05                       		btst	d6,d5
00004E56 6700                       		beq.s	loc_17FC
00004E58 0643 4000                  		addi.w	#$4000,d3
00004E5C                            
00004E5C                            loc_17FC:
00004E5C D201                       		add.b	d1,d1
00004E5E 6400                       		bcc.s	loc_180A
00004E60 5346                       		subq.w	#1,d6
00004E62 0D05                       		btst	d6,d5
00004E64 6700                       		beq.s	loc_180A
00004E66 0643 2000                  		addi.w	#$2000,d3
00004E6A                            
00004E6A                            loc_180A:
00004E6A D201                       		add.b	d1,d1
00004E6C 6400                       		bcc.s	loc_1818
00004E6E 5346                       		subq.w	#1,d6
00004E70 0D05                       		btst	d6,d5
00004E72 6700                       		beq.s	loc_1818
00004E74 0043 1000                  		ori.w	#$1000,d3
00004E78                            
00004E78                            loc_1818:
00004E78 D201                       		add.b	d1,d1
00004E7A 6400                       		bcc.s	loc_1826
00004E7C 5346                       		subq.w	#1,d6
00004E7E 0D05                       		btst	d6,d5
00004E80 6700                       		beq.s	loc_1826
00004E82 0043 0800                  		ori.w	#$800,d3
00004E86                            
00004E86                            loc_1826:
00004E86 3205                       		move.w	d5,d1
00004E88 3E06                       		move.w	d6,d7
00004E8A 9E4D                       		sub.w	a5,d7
00004E8C 6400                       		bcc.s	loc_1856
00004E8E 3C07                       		move.w	d7,d6
00004E90 0646 0010                  		addi.w	#$10,d6
00004E94 4447                       		neg.w	d7
00004E96 EF69                       		lsl.w	d7,d1
00004E98 1A10                       		move.b	(a0),d5
00004E9A EF3D                       		rol.b	d7,d5
00004E9C DE47                       		add.w	d7,d7
00004E9E CA7B 7000                  		and.w	word_186C-2(pc,d7.w),d5
00004EA2 D245                       		add.w	d5,d1
00004EA4                            
00004EA4                            loc_1844:				; XREF: loc_1868
00004EA4 300D                       		move.w	a5,d0
00004EA6 D040                       		add.w	d0,d0
00004EA8 C27B 0000                  		and.w	word_186C-2(pc,d0.w),d1
00004EAC D243                       		add.w	d3,d1
00004EAE 1A18                       		move.b	(a0)+,d5
00004EB0 E14D                       		lsl.w	#8,d5
00004EB2 1A18                       		move.b	(a0)+,d5
00004EB4 4E75                       		rts	
00004EB6                            ; ===========================================================================
00004EB6                            
00004EB6                            loc_1856:				; XREF: loc_1826
00004EB6 6700                       		beq.s	loc_1868
00004EB8 EE69                       		lsr.w	d7,d1
00004EBA 300D                       		move.w	a5,d0
00004EBC D040                       		add.w	d0,d0
00004EBE C27B 0000                  		and.w	word_186C-2(pc,d0.w),d1
00004EC2 D243                       		add.w	d3,d1
00004EC4 300D                       		move.w	a5,d0
00004EC6 6000                       		bra.s	sub_188C
00004EC8                            ; ===========================================================================
00004EC8                            
00004EC8                            loc_1868:				; XREF: loc_1856
00004EC8 7C10                       		moveq	#$10,d6
00004ECA                            
00004ECA                            loc_186A:
00004ECA 60D8                       		bra.s	loc_1844
00004ECC                            ; ===========================================================================
00004ECC 0001 0003 0007 000F 001F+  word_186C:	dc.w 1,	3, 7, $F, $1F, $3F, $7F, $FF, $1FF, $3FF, $7FF
00004EE2 0FFF 1FFF 3FFF 7FFF FFFF   		dc.w $FFF, $1FFF, $3FFF, $7FFF,	$FFFF	; XREF: loc_1856
00004EEC                            
00004EEC                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004EEC                            
00004EEC                            
00004EEC                            sub_188C:				; XREF: EniDec
00004EEC 9C40                       		sub.w	d0,d6
00004EEE 0C46 0009                  		cmpi.w	#9,d6
00004EF2 6400                       		bcc.s	locret_189A
00004EF4 5046                       		addq.w	#8,d6
00004EF6 E145                       		asl.w	#8,d5
00004EF8 1A18                       		move.b	(a0)+,d5
00004EFA                            
00004EFA                            locret_189A:
00004EFA 4E75                       		rts	
00004EFC                            ; End of function sub_188C
00004EFC                            ; End of function sub_188C
00004EFC                            
00004EFC                            ; ===========================================================================
00004EFC                            ; Kosinski decompression algorithm
00004EFC                            ; ===========================================================================
00004EFC                            		include	"_proc\Kosinski Decompression.asm"
00004EFC                            ; ---------------------------------------------------------------------------
00004EFC                            ; Kosinski decompression algorithm
00004EFC                            ; ---------------------------------------------------------------------------
00004EFC                            
00004EFC                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004EFC                            
00004EFC                            
00004EFC                            KosDec:
00004EFC                            
00004EFC =FFFFFFFE                  var_2		= -2
00004EFC =FFFFFFFF                  var_1		= -1
00004EFC                            
00004EFC 558F                       		subq.l	#2,sp
00004EFE 1F58 0001                  		move.b	(a0)+,2+var_1(sp)
00004F02 1E98                       		move.b	(a0)+,(sp)
00004F04 3A17                       		move.w	(sp),d5
00004F06 780F                       		moveq	#$F,d4
00004F08                            
00004F08                            loc_18A8:
00004F08 E24D                       		lsr.w	#1,d5
00004F0A 40C6                       		move	sr,d6
00004F0C 51CC 0000                  		dbf	d4,loc_18BA
00004F10 1F58 0001                  		move.b	(a0)+,2+var_1(sp)
00004F14 1E98                       		move.b	(a0)+,(sp)
00004F16 3A17                       		move.w	(sp),d5
00004F18 780F                       		moveq	#$F,d4
00004F1A                            
00004F1A                            loc_18BA:
00004F1A 44C6                       		move	d6,ccr
00004F1C 6400                       		bcc.s	loc_18C2
00004F1E 12D8                       		move.b	(a0)+,(a1)+
00004F20 60E6                       		bra.s	loc_18A8
00004F22                            ; ===========================================================================
00004F22                            
00004F22                            loc_18C2:				; XREF: KosDec
00004F22 7600                       		moveq	#0,d3
00004F24 E24D                       		lsr.w	#1,d5
00004F26 40C6                       		move	sr,d6
00004F28 51CC 0000                  		dbf	d4,loc_18D6
00004F2C 1F58 0001                  		move.b	(a0)+,2+var_1(sp)
00004F30 1E98                       		move.b	(a0)+,(sp)
00004F32 3A17                       		move.w	(sp),d5
00004F34 780F                       		moveq	#$F,d4
00004F36                            
00004F36                            loc_18D6:
00004F36 44C6                       		move	d6,ccr
00004F38 6500                       		bcs.s	loc_1906
00004F3A E24D                       		lsr.w	#1,d5
00004F3C 51CC 0000                  		dbf	d4,loc_18EA
00004F40 1F58 0001                  		move.b	(a0)+,2+var_1(sp)
00004F44 1E98                       		move.b	(a0)+,(sp)
00004F46 3A17                       		move.w	(sp),d5
00004F48 780F                       		moveq	#$F,d4
00004F4A                            
00004F4A                            loc_18EA:
00004F4A E353                       		roxl.w	#1,d3
00004F4C E24D                       		lsr.w	#1,d5
00004F4E 51CC 0000                  		dbf	d4,loc_18FC
00004F52 1F58 0001                  		move.b	(a0)+,2+var_1(sp)
00004F56 1E98                       		move.b	(a0)+,(sp)
00004F58 3A17                       		move.w	(sp),d5
00004F5A 780F                       		moveq	#$F,d4
00004F5C                            
00004F5C                            loc_18FC:
00004F5C E353                       		roxl.w	#1,d3
00004F5E 5243                       		addq.w	#1,d3
00004F60 74FF                       		moveq	#-1,d2
00004F62 1418                       		move.b	(a0)+,d2
00004F64 6000                       		bra.s	loc_191C
00004F66                            ; ===========================================================================
00004F66                            
00004F66                            loc_1906:				; XREF: loc_18C2
00004F66 1018                       		move.b	(a0)+,d0
00004F68 1218                       		move.b	(a0)+,d1
00004F6A 74FF                       		moveq	#-1,d2
00004F6C 1401                       		move.b	d1,d2
00004F6E EB4A                       		lsl.w	#5,d2
00004F70 1400                       		move.b	d0,d2
00004F72 0241 0007                  		andi.w	#7,d1
00004F76 6700                       		beq.s	loc_1928
00004F78 1601                       		move.b	d1,d3
00004F7A 5243                       		addq.w	#1,d3
00004F7C                            
00004F7C                            loc_191C:
00004F7C 1031 2000                  		move.b	(a1,d2.w),d0
00004F80 12C0                       		move.b	d0,(a1)+
00004F82 51CB FFF8                  		dbf	d3,loc_191C
00004F86 6080                       		bra.s	loc_18A8
00004F88                            ; ===========================================================================
00004F88                            
00004F88                            loc_1928:				; XREF: loc_1906
00004F88 1218                       		move.b	(a0)+,d1
00004F8A 6700                       		beq.s	loc_1938
00004F8C 0C01 0001                  		cmpi.b	#1,d1
00004F90 6700 FF76                  		beq.w	loc_18A8
00004F94 1601                       		move.b	d1,d3
00004F96 60E4                       		bra.s	loc_191C
00004F98                            ; ===========================================================================
00004F98                            
00004F98                            loc_1938:				; XREF: loc_1928
00004F98 548F                       		addq.l	#2,sp
00004F9A 4E75                       		rts	
00004F9C                            ; End of function KosDec
00004F9C                            ; End of function KosDec
00004F9C                            
00004F9C                            ; ===========================================================================
00004F9C                            ; Pallet procedures
00004F9C                            ; ===========================================================================
00004F9C                            		include	"_proc\Pallet procedures.asm"
00004F9C                            ; ---------------------------------------------------------------------------
00004F9C                            ; Subroutine to	fade out and fade in
00004F9C                            ; ---------------------------------------------------------------------------
00004F9C                            
00004F9C                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004F9C                            
00004F9C                            
00004F9C                            Pal_FadeTo:
00004F9C 31FC 003F F626             		move.w	#$3F,($FFFFF626).w
00004FA2                             
00004FA2                            Pal_FadeTo2:
00004FA2 7000                       		moveq	#0,d0
00004FA4 41F8 FB00                  		lea	($FFFFFB00).w,a0
00004FA8 1038 F626                  		move.b	($FFFFF626).w,d0
00004FAC D0C0                       		adda.w	d0,a0
00004FAE 7200                       		moveq	#0,d1
00004FB0 1038 F627                  		move.b	($FFFFF627).w,d0
00004FB4                             
00004FB4                            Pal_ToBlack:
00004FB4 30C1                       		move.w	d1,(a0)+
00004FB6 51C8 FFFC                  		dbf	d0,Pal_ToBlack	; fill pallet with $000	(black)
00004FBA 780E                       		moveq	#$0E,d4					; MJ: prepare maximum colour check
00004FBC 7C00                       		moveq	#$00,d6					; MJ: clear d6
00004FBE                             
00004FBE                            loc_1DCE:
00004FBE 11FC 0012 F62A             		move.b	#$12,($FFFFF62A).w
00004FC4 6100 0000                  		bsr.w	DelayProgram
00004FC8 0846 0000                  		bchg	#$00,d6					; MJ: change delay counter
00004FCC 67F0                       		beq	loc_1DCE				; MJ: if null, delay a frame
00004FCE 6100                       		bsr.s	Pal_FadeIn
00004FD0 5504                       		subq.b	#$02,d4					; MJ: decrease colour check
00004FD2 66EA                       		bne	loc_1DCE				; MJ: if it has not reached null, branch
00004FD4 11FC 0012 F62A             		move.b	#$12,($FFFFF62A).w			; MJ: wait for V-blank again (so colours transfer)
00004FDA 6000 0000                  		bra	DelayProgram				; MJ: ''
00004FDE                             
00004FDE                            ; End of function Pal_FadeTo
00004FDE                             
00004FDE                            ; ---------------------------------------------------------------------------
00004FDE                            ; Pallet fade-in subroutine
00004FDE                            ; ---------------------------------------------------------------------------
00004FDE                             
00004FDE                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00004FDE                             
00004FDE                             
00004FDE                            Pal_FadeIn:				; XREF: Pal_FadeTo
00004FDE 7000                       		moveq	#0,d0
00004FE0 41F8 FB00                  		lea	($FFFFFB00).w,a0
00004FE4 43F8 FB80                  		lea	($FFFFFB80).w,a1
00004FE8 1038 F626                  		move.b	($FFFFF626).w,d0
00004FEC D0C0                       		adda.w	d0,a0
00004FEE D2C0                       		adda.w	d0,a1
00004FF0 1038 F627                  		move.b	($FFFFF627).w,d0
00004FF4                             
00004FF4                            loc_1DFA:
00004FF4 6100                       		bsr.s	Pal_AddColor
00004FF6 51C8 FFFC                  		dbf	d0,loc_1DFA
00004FFA 0C38 0001 FE10             		cmpi.b	#1,($FFFFFE10).w
00005000 6600                       		bne.s	locret_1E24
00005002 7000                       		moveq	#0,d0
00005004 41F8 FA80                  		lea	($FFFFFA80).w,a0
00005008 43F8 FA00                  		lea	($FFFFFA00).w,a1
0000500C 1038 F626                  		move.b	($FFFFF626).w,d0
00005010 D0C0                       		adda.w	d0,a0
00005012 D2C0                       		adda.w	d0,a1
00005014 1038 F627                  		move.b	($FFFFF627).w,d0
00005018                             
00005018                            loc_1E1E:
00005018 6100                       		bsr.s	Pal_AddColor
0000501A 51C8 FFFC                  		dbf	d0,loc_1E1E
0000501E                             
0000501E                            locret_1E24:
0000501E 4E75                       		rts	
00005020                            ; End of function Pal_FadeIn
00005020                             
00005020                             
00005020                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005020                             
00005020                             
00005020                            Pal_AddColor:				; XREF: Pal_FadeIn
00005020 1A11                       		move.b	(a1),d5					; MJ: load blue
00005022 3219                       		move.w	(a1)+,d1				; MJ: load green and red
00005024 1401                       		move.b	d1,d2					; MJ: load red
00005026 E809                       		lsr.b	#$04,d1					; MJ: get only green
00005028 0202 000E                  		andi.b	#$0E,d2					; MJ: get only red
0000502C 3610                       		move.w	(a0),d3					; MJ: load current colour in buffer
0000502E B805                       		cmp.b	d5,d4					; MJ: is it time for blue to fade?
00005030 6200 0000                  		bhi	FCI_NoBlue				; MJ:  , 
00005034 0643 0200                  		addi.w	#$0200,d3				; MJ: increase blue
00005038                             
00005038                            FCI_NoBlue:
00005038 B801                       		cmp.b	d1,d4					; MJ: is it time for green to fade?
0000503A 6200 0000                  		bhi	FCI_NoGreen				; MJ:  , 
0000503E 0603 0020                  		addi.b	#$20,d3					; MJ: increase green
00005042                             
00005042                            FCI_NoGreen:
00005042 B802                       		cmp.b	d2,d4					; MJ: is it time for red to fade?
00005044 6200 0000                  		bhi	FCI_NoRed				; MJ:  , 
00005048 5403                       		addq.b	#$02,d3					; MJ: increase red
0000504A                             
0000504A                            FCI_NoRed:
0000504A 30C3                       		move.w	d3,(a0)+				; MJ: save colour
0000504C 4E75                       		rts						; MJ: return
0000504E                             
0000504E                            ; End of function Pal_AddColor
0000504E                             
0000504E                             
0000504E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000504E                             
0000504E                             
0000504E                            Pal_FadeFrom:
0000504E 31FC 003F F626             		move.w	#$3F,($FFFFF626).w
00005054 7807                       		moveq	#$07,d4					; MJ: set repeat times
00005056 7C00                       		moveq	#$00,d6					; MJ: clear d6
00005058                             
00005058                            loc_1E5C:
00005058 11FC 0012 F62A             		move.b	#$12,($FFFFF62A).w
0000505E 6100 0000                  		bsr.w	DelayProgram
00005062 0846 0000                  		bchg	#$00,d6					; MJ: change delay counter
00005066 67F0                       		beq	loc_1E5C				; MJ: if null, delay a frame
00005068 6100                       		bsr.s	Pal_FadeOut
0000506A 51CC FFEC                  		dbf	d4,loc_1E5C
0000506E 4E75                       		rts	
00005070                            ; End of function Pal_FadeFrom
00005070                             
00005070                            ; ---------------------------------------------------------------------------
00005070                            ; Pallet fade-out subroutine
00005070                            ; ---------------------------------------------------------------------------
00005070                             
00005070                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005070                            
00005070                            Pal_FadeOut:				; XREF: Pal_FadeFrom
00005070 7000                       		moveq	#0,d0
00005072 41F8 FB00                  		lea	($FFFFFB00).w,a0
00005076 1038 F626                  		move.b	($FFFFF626).w,d0
0000507A D0C0                       		adda.w	d0,a0
0000507C 1038 F627                  		move.b	($FFFFF627).w,d0
00005080                             
00005080                            loc_1E82:
00005080 6100                       		bsr.s	Pal_DecColor
00005082 51C8 FFFC                  		dbf	d0,loc_1E82
00005086                             
00005086 7000                       		moveq	#0,d0
00005088 41F8 FA80                  		lea	($FFFFFA80).w,a0
0000508C 1038 F626                  		move.b	($FFFFF626).w,d0
00005090 D0C0                       		adda.w	d0,a0
00005092 1038 F627                  		move.b	($FFFFF627).w,d0
00005096                             
00005096                            loc_1E98:
00005096 6100                       		bsr.s	Pal_DecColor
00005098 51C8 FFFC                  		dbf	d0,loc_1E98
0000509C 4E75                       		rts	
0000509E                            ; End of function Pal_FadeOut
0000509E                             
0000509E                             
0000509E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000509E                             
0000509E                             
0000509E                            Pal_DecColor:				; XREF: Pal_FadeOut
0000509E 3A10                       		move.w	(a0),d5					; MJ: load colour
000050A0 3205                       		move.w	d5,d1					; MJ: copy to d1
000050A2 1401                       		move.b	d1,d2					; MJ: load green and red
000050A4 1601                       		move.b	d1,d3					; MJ: load red
000050A6 0241 0E00                  		andi.w	#$0E00,d1				; MJ: get only blue
000050AA 6700 0000                  		beq	FCO_NoBlue				; MJ: if blue is finished, branch
000050AE 0445 0200                  		subi.w	#$0200,d5				; MJ: decrease blue
000050B2                             
000050B2                            FCO_NoBlue:
000050B2 0242 00E0                  		andi.w	#$00E0,d2				; MJ: get only green (needs to be word)
000050B6 6700 0000                  		beq	FCO_NoGreen				; MJ: if green is finished, branch
000050BA 0405 0020                  		subi.b	#$20,d5					; MJ: decrease green
000050BE                             
000050BE                            FCO_NoGreen:
000050BE 0203 000E                  		andi.b	#$0E,d3					; MJ: get only red
000050C2 6700 0000                  		beq	FCO_NoRed				; MJ: if red is finished, branch
000050C6 5505                       		subq.b	#$02,d5					; MJ: decrease red
000050C8                             
000050C8                            FCO_NoRed:
000050C8 30C5                       		move.w	d5,(a0)+				; MJ: save new colour
000050CA 4E75                       		rts						; MJ: return
000050CC                             
000050CC                            ; End of function Pal_DecColor
000050CC                            
000050CC                            ; ---------------------------------------------------------------------------
000050CC                            ; Subroutine to	fill the pallet	with white (special stage)
000050CC                            ; ---------------------------------------------------------------------------
000050CC                            
000050CC                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000050CC                            
000050CC                            
000050CC                            Pal_MakeWhite:				; XREF: SpecialStage
000050CC 31FC 003F F626             		move.w	#$3F,($FFFFF626).w
000050D2 7000                       		moveq	#0,d0
000050D4 41F8 FB00                  		lea	($FFFFFB00).w,a0
000050D8 1038 F626                  		move.b	($FFFFF626).w,d0
000050DC D0C0                       		adda.w	d0,a0
000050DE 323C 0EEE                  		move.w	#$EEE,d1
000050E2 1038 F627                  		move.b	($FFFFF627).w,d0
000050E6                            
000050E6                            PalWhite_Loop:
000050E6 30C1                       		move.w	d1,(a0)+
000050E8 51C8 FFFC                  		dbf	d0,PalWhite_Loop
000050EC 383C 0015                  		move.w	#$15,d4
000050F0                            
000050F0                            loc_1EF4:
000050F0 11FC 0012 F62A             		move.b	#$12,($FFFFF62A).w
000050F6 6100 0000                  		bsr.w	DelayProgram
000050FA 6100                       		bsr.s	Pal_WhiteToBlack
000050FC 51CC FFF2                  		dbf	d4,loc_1EF4
00005100 4E75                       		rts	
00005102                            ; End of function Pal_MakeWhite
00005102                            
00005102                            
00005102                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005102                            
00005102                            
00005102                            Pal_WhiteToBlack:			; XREF: Pal_MakeWhite
00005102 7000                       		moveq	#0,d0
00005104 41F8 FB00                  		lea	($FFFFFB00).w,a0
00005108 43F8 FB80                  		lea	($FFFFFB80).w,a1
0000510C 1038 F626                  		move.b	($FFFFF626).w,d0
00005110 D0C0                       		adda.w	d0,a0
00005112 D2C0                       		adda.w	d0,a1
00005114 1038 F627                  		move.b	($FFFFF627).w,d0
00005118                            
00005118                            loc_1F20:
00005118 6100                       		bsr.s	Pal_DecColor2
0000511A 51C8 FFFC                  		dbf	d0,loc_1F20
0000511E                            
0000511E 0C38 0001 FE10             		cmpi.b	#1,($FFFFFE10).w
00005124 6600                       		bne.s	locret_1F4A
00005126 7000                       		moveq	#0,d0
00005128 41F8 FA80                  		lea	($FFFFFA80).w,a0
0000512C 43F8 FA00                  		lea	($FFFFFA00).w,a1
00005130 1038 F626                  		move.b	($FFFFF626).w,d0
00005134 D0C0                       		adda.w	d0,a0
00005136 D2C0                       		adda.w	d0,a1
00005138 1038 F627                  		move.b	($FFFFF627).w,d0
0000513C                            
0000513C                            loc_1F44:
0000513C 6100                       		bsr.s	Pal_DecColor2
0000513E 51C8 FFFC                  		dbf	d0,loc_1F44
00005142                            
00005142                            locret_1F4A:
00005142 4E75                       		rts	
00005144                            ; End of function Pal_WhiteToBlack
00005144                            
00005144                            
00005144                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005144                            
00005144                            
00005144                            Pal_DecColor2:				; XREF: Pal_WhiteToBlack
00005144 3419                       		move.w	(a1)+,d2
00005146 3610                       		move.w	(a0),d3
00005148 B642                       		cmp.w	d2,d3
0000514A 6700                       		beq.s	loc_1F78
0000514C 3203                       		move.w	d3,d1
0000514E 0441 0200                  		subi.w	#$200,d1	; decrease blue	value
00005152 6500                       		bcs.s	loc_1F64
00005154 B242                       		cmp.w	d2,d1
00005156 6500                       		bcs.s	loc_1F64
00005158 30C1                       		move.w	d1,(a0)+
0000515A 4E75                       		rts	
0000515C                            ; ===========================================================================
0000515C                            
0000515C                            loc_1F64:				; XREF: Pal_DecColor2
0000515C 3203                       		move.w	d3,d1
0000515E 0441 0020                  		subi.w	#$20,d1		; decrease green value
00005162 6500                       		bcs.s	loc_1F74
00005164 B242                       		cmp.w	d2,d1
00005166 6500                       		bcs.s	loc_1F74
00005168 30C1                       		move.w	d1,(a0)+
0000516A 4E75                       		rts	
0000516C                            ; ===========================================================================
0000516C                            
0000516C                            loc_1F74:				; XREF: loc_1F64
0000516C 5558                       		subq.w	#2,(a0)+	; decrease red value
0000516E 4E75                       		rts	
00005170                            ; ===========================================================================
00005170                            
00005170                            loc_1F78:				; XREF: Pal_DecColor2
00005170 5448                       		addq.w	#2,a0
00005172 4E75                       		rts	
00005174                            ; End of function Pal_DecColor2
00005174                            
00005174                            ; ---------------------------------------------------------------------------
00005174                            ; Subroutine to	make a white flash when	you enter a special stage
00005174                            ; ---------------------------------------------------------------------------
00005174                            
00005174                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005174                            
00005174                            
00005174                            Pal_MakeFlash:				; XREF: SpecialStage
00005174 31FC 003F F626             		move.w	#$3F,($FFFFF626).w
0000517A 383C 0015                  		move.w	#$15,d4
0000517E                            
0000517E                            loc_1F86:
0000517E 11FC 0012 F62A             		move.b	#$12,($FFFFF62A).w
00005184 6100 0000                  		bsr.w	DelayProgram
00005188 6100                       		bsr.s	Pal_ToWhite
0000518A 51CC FFF2                  		dbf	d4,loc_1F86
0000518E 4E75                       		rts	
00005190                            ; End of function Pal_MakeFlash
00005190                            
00005190                            
00005190                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005190                            
00005190                            
00005190                            Pal_ToWhite:				; XREF: Pal_MakeFlash
00005190 7000                       		moveq	#0,d0
00005192 41F8 FB00                  		lea	($FFFFFB00).w,a0
00005196 1038 F626                  		move.b	($FFFFF626).w,d0
0000519A D0C0                       		adda.w	d0,a0
0000519C 1038 F627                  		move.b	($FFFFF627).w,d0
000051A0                            
000051A0                            loc_1FAC:
000051A0 6100                       		bsr.s	Pal_AddColor2
000051A2 51C8 FFFC                  		dbf	d0,loc_1FAC
000051A6 7000                       		moveq	#0,d0
000051A8 41F8 FA80                  		lea	($FFFFFA80).w,a0
000051AC 1038 F626                  		move.b	($FFFFF626).w,d0
000051B0 D0C0                       		adda.w	d0,a0
000051B2 1038 F627                  		move.b	($FFFFF627).w,d0
000051B6                            
000051B6                            loc_1FC2:
000051B6 6100                       		bsr.s	Pal_AddColor2
000051B8 51C8 FFFC                  		dbf	d0,loc_1FC2
000051BC 4E75                       		rts	
000051BE                            ; End of function Pal_ToWhite
000051BE                            
000051BE                            
000051BE                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000051BE                            
000051BE                            
000051BE                            Pal_AddColor2:				; XREF: Pal_ToWhite
000051BE 3410                       		move.w	(a0),d2
000051C0 0C42 0EEE                  		cmpi.w	#$EEE,d2
000051C4 6700                       		beq.s	loc_2006
000051C6 3202                       		move.w	d2,d1
000051C8 0241 000E                  		andi.w	#$E,d1
000051CC 0C41 000E                  		cmpi.w	#$E,d1
000051D0 6700                       		beq.s	loc_1FE2
000051D2 5458                       		addq.w	#2,(a0)+	; increase red value
000051D4 4E75                       		rts	
000051D6                            ; ===========================================================================
000051D6                            
000051D6                            loc_1FE2:				; XREF: Pal_AddColor2
000051D6 3202                       		move.w	d2,d1
000051D8 0241 00E0                  		andi.w	#$E0,d1
000051DC 0C41 00E0                  		cmpi.w	#$E0,d1
000051E0 6700                       		beq.s	loc_1FF4
000051E2 0658 0020                  		addi.w	#$20,(a0)+	; increase green value
000051E6 4E75                       		rts	
000051E8                            ; ===========================================================================
000051E8                            
000051E8                            loc_1FF4:				; XREF: loc_1FE2
000051E8 3202                       		move.w	d2,d1
000051EA 0241 0E00                  		andi.w	#$E00,d1
000051EE 0C41 0E00                  		cmpi.w	#$E00,d1
000051F2 6700                       		beq.s	loc_2006
000051F4 0658 0200                  		addi.w	#$200,(a0)+	; increase blue	value
000051F8 4E75                       		rts	
000051FA                            ; ===========================================================================
000051FA                            
000051FA                            loc_2006:				; XREF: Pal_AddColor2
000051FA 5448                       		addq.w	#2,a0
000051FC 4E75                       		rts	
000051FE                            ; End of function Pal_AddColor2
000051FE                            ; End of function Pal_AddColor2
000051FE                            
000051FE                            ; ===========================================================================
000051FE                            ; Other procedures
000051FE                            ; ===========================================================================
000051FE                            		include "_proc\Other procedures.asm"
000051FE                            ; ---------------------------------------------------------------------------
000051FE                            ; Subroutine to	initialise joypads
000051FE                            ; ---------------------------------------------------------------------------
000051FE                            
000051FE                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000051FE                            
000051FE                            
000051FE                            JoypadInit:				; XREF: GameClrRAM
000051FE 33FC 0100 00A1 1100        		move.w	#$100,($A11100).l ;  Z80
00005206                            
00005206                            Joypad_WaitZ80:
00005206 0839 0000 00A1 1100        		btst	#0,($A11100).l	; Z80 ?
0000520E 66F6                       		bne.s	Joypad_WaitZ80	;  , 
00005210 7040                       		moveq	#$40,d0
00005212 13C0 00A1 0009             		move.b	d0,($A10009).l	; init port 1 (joypad 1)
00005218 13C0 00A1 000B             		move.b	d0,($A1000B).l	; init port 2 (joypad 2)
0000521E 13C0 00A1 000D             		move.b	d0,($A1000D).l	; init port 3 (extra)
00005224 33FC 0000 00A1 1100        		move.w	#0,($A11100).l	;  Z80
0000522C 4E75                       		rts	
0000522E                            ; End of function JoypadInit
0000522E                            
0000522E                            ; ---------------------------------------------------------------------------
0000522E                            ; Subroutine to	read joypad input, and send it to the RAM
0000522E                            ; ---------------------------------------------------------------------------
0000522E                            
0000522E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000522E                            
0000522E                            
0000522E                            ReadJoypads:
0000522E 41F8 F604                  		lea	(Joypad).w,a0	; address where joypad states are written
00005232 43F9 00A1 0003             		lea	($A10003).l,a1	; first	joypad port
00005238 6100                       		bsr.s	Joypad_Read	; do the first joypad
0000523A 5449                       		addq.w	#2,a1		; do the second	joypad
0000523C                            
0000523C                            Joypad_Read:
0000523C 12BC 0000                  		move.b	#0,(a1)
00005240 4E71                       		nop	
00005242 4E71                       		nop	
00005244 1011                       		move.b	(a1),d0
00005246 E508                       		lsl.b	#2,d0
00005248 0200 00C0                  		andi.b	#$C0,d0
0000524C 12BC 0040                  		move.b	#$40,(a1)
00005250 4E71                       		nop	
00005252 4E71                       		nop
00005254 1211                       		move.b	(a1),d1
00005256 0201 003F                  		andi.b	#$3F,d1
0000525A 8001                       		or.b	d1,d0
0000525C 4600                       		not.b	d0
0000525E 1210                       		move.b	(a0),d1
00005260 B101                       		eor.b	d0,d1
00005262 10C0                       		move.b	d0,(a0)+
00005264 C200                       		and.b	d0,d1
00005266 10C1                       		move.b	d1,(a0)+
00005268 4E75                       		rts	
0000526A                            ; End of function ReadJoypads
0000526A                            
0000526A                            ; ---------------------------------------------------------------------------
0000526A                            ; Subroutine to	delay the program by ($FFFFF62A) frames
0000526A                            ; ---------------------------------------------------------------------------
0000526A                            
0000526A                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000526A                            
0000526A                            
0000526A                            DelayProgram:				; XREF: PauseGame
0000526A 46FC 2300                  		move	#$2300,sr	;  
0000526E 4A38 F62A                  	@wait:	tst.b	($FFFFF62A).w	; has VBlank routine finished?
00005272 66FA                       		bne.s	@wait		;  , 
00005274 4E75                       		rts	
00005276                            ; End of function DelayProgram
00005276                            
00005276                            ; ---------------------------------------------------------------------------
00005276                            ; Subroutine to	generate a pseudo-random number	in d0
00005276                            ; ---------------------------------------------------------------------------
00005276                            
00005276                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005276                            
00005276                            
00005276                            RandomNumber:
00005276 2238 F636                  		move.l	($FFFFF636).w,d1
0000527A 6600                       		bne.s	loc_29C0
0000527C 223C 2A6D 365A             		move.l	#$2A6D365A,d1
00005282                            
00005282                            loc_29C0:
00005282 2001                       		move.l	d1,d0
00005284 E581                       		asl.l	#2,d1
00005286 D280                       		add.l	d0,d1
00005288 E781                       		asl.l	#3,d1
0000528A D280                       		add.l	d0,d1
0000528C 3001                       		move.w	d1,d0
0000528E 4841                       		swap	d1
00005290 D041                       		add.w	d1,d0
00005292 3200                       		move.w	d0,d1
00005294 4841                       		swap	d1
00005296 21C1 F636                  		move.l	d1,($FFFFF636).w
0000529A 4E75                       		rts	
0000529C                            ; End of function RandomNumber
0000529C                            
0000529C                            ; ===========================================================================
0000529C                            ; Subroutine to calculate sine and cosine
0000529C                            ; ===========================================================================
0000529C                            ; Input:	d0 - Angle (0-$FF)
0000529C                            ; Output:	d0 - Sine
0000529C                            ;		d1 - Cosine
0000529C                            ; ---------------------------------------------------------------------------
0000529C                            
0000529C                            CalcSine:
0000529C 0240 00FF                  		andi.w	#$FF,d0
000052A0 D040                       		add.w	d0,d0
000052A2 0640 0080                  		addi.w	#$80,d0
000052A6 323B 0000                  		move.w	Sine_Data(pc,d0.w),d1	; get cosine
000052AA 0440 0080                  		subi.w	#$80,d0
000052AE 303B 0000                  		move.w	Sine_Data(pc,d0.w),d0	; get sine
000052B2 4E75                       		rts	
000052B4                            
000052B4                            Sine_Data:	incbin	misc\sinewave.bin	; pre-calculated Sine values
00005534                            
00005534                            ; End of function CalcSine
00005534                            
00005534                            ; ===========================================================================
00005534                            ; Subroutine calculate an angle
00005534                            ; ===========================================================================
00005534                            ; Input:	d1 - X-axis distance
00005534                            ;		d2 - Y-axis distance
00005534                            ; Output:	d0 - Angle
00005534                            ; ---------------------------------------------------------------------------
00005534                            
00005534                            CalcAngle:
00005534 48E7 1800                  		movem.l	d3-d4,-(sp)
00005538 7600                       		moveq	#0,d3
0000553A 7800                       		moveq	#0,d4
0000553C 3601                       		move.w	d1,d3
0000553E 3802                       		move.w	d2,d4
00005540 8843                       		or.w	d3,d4
00005542 6700                       		beq.s	loc_2D04
00005544 3802                       		move.w	d2,d4
00005546 4A43                       		tst.w	d3
00005548 6A00 0000                  		bpl.w	loc_2CC2
0000554C 4443                       		neg.w	d3
0000554E                            
0000554E                            loc_2CC2:
0000554E 4A44                       		tst.w	d4
00005550 6A00 0000                  		bpl.w	loc_2CCA
00005554 4444                       		neg.w	d4
00005556                            
00005556                            loc_2CCA:
00005556 B843                       		cmp.w	d3,d4
00005558 6400 0000                  		bcc.w	loc_2CDC
0000555C E18C                       		lsl.l	#8,d4
0000555E 88C3                       		divu.w	d3,d4
00005560 7000                       		moveq	#0,d0
00005562 103B 4000                  		move.b	Angle_Data(pc,d4.w),d0
00005566 6000                       		bra.s	loc_2CE6
00005568                            ; ===========================================================================
00005568                            
00005568                            loc_2CDC:				; XREF: CalcAngle
00005568 E18B                       		lsl.l	#8,d3
0000556A 86C4                       		divu.w	d4,d3
0000556C 7040                       		moveq	#$40,d0
0000556E 903B 3000                  		sub.b	Angle_Data(pc,d3.w),d0
00005572                            
00005572                            loc_2CE6:
00005572 4A41                       		tst.w	d1
00005574 6A00 0000                  		bpl.w	loc_2CF2
00005578 4440                       		neg.w	d0
0000557A 0640 0080                  		addi.w	#$80,d0
0000557E                            
0000557E                            loc_2CF2:
0000557E 4A42                       		tst.w	d2
00005580 6A00 0000                  		bpl.w	loc_2CFE
00005584 4440                       		neg.w	d0
00005586 0640 0100                  		addi.w	#$100,d0
0000558A                            
0000558A                            loc_2CFE:
0000558A 4CDF 0018                  		movem.l	(sp)+,d3-d4
0000558E 4E75                       		rts	
00005590                            ; ===========================================================================
00005590                            
00005590                            loc_2D04:				; XREF: CalcAngle
00005590 303C 0040                  		move.w	#$40,d0
00005594 4CDF 0018                  		movem.l	(sp)+,d3-d4
00005598 4E75                       		rts	
0000559A                            ; End of function CalcAngle
0000559A                            
0000559A                            ; ===========================================================================
0000559A                            
0000559A                            Angle_Data:	incbin	misc\angles.bin
0000569C                            
0000569C                            ; ===========================================================================
0000569C                            ; ===========================================================================
0000569C                            ; ===========================================================================
0000569C                            ; SMPS Sound Driver by SEGA (improved by vladikcomper)
0000569C                            ; ===========================================================================
0000569C                            		include	"_proc\swa.smps.asm"
0000569C                            ; ===========================================================================
0000569C                            ; ---------------------------------------------------------------------------
0000569C                            ; SONIC 1 SMPS DRIVER
0000569C                            ; Mod by Vladikcomper
0000569C                            ; ---------------------------------------------------------------------------
0000569C                            ;	* Extended slots
0000569C                            ;;	* PAL tempo modifier
0000569C                            ;;	* CD Digital Audio playback
0000569C                            ;	* 4-stage sound queue
0000569C                            ;	* Mega PCM Support
0000569C                            ;	* HQ Digital audio playback
0000569C                            ; ---------------------------------------------------------------------------
0000569C                            
0000569C                            ; ---------------------------------------------------------------------------
0000569C                            ; Memory map
0000569C                            ; ---------------------------------------------------------------------------
0000569C                            
0000569C =FFFFF000                  v_snddriver_ram:  = $FFFFF000 ; start of RAM for the sound driver data
0000569C                            
0000569C =00000000                  v_sndprio:		= $000	; sound priority (priority of new music/SFX must be higher or equal to this value or it won't play; bit 7 of priority being set prevents this value from changing)
0000569C =00000001                  v_main_tempo_timeout:	= $001	; Counts down to zero; when zero, resets to next value and delays song by 1 frame
0000569C =00000002                  v_main_tempo:		= $002	; Used for music only
0000569C =00000003                  f_stopmusic:		= $003	; flag set to stop music when paused
0000569C =00000004                  v_fadeout_counter:	= $004
0000569C =00000005                  v_cda_playing		= $005	; flag stating if CDA plays
0000569C                            
0000569C =00000006                  v_fadeout_delay:	= $006
0000569C =00000007                  v_extension:		= $007
0000569C                            
0000569C =00000008                  f_updating_dac:		= $008	; $80 if updating DAC, $00 otherwise
0000569C =00000009                  v_playsnd0:		= $009	; sound or music copied from below
0000569C                            
0000569C =0000000A                  v_playqueue		= $00A	; $00A-$00D - sound queue for 4 entries
0000569C =0000000A                  v_playsnd1:		= $00A	; sound or music to play
0000569C                            ;v_playsnd2:		= $00B	; special sound to play
0000569C                            ;v_playnull:		= $00C	; unused sound to play
0000569C                            
0000569C =0000000E                  f_voice_selector:	= $00E	; $00 = use music voice pointer; $40 = use special voice pointer; $80 = use track voice pointer
0000569C =0000000F                  v_revsound:		= $00F	; revving sound effect
0000569C                            
0000569C =00000018                  v_voice_ptr:		= $018	; voice data pointer (4 bytes)
0000569C                            
0000569C =00000020                  v_special_voice_ptr:	= $020	; voice data pointer for special SFX ($D0-$DF) (4 bytes)
0000569C                            
0000569C =00000024                  f_fadein_flag:		= $024	; Flag for fade in
0000569C =00000025                  v_fadein_delay:		= $025
0000569C =00000026                  v_fadein_counter:	= $026	; Timer for fade in/out
0000569C =00000027                  f_1up_playing:		= $027	; flag indicating 1-up song is playing
0000569C =00000028                  v_tempo_mod:		= $028	; music - tempo modifier
0000569C =00000029                  v_speeduptempo:		= $029	; music - tempo modifier with speed shoes
0000569C =0000002A                  f_speedup:		= $02A	; flag indicating whether speed shoes tempo is on ($80) or off ($00)
0000569C =0000002B                  v_ring_speaker:		= $02B	; which speaker the "ring" sound is played in (00 = right; 01 = left)
0000569C =0000002C                  f_push_playing:		= $02C	; if set, prevents further push sounds from playing
0000569C                            
0000569C =00000040                  v_track_ram:		= $040	; Start of music RAM
0000569C                            
0000569C =00000040                  v_dac_track:		= $040
0000569C =00000040                  v_dac_playback_control:	= $040	; Playback control bits for DAC channel
0000569C =00000041                  v_dac_voice_control:	= $041	; Voice control bits for DAC channel
0000569C =00000042                  v_dac_tempo_time:	= $042	; music - tempo dividing timing
0000569C =00000044                  v_dac_ptr:		= $044	; DAC channel pointer (4 bytes)
0000569C =0000004A                  v_dac_amsfmspan:	= $04A
0000569C =0000004D                  v_dac_stack_ptr:	= $04D
0000569C =0000004E                  v_dac_note_timeout:	= $04E	; Counts down to zero; when zero, a new DAC sample is needed
0000569C =0000004F                  v_dac_note_duration:	= $04F
0000569C =00000050                  v_dac_curr_sample:	= $050
0000569C =00000064                  v_dac_loop_index:	= $064	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000068                  v_dac_playid		= $068	; ### New Variable
0000569C                            
0000569C                            ; Note: using the channel assignment bits to determine FM channel #. Thus, there is no FM 3.
0000569C                            
0000569C =00000070                  v_fm1_track:		= $070
0000569C =00000070                  v_fm1_playback_control:	= $070	; Playback control bits for FM1
0000569C =00000071                  v_fm1_voice_control:	= $071	; Voice control bits
0000569C =00000072                  v_fm1_tempo_time:	= $072	; music - tempo dividing timing
0000569C =00000074                  v_fm1_ptr:		= $074	; FM channel 0 pointer (4 bytes)
0000569C =00000078                  v_fm1_key:		= $078	; FM channel 0 key displacement
0000569C =00000079                  v_fm1_volume:		= $079	; FM channel 0 volume attenuation
0000569C =0000007A                  v_fm1_amsfmspan:	= $07A
0000569C =0000007B                  v_fm1_voice:		= $07B
0000569C =0000007D                  v_fm1_stack_ptr:	= $07D
0000569C =0000007E                  v_fm1_note_timeout:	= $07E	; Counts down to zero; when zero, a new note is needed
0000569C =0000007F                  v_fm1_note_duration:	= $07F
0000569C =00000080                  v_fm1_curr_note:	= $080
0000569C =00000082                  v_fm1_note_fill:	= $082
0000569C =00000083                  v_fm1_note_fill_master:	= $083
0000569C =00000084                  v_fm1_modulation_ptr:	= $084	; 4 bytes
0000569C =00000088                  v_fm1_modulation_wait:	= $088
0000569C =00000089                  v_fm1_modulation_speed:	= $089
0000569C =0000008A                  v_fm1_modulation_delta:	= $08A
0000569C =0000008B                  v_fm1_modulation_steps:	= $08B
0000569C =0000008C                  v_fm1_modulation_freq:	= $08C	; 2 bytes
0000569C =0000008E                  v_fm1_freq_adjust:	= $08E
0000569C =0000008F                  v_fm1_feedbackalgo:	= $08F
0000569C =00000094                  v_fm1_loop_index:	= $094	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =000000A0                  v_fm2_track:		= $0A0
0000569C =000000A0                  v_fm2_playback_control:	= $0A0	; Playback control bits for FM2
0000569C =000000A1                  v_fm2_voice_control:	= $0A1	; Voice control bits
0000569C =000000A2                  v_fm2_tempo_time:	= $0A2	; music - tempo dividing timing
0000569C =000000A4                  v_fm2_ptr:		= $0A4	; FM channel 1 pointer (4 bytes)
0000569C =000000A8                  v_fm2_key:		= $0A8	; FM channel 1 key displacement
0000569C =000000A9                  v_fm2_volume:		= $0A9	; FM channel 1 volume attenuation
0000569C =000000AA                  v_fm2_amsfmspan:	= $0AA
0000569C =000000AB                  v_fm2_voice:		= $0AB
0000569C =000000AD                  v_fm2_stack_ptr:	= $0AD
0000569C =000000AE                  v_fm2_note_timeout:	= $0AE	; Counts down to zero; when zero, a new note is needed
0000569C =000000AF                  v_fm2_note_duration:	= $0AF
0000569C =000000B0                  v_fm2_curr_note:	= $0B0
0000569C =000000B2                  v_fm2_note_fill:	= $0B2
0000569C =000000B3                  v_fm2_note_fill_master:	= $0B3
0000569C =000000B4                  v_fm2_modulation_ptr:	= $0B4	; 4 bytes
0000569C =000000B8                  v_fm2_modulation_wait:	= $0B8
0000569C =000000B9                  v_fm2_modulation_speed:	= $0B9
0000569C =000000BA                  v_fm2_modulation_delta:	= $0BA
0000569C =000000BB                  v_fm2_modulation_steps:	= $0BB
0000569C =000000BC                  v_fm2_modulation_freq:	= $0BC	; 2 bytes
0000569C =000000BE                  v_fm2_freq_adjust:	= $0BE
0000569C =000000BF                  v_fm2_feedbackalgo:	= $0BF
0000569C =000000C4                  v_fm2_loop_index:	= $0C4	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =000000D0                  v_fm3_track:		= $0D0
0000569C =000000D0                  v_fm3_playback_control:	= $0D0	; Playback control bits for FM3
0000569C =000000D1                  v_fm3_voice_control:	= $0D1	; Voice control bits
0000569C =000000D2                  v_fm3_tempo_time:	= $0D2	; music - tempo dividing timing
0000569C =000000D4                  v_fm3_ptr:		= $0D4	; FM channel 2 pointer (4 bytes)
0000569C =000000D8                  v_fm3_key:		= $0D8	; FM channel 2 key displacement
0000569C =000000D9                  v_fm3_volume:		= $0D9	; FM channel 2 volume attenuation
0000569C =000000DA                  v_fm3_amsfmspan:	= $0DA
0000569C =000000DB                  v_fm3_voice:		= $0DB
0000569C =000000DD                  v_fm3_stack_ptr:	= $0DD
0000569C =000000DE                  v_fm3_note_timeout:	= $0DE	; Counts down to zero; when zero, a new note is needed
0000569C =000000DF                  v_fm3_note_duration:	= $0DF
0000569C =000000E0                  v_fm3_curr_note:	= $0E0
0000569C =000000E2                  v_fm3_note_fill:	= $0E2
0000569C =000000E3                  v_fm3_note_fill_master:	= $0E3
0000569C =000000E4                  v_fm3_modulation_ptr:	= $0E4	; 4 bytes
0000569C =000000E8                  v_fm3_modulation_wait:	= $0E8
0000569C =000000E9                  v_fm3_modulation_speed:	= $0E9
0000569C =000000EA                  v_fm3_modulation_delta:	= $0EA
0000569C =000000EB                  v_fm3_modulation_steps:	= $0EB
0000569C =000000EC                  v_fm3_modulation_freq:	= $0EC	; 2 bytes
0000569C =000000EE                  v_fm3_freq_adjust:	= $0EE
0000569C =000000EF                  v_fm3_feedbackalgo:	= $0EF
0000569C =000000F4                  v_fm3_loop_index:	= $0F4	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000100                  v_fm4_track:		= $100
0000569C =00000100                  v_fm4_playback_control:	= $100	; Playback control bits for FM4
0000569C =00000101                  v_fm4_voice_control:	= $101	; Voice control bits
0000569C =00000102                  v_fm4_tempo_time:	= $102	; music - tempo dividing timing
0000569C =00000104                  v_fm4_ptr:		= $104	; FM channel 4 pointer (4 bytes)
0000569C =00000108                  v_fm4_key:		= $108	; FM channel 4 key displacement
0000569C =00000109                  v_fm4_volume:		= $109	; FM channel 4 volume attenuation
0000569C =0000010A                  v_fm4_amsfmspan:	= $10A
0000569C =0000010B                  v_fm4_voice:		= $10B
0000569C =0000010D                  v_fm4_stack_ptr:	= $10D
0000569C =0000010E                  v_fm4_note_timeout:	= $10E	; Counts down to zero; when zero, a new note is needed
0000569C =0000010F                  v_fm4_note_duration:	= $10F
0000569C =00000110                  v_fm4_curr_note:	= $110
0000569C =00000112                  v_fm4_note_fill:	= $112
0000569C =00000113                  v_fm4_note_fill_master:	= $113
0000569C =00000114                  v_fm4_modulation_ptr:	= $114	; 4 bytes
0000569C =00000118                  v_fm4_modulation_wait:	= $118
0000569C =00000119                  v_fm4_modulation_speed:	= $119
0000569C =0000011A                  v_fm4_modulation_delta:	= $11A
0000569C =0000011B                  v_fm4_modulation_steps:	= $11B
0000569C =0000011C                  v_fm4_modulation_freq:	= $11C	; 2 bytes
0000569C =0000011E                  v_fm4_freq_adjust:	= $11E
0000569C =0000011F                  v_fm4_feedbackalgo:	= $11F
0000569C =00000124                  v_fm4_loop_index:	= $124	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000130                  v_fm5_track:		= $130
0000569C =00000130                  v_fm5_playback_control:	= $130	; Playback control bits for FM5
0000569C =00000131                  v_fm5_voice_control:	= $131	; Voice control bits
0000569C =00000132                  v_fm5_tempo_time:	= $132	; music - tempo dividing timing
0000569C =00000134                  v_fm5_ptr:		= $134	; FM channel 5 pointer (4 bytes)
0000569C =00000138                  v_fm5_key:		= $138	; FM channel 5 key displacement
0000569C =00000139                  v_fm5_volume:		= $139	; FM channel 5 volume attenuation
0000569C =0000013A                  v_fm5_amsfmspan:	= $13A
0000569C =0000013B                  v_fm5_voice:		= $13B
0000569C =0000013D                  v_fm5_stack_ptr:	= $13D
0000569C =0000013E                  v_fm5_note_timeout:	= $13E	; Counts down to zero; when zero, a new note is needed
0000569C =0000013F                  v_fm5_note_duration:	= $13F
0000569C =00000140                  v_fm5_curr_note:	= $140
0000569C =00000142                  v_fm5_note_fill:	= $142
0000569C =00000143                  v_fm5_note_fill_master:	= $143
0000569C =00000144                  v_fm5_modulation_ptr:	= $144	; 4 bytes
0000569C =00000148                  v_fm5_modulation_wait:	= $148
0000569C =00000149                  v_fm5_modulation_speed:	= $149
0000569C =0000014A                  v_fm5_modulation_delta:	= $14A
0000569C =0000014B                  v_fm5_modulation_steps:	= $14B
0000569C =0000014C                  v_fm5_modulation_freq:	= $14C	; 2 bytes
0000569C =0000014E                  v_fm5_freq_adjust:	= $14E
0000569C =0000014F                  v_fm5_feedbackalgo:	= $14F
0000569C =00000154                  v_fm5_loop_index:	= $154	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000160                  v_fm6_track:		= $160
0000569C =00000160                  v_fm6_playback_control:	= $160	; Playback control bits for FM6
0000569C =00000161                  v_fm6_voice_control:	= $161	; Voice control bits
0000569C =00000162                  v_fm6_tempo_time:	= $162	; music - tempo dividing timing
0000569C =00000164                  v_fm6_ptr:		= $164	; FM channel 6 pointer (4 bytes)
0000569C =00000168                  v_fm6_key:		= $168	; FM channel 6 key displacement
0000569C =00000169                  v_fm6_volume:		= $169	; FM channel 6 volume attenuation
0000569C =0000016A                  v_fm6_amsfmspan:	= $16A
0000569C =0000016B                  v_fm6_voice:		= $16B
0000569C =0000016D                  v_fm6_stack_ptr:	= $16D
0000569C =0000016E                  v_fm6_note_timeout:	= $16E	; Counts down to zero; when zero, a new note is needed
0000569C =0000016F                  v_fm6_note_duration:	= $16F
0000569C =00000170                  v_fm6_curr_note:	= $170
0000569C =00000172                  v_fm6_note_fill:	= $172
0000569C =00000173                  v_fm6_note_fill_master:	= $173
0000569C =00000174                  v_fm6_modulation_ptr:	= $174	; 4 bytes
0000569C =00000178                  v_fm6_modulation_wait:	= $178
0000569C =00000179                  v_fm6_modulation_speed:	= $179
0000569C =0000017A                  v_fm6_modulation_delta:	= $17A
0000569C =0000017B                  v_fm6_modulation_steps:	= $17B
0000569C =0000017C                  v_fm6_modulation_freq:	= $17C	; 2 bytes
0000569C =0000017E                  v_fm6_freq_adjust:	= $17E
0000569C =0000017F                  v_fm6_feedbackalgo:	= $17F
0000569C =00000184                  v_fm6_loop_index:	= $184	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000190                  v_psg1_track:		= $190
0000569C =00000190                  v_psg1_playback_control:= $190	; Playback control bits for PSG1
0000569C =00000191                  v_psg1_voice_control:	= $191	; Voice control bits
0000569C =00000192                  v_psg1_tempo_time:	= $192	; music - tempo dividing timing
0000569C =00000194                  v_psg1_ptr:		= $194	; PSG channel 1 pointer (4 bytes)
0000569C =00000198                  v_psg1_key:		= $198	; PSG channel 1 key displacement
0000569C =00000199                  v_psg1_volume:		= $199	; PSG channel 1 volume attenuation
0000569C =0000019A                  v_psg1_amsfmspan:	= $19A
0000569C =0000019B                  v_psg1_tone:		= $19B
0000569C =0000019C                  v_psg1_flutter_index:	= $19C
0000569C =0000019D                  v_psg1_stack_ptr:	= $19D
0000569C =0000019E                  v_psg1_note_timeout:	= $19E	; Counts down to zero; when zero, a new note is needed
0000569C =0000019F                  v_psg1_note_duration:	= $19F
0000569C =000001A0                  v_psg1_curr_note:	= $1A0
0000569C =000001A2                  v_psg1_note_fill:	= $1A2
0000569C =000001A3                  v_psg1_note_fill_master:= $1A3
0000569C =000001A4                  v_psg1_modulation_ptr:	= $1A4	; 4 bytes
0000569C =000001A8                  v_psg1_modulation_wait:	= $1A8
0000569C =000001A9                  v_psg1_modulation_speed:= $1A9
0000569C =000001AA                  v_psg1_modulation_delta:= $1AA
0000569C =000001AB                  v_psg1_modulation_steps:= $1AB
0000569C =000001AC                  v_psg1_modulation_freq:	= $1AC	; 2 bytes
0000569C =000001AE                  v_psg1_freq_adjust:	= $1AE
0000569C =000001AF                  v_psg1_noise:		= $1AF
0000569C =000001B4                  v_psg1_loop_index:	= $1B4	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =000001C0                  v_psg2_track:		= $1C0
0000569C =000001C0                  v_psg2_playback_control:= $1C0	; Playback control bits for PSG2
0000569C =000001C1                  v_psg2_voice_control:	= $1C1	; Voice control bits
0000569C =000001C2                  v_psg2_tempo_time:	= $1C2	; music - tempo dividing timing
0000569C =000001C4                  v_psg2_ptr:		= $1C4	; PSG channel 2 pointer (4 bytes)
0000569C =000001C8                  v_psg2_key:		= $1C8	; PSG channel 2 key displacement
0000569C =000001C9                  v_psg2_volume:		= $1C9	; PSG channel 2 volume attenuation
0000569C =000001CA                  v_psg2_amsfmspan:	= $1CA
0000569C =000001CB                  v_psg2_tone:		= $1CB
0000569C =000001CC                  v_psg2_flutter_index:	= $1CC
0000569C =000001CD                  v_psg2_stack_ptr:	= $1CD
0000569C =000001CE                  v_psg2_note_timeout:	= $1CE	; Counts down to zero; when zero, a new note is needed
0000569C =000001CF                  v_psg2_note_duration:	= $1CF
0000569C =000001D0                  v_psg2_curr_note:	= $1D0
0000569C =000001D2                  v_psg2_note_fill:	= $1D2
0000569C =000001D3                  v_psg2_note_fill_master:= $1D3
0000569C =000001D4                  v_psg2_modulation_ptr:	= $1D4	; 4 bytes
0000569C =000001D8                  v_psg2_modulation_wait:	= $1D8
0000569C =000001D9                  v_psg2_modulation_speed:= $1D9
0000569C =000001DA                  v_psg2_modulation_delta:= $1DA
0000569C =000001DB                  v_psg2_modulation_steps:= $1DB
0000569C =000001DC                  v_psg2_modulation_freq:	= $1DC	; 2 bytes
0000569C =000001DE                  v_psg2_freq_adjust:	= $1DE
0000569C =000001DF                  v_psg2_noise:		= $1DF
0000569C =000001E4                  v_psg2_loop_index:	= $1E4	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =000001F0                  v_psg3_track:		= $1F0
0000569C =000001F0                  v_psg3_playback_control:= $1F0	; Playback control bits for PSG3
0000569C =000001F1                  v_psg3_voice_control:	= $1F1	; Voice control bits
0000569C =000001F2                  v_psg3_tempo_time:	= $1F2	; music - tempo dividing timing
0000569C =000001F4                  v_psg3_ptr:		= $1F4	; PSG channel 3 pointer (4 bytes)
0000569C =000001F8                  v_psg3_key:		= $1F8	; PSG channel 3 key displacement
0000569C =000001F9                  v_psg3_volume:		= $1F9	; PSG channel 3 volume attenuation
0000569C =000001FA                  v_psg3_amsfmspan:	= $1FA
0000569C =000001FB                  v_psg3_tone:		= $1FB
0000569C =000001FC                  v_psg3_flutter_index:	= $1FC
0000569C =000001FD                  v_psg3_stack_ptr:	= $1FD
0000569C =000001FE                  v_psg3_note_timeout:	= $1FE	; Counts down to zero; when zero, a new note is needed
0000569C =000001FF                  v_psg3_note_duration:	= $1FF
0000569C =00000200                  v_psg3_curr_note:	= $200
0000569C =00000202                  v_psg3_note_fill:	= $202
0000569C =00000203                  v_psg3_note_fill_master:= $203
0000569C =00000204                  v_psg3_modulation_ptr:	= $204	; 4 bytes
0000569C =00000208                  v_psg3_modulation_wait:	= $208
0000569C =00000209                  v_psg3_modulation_speed:= $209
0000569C =0000020A                  v_psg3_modulation_delta:= $20A
0000569C =0000020B                  v_psg3_modulation_steps:= $20B
0000569C =0000020C                  v_psg3_modulation_freq:	= $20C	; 2 bytes
0000569C =0000020E                  v_psg3_freq_adjust:	= $20E
0000569C =0000020F                  v_psg3_noise:		= $20F
0000569C =00000214                  v_psg3_loop_index:	= $214	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000220                  v_sfx_track_ram:	= $220	; Start of sfx RAM
0000569C                            
0000569C =00000220                  v_sfx_fm3_track:	= $220
0000569C =00000220                  v_sfx_fm3_playback_control:	= $220	; Playback control bits for sfx FM3
0000569C =00000221                  v_sfx_fm3_voice_control:	= $221	; Voice control bits
0000569C =00000222                  v_sfx_fm3_tempo_time:	= $222	; sfx - tempo dividing timing
0000569C =00000224                  v_sfx_fm3_ptr:		= $224	; FM channel 2 pointer (4 bytes)
0000569C =00000228                  v_sfx_fm3_key:		= $228	; FM channel 2 key displacement
0000569C =00000229                  v_sfx_fm3_volume:	= $229	; FM channel 2 volume attenuation
0000569C =0000022A                  v_sfx_fm3_amsfmspan:	= $22A
0000569C =0000022B                  v_sfx_fm3_voice:	= $22B
0000569C =0000022D                  v_sfx_fm3_stack_ptr:	= $22D
0000569C =0000022E                  v_sfx_fm3_note_timeout:	= $22E	; Counts down to zero; when zero, a new note is needed
0000569C =0000022F                  v_sfx_fm3_note_duration:	= $22F
0000569C =00000230                  v_sfx_fm3_curr_note:	= $230
0000569C =00000232                  v_sfx_fm3_note_fill:	= $232
0000569C =00000233                  v_sfx_fm3_note_fill_master:	= $233
0000569C =00000234                  v_sfx_fm3_modulation_ptr:	= $234	; 4 bytes
0000569C =00000238                  v_sfx_fm3_modulation_wait:	= $238
0000569C =00000239                  v_sfx_fm3_modulation_speed:	= $239
0000569C =0000023A                  v_sfx_fm3_modulation_delta:	= $23A
0000569C =0000023B                  v_sfx_fm3_modulation_steps:	= $23B
0000569C =0000023C                  v_sfx_fm3_modulation_freq:	= $23C	; 2 bytes
0000569C =0000023E                  v_sfx_fm3_freq_adjust:	= $23E
0000569C =0000023F                  v_sfx_fm3_feedbackalgo:	= $23F
0000569C =00000240                  v_sfx_fm3_voice_ptr:	= $240
0000569C =00000244                  v_sfx_fm3_loop_index:	= $244	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000250                  v_sfx_fm4_track:	= $250
0000569C =00000250                  v_sfx_fm4_playback_control:	= $250	; Playback control bits for sfx FM4
0000569C =00000251                  v_sfx_fm4_voice_control:	= $251	; Voice control bits
0000569C =00000252                  v_sfx_fm4_tempo_time:	= $252	; sfx - tempo dividing timing
0000569C =00000254                  v_sfx_fm4_ptr:		= $254	; FM channel 4 pointer (4 bytes)
0000569C =00000258                  v_sfx_fm4_key:		= $258	; FM channel 4 key displacement
0000569C =00000259                  v_sfx_fm4_volume:	= $259	; FM channel 4 volume attenuation
0000569C =0000025A                  v_sfx_fm4_amsfmspan:	= $25A
0000569C =0000025B                  v_sfx_fm4_voice:	= $25B
0000569C =0000025D                  v_sfx_fm4_stack_ptr:	= $25D
0000569C =0000025E                  v_sfx_fm4_note_timeout:	= $25E	; Counts down to zero; when zero, a new note is needed
0000569C =0000025F                  v_sfx_fm4_note_duration:	= $25F
0000569C =00000260                  v_sfx_fm4_curr_note:	= $260
0000569C =00000262                  v_sfx_fm4_note_fill:	= $262
0000569C =00000263                  v_sfx_fm4_note_fill_master:	= $263
0000569C =00000264                  v_sfx_fm4_modulation_ptr:	= $264	; 4 bytes
0000569C =00000268                  v_sfx_fm4_modulation_wait:	= $268
0000569C =00000269                  v_sfx_fm4_modulation_speed:	= $269
0000569C =0000026A                  v_sfx_fm4_modulation_delta:	= $26A
0000569C =0000026B                  v_sfx_fm4_modulation_steps:	= $26B
0000569C =0000026C                  v_sfx_fm4_modulation_freq:	= $26C	; 2 bytes
0000569C =0000026E                  v_sfx_fm4_freq_adjust:	= $26E
0000569C =0000026F                  v_sfx_fm4_feedbackalgo:	= $26F
0000569C =00000270                  v_sfx_fm4_voice_ptr:	= $270
0000569C =00000274                  v_sfx_fm4_loop_index:	= $274	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000280                  v_sfx_fm5_track:	= $280
0000569C =00000280                  v_sfx_fm5_playback_control:	= $280	; Playback control bits for sfx FM5
0000569C =00000281                  v_sfx_fm5_voice_control:	= $281	; Voice control bits
0000569C =00000282                  v_sfx_fm5_tempo_time:	= $282	; sfx - tempo dividing timing
0000569C =00000284                  v_sfx_fm5_ptr:	= $284	; FM channel 5 pointer (4 bytes)
0000569C =00000288                  v_sfx_fm5_key:	= $288	; FM channel 5 key displacement
0000569C =00000289                  v_sfx_fm5_volume:	= $289	; FM channel 5 volume attenuation
0000569C =0000028A                  v_sfx_fm5_amsfmspan:	= $28A
0000569C =0000028B                  v_sfx_fm5_voice:	= $28B
0000569C =0000028D                  v_sfx_fm5_stack_ptr:	= $28D
0000569C =0000028E                  v_sfx_fm5_note_timeout:	= $28E	; Counts down to zero; when zero, a new note is needed
0000569C =0000028F                  v_sfx_fm5_note_duration:	= $28F
0000569C =00000290                  v_sfx_fm5_curr_note:	= $290
0000569C =00000292                  v_sfx_fm5_note_fill:	= $292
0000569C =00000293                  v_sfx_fm5_note_fill_master:	= $293
0000569C =00000294                  v_sfx_fm5_modulation_ptr:	= $294	; 4 bytes
0000569C =00000298                  v_sfx_fm5_modulation_wait:	= $298
0000569C =00000299                  v_sfx_fm5_modulation_speed:	= $299
0000569C =0000029A                  v_sfx_fm5_modulation_delta:	= $29A
0000569C =0000029B                  v_sfx_fm5_modulation_steps:	= $29B
0000569C =0000029C                  v_sfx_fm5_modulation_freq:	= $29C	; 2 bytes
0000569C =0000029E                  v_sfx_fm5_freq_adjust:	= $29E
0000569C =0000029F                  v_sfx_fm5_feedbackalgo:	= $29F
0000569C =000002A0                  v_sfx_fm5_voice_ptr:	= $2A0
0000569C =000002A4                  v_sfx_fm5_loop_index:	= $2A4	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =000002B0                  v_sfx_psg1_track:	= $2B0
0000569C =000002B0                  v_sfx_psg1_playback_control:	= $2B0	; Playback control bits for sfx PSG1
0000569C =000002B1                  v_sfx_psg1_voice_control:	= $2B1	; Voice control bits
0000569C =000002B2                  v_sfx_psg1_tempo_time:	= $2B2	; sfx - tempo dividing timing
0000569C =000002B4                  v_sfx_psg1_ptr:	= $2B4	; PSG channel 1 pointer (4 bytes)
0000569C =000002B8                  v_sfx_psg1_key:	= $2B8	; PSG channel 1 key displacement
0000569C =000002B9                  v_sfx_psg1_volume:	= $2B9	; PSG channel 1 volume attenuation
0000569C =000002BA                  v_sfx_psg1_amsfmspan:	= $2BA
0000569C =000002BB                  v_sfx_psg1_tone:	= $2BB
0000569C =000002BC                  v_sfx_psg1_flutter_index:	= $2BC
0000569C =000002BD                  v_sfx_psg1_stack_ptr:	= $2BD
0000569C =000002BE                  v_sfx_psg1_note_timeout:	= $2BE	; Counts down to zero; when zero, a new note is needed
0000569C =000002BF                  v_sfx_psg1_note_duration:	= $2BF
0000569C =000002C0                  v_sfx_psg1_curr_note:	= $2C0
0000569C =000002C2                  v_sfx_psg1_note_fill:	= $2C2
0000569C =000002C3                  v_sfx_psg1_note_fill_master:	= $2C3
0000569C =000002C4                  v_sfx_psg1_modulation_ptr:	= $2C4	; 4 bytes
0000569C =000002C8                  v_sfx_psg1_modulation_wait:	= $2C8
0000569C =000002C9                  v_sfx_psg1_modulation_speed:	= $2C9
0000569C =000002CA                  v_sfx_psg1_modulation_delta:	= $2CA
0000569C =000002CB                  v_sfx_psg1_modulation_steps:	= $2CB
0000569C =000002CC                  v_sfx_psg1_modulation_freq:	= $2CC	; 2 bytes
0000569C =000002CE                  v_sfx_psg1_freq_adjust:	= $2CE
0000569C =000002CF                  v_sfx_psg1_noise:	= $2CF
0000569C =000002D4                  v_sfx_psg1_loop_index:	= $2D4	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =000002E0                  v_sfx_psg2_track:	= $2E0
0000569C =000002E0                  v_sfx_psg2_playback_control:	= $2E0	; Playback control bits for sfx PSG2
0000569C =000002E1                  v_sfx_psg2_voice_control:	= $2E1	; Voice control bits
0000569C =000002E2                  v_sfx_psg2_tempo_time:	= $2E2	; sfx - tempo dividing timing
0000569C =000002E4                  v_sfx_psg2_ptr:	= $2E4	; PSG channel 2 pointer (4 bytes)
0000569C =000002E8                  v_sfx_psg2_key:	= $2E8	; PSG channel 2 key displacement
0000569C =000002E9                  v_sfx_psg2_volume:	= $2E9	; PSG channel 2 volume attenuation
0000569C =000002EA                  v_sfx_psg2_amsfmspan:	= $2EA
0000569C =000002EB                  v_sfx_psg2_tone:	= $2EB
0000569C =000002EC                  v_sfx_psg2_flutter_index:	= $2EC
0000569C =000002ED                  v_sfx_psg2_stack_ptr:	= $2ED
0000569C =000002EE                  v_sfx_psg2_note_timeout:	= $2EE	; Counts down to zero; when zero, a new note is needed
0000569C =000002EF                  v_sfx_psg2_note_duration:	= $2EF
0000569C =000002F0                  v_sfx_psg2_curr_note:	= $2F0
0000569C =000002F2                  v_sfx_psg2_note_fill:	= $2F2
0000569C =000002F3                  v_sfx_psg2_note_fill_master:	= $2F3
0000569C =000002F4                  v_sfx_psg2_modulation_ptr:	= $2F4	; 4 bytes
0000569C =000002F8                  v_sfx_psg2_modulation_wait:	= $2F8
0000569C =000002F9                  v_sfx_psg2_modulation_speed:	= $2F9
0000569C =000002FA                  v_sfx_psg2_modulation_delta:	= $2FA
0000569C =000002FB                  v_sfx_psg2_modulation_steps:	= $2FB
0000569C =000002FC                  v_sfx_psg2_modulation_freq:	= $2FC	; 2 bytes
0000569C =000002FE                  v_sfx_psg2_freq_adjust:	= $2FE
0000569C =000002FF                  v_sfx_psg2_noise:	= $2FF
0000569C =00000304                  v_sfx_psg2_loop_index:	= $304	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000310                  v_sfx_psg3_track:	= $310
0000569C =00000310                  v_sfx_psg3_playback_control:	= $310	; Playback control bits for sfx PSG3
0000569C =00000311                  v_sfx_psg3_voice_control:	= $311	; Voice control bits
0000569C =00000312                  v_sfx_psg3_tempo_time:	= $312	; sfx - tempo dividing timing
0000569C =00000314                  v_sfx_psg3_ptr:	= $314	; PSG channel 3 pointer (4 bytes)
0000569C =00000318                  v_sfx_psg3_key:	= $318	; PSG channel 3 key displacement
0000569C =00000319                  v_sfx_psg3_volume:	= $319	; PSG channel 3 volume attenuation
0000569C =0000031A                  v_sfx_psg3_amsfmspan:	= $31A
0000569C =0000031B                  v_sfx_psg3_tone:	= $31B
0000569C =0000031C                  v_sfx_psg3_flutter_index:	= $31C
0000569C =0000031D                  v_sfx_psg3_stack_ptr:	= $31D
0000569C =0000031E                  v_sfx_psg3_note_timeout:	= $31E	; Counts down to zero; when zero, a new note is needed
0000569C =0000031F                  v_sfx_psg3_note_duration:	= $31F
0000569C =00000320                  v_sfx_psg3_curr_note:	= $320
0000569C =00000322                  v_sfx_psg3_note_fill:	= $322
0000569C =00000323                  v_sfx_psg3_note_fill_master:	= $323
0000569C =00000324                  v_sfx_psg3_modulation_ptr:	= $324	; 4 bytes
0000569C =00000328                  v_sfx_psg3_modulation_wait:	= $328
0000569C =00000329                  v_sfx_psg3_modulation_speed:	= $329
0000569C =0000032A                  v_sfx_psg3_modulation_delta:	= $32A
0000569C =0000032B                  v_sfx_psg3_modulation_steps:	= $32B
0000569C =0000032C                  v_sfx_psg3_modulation_freq:	= $32C	; 2 bytes
0000569C =0000032E                  v_sfx_psg3_freq_adjust:	= $32E
0000569C =0000032F                  v_sfx_psg3_noise:	= $32F
0000569C =00000334                  v_sfx_psg3_loop_index:	= $334	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000340                  v_sfx2_track_ram:	= $340	; Start of special sfx RAM
0000569C                            
0000569C =00000340                  v_sfx2_fm4_track:	= $340
0000569C =00000340                  v_sfx2_fm4_playback_control:	= $340	; Playback control bits for sfx FM4
0000569C =00000341                  v_sfx2_fm4_voice_control:	= $341	; Voice control bits
0000569C =00000342                  v_sfx2_fm4_tempo_time:	= $342	; sfx - tempo dividing timing
0000569C =00000344                  v_sfx2_fm4_ptr:	= $344	; FM channel 4 pointer (4 bytes)
0000569C =00000348                  v_sfx2_fm4_key:	= $348	; FM channel 4 key displacement
0000569C =00000349                  v_sfx2_fm4_volume:	= $349	; FM channel 4 volume attenuation
0000569C =0000034A                  v_sfx2_fm4_amsfmspan:	= $34A
0000569C =0000034B                  v_sfx2_fm4_voice:	= $34B
0000569C =0000034D                  v_sfx2_fm4_stack_ptr:	= $34D
0000569C =0000034E                  v_sfx2_fm4_note_timeout:	= $34E	; Counts down to zero; when zero, a new note is needed
0000569C =0000034F                  v_sfx2_fm4_note_duration:	= $34F
0000569C =00000350                  v_sfx2_fm4_curr_note:	= $350
0000569C =00000352                  v_sfx2_fm4_note_fill:	= $352
0000569C =00000353                  v_sfx2_fm4_note_fill_master:	= $353
0000569C =00000354                  v_sfx2_fm4_modulation_ptr:	= $354	; 4 bytes
0000569C =00000358                  v_sfx2_fm4_modulation_wait:	= $358
0000569C =00000359                  v_sfx2_fm4_modulation_speed:	= $359
0000569C =0000035A                  v_sfx2_fm4_modulation_delta:	= $35A
0000569C =0000035B                  v_sfx2_fm4_modulation_steps:	= $35B
0000569C =0000035C                  v_sfx2_fm4_modulation_freq:	= $35C	; 2 bytes
0000569C =0000035E                  v_sfx2_fm4_freq_adjust:	= $35E
0000569C =0000035F                  v_sfx2_fm4_feedbackalgo:	= $35F
0000569C =00000360                  v_sfx2_fm4_voice_ptr:	= $360
0000569C =00000364                  v_sfx2_fm4_loop_index:	= $364	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =00000370                  v_sfx2_psg3_track:	= $370
0000569C =00000370                  v_sfx2_psg3_playback_control:	= $370	; Playback control bits for sfx PSG3
0000569C =00000371                  v_sfx2_psg3_voice_control:	= $371	; Voice control bits
0000569C =00000372                  v_sfx2_psg3_tempo_time:	= $372	; sfx - tempo dividing timing
0000569C =00000374                  v_sfx2_psg3_ptr:	= $374	; PSG channel 3 pointer (4 bytes)
0000569C =00000378                  v_sfx2_psg3_key:	= $378	; PSG channel 3 key displacement
0000569C =00000379                  v_sfx2_psg3_volume:	= $379	; PSG channel 3 volume attenuation
0000569C =0000037A                  v_sfx2_psg3_amsfmspan:	= $37A
0000569C =0000037B                  v_sfx2_psg3_tone:	= $37B
0000569C =0000037C                  v_sfx2_psg3_flutter_index:	= $37C
0000569C =0000037D                  v_sfx2_psg3_stack_ptr:	= $37D
0000569C =0000037E                  v_sfx2_psg3_note_timeout:	= $37E	; Counts down to zero; when zero, a new note is needed
0000569C =0000037F                  v_sfx2_psg3_note_duration:	= $37F
0000569C =00000380                  v_sfx2_psg3_curr_note:	= $380
0000569C =00000382                  v_sfx2_psg3_note_fill:	= $382
0000569C =00000383                  v_sfx2_psg3_note_fill_master:	= $383
0000569C =00000384                  v_sfx2_psg3_modulation_ptr:	= $384	; 4 bytes
0000569C =00000388                  v_sfx2_psg3_modulation_wait:	= $388
0000569C =00000389                  v_sfx2_psg3_modulation_speed:	= $389
0000569C =0000038A                  v_sfx2_psg3_modulation_delta:	= $38A
0000569C =0000038B                  v_sfx2_psg3_modulation_steps:	= $38B
0000569C =0000038C                  v_sfx2_psg3_modulation_freq:	= $38C	; 2 bytes
0000569C =0000038E                  v_sfx2_psg3_freq_adjust:	= $38E
0000569C =0000038F                  v_sfx2_psg3_noise:	= $38F
0000569C =00000394                  v_sfx2_psg3_loop_index:	= $394	; Several bytes, may overlap with gosub/return stack
0000569C                            
0000569C =000003A0                  v_1up_ram_copy:	= $3A0
0000569C                            
0000569C =000003CA                  f_fastmusic:	= $3CA	; flag set to speed up the music (00 = normal; 80 = fast)
0000569C                            
0000569C                            ;Consts
0000569C =00C00011                  PSG: 		equ $C00011
0000569C =00000030                  zTrackSz:	equ $30
0000569C                            
0000569C                            ; Sound effects
0000569C                            sfx_Jump:	equ ((ptr_sndA0-SoundIndex)/4)+$A0
0000569C                            sfx_Lamppost:	equ ((ptr_sndA1-SoundIndex)/4)+$A0
0000569C                            sfx_A2:		equ ((ptr_sndA2-SoundIndex)/4)+$A0
0000569C                            sfx_Death:	equ ((ptr_sndA3-SoundIndex)/4)+$A0
0000569C                            sfx_Skid:	equ ((ptr_sndA4-SoundIndex)/4)+$A0
0000569C                            sfx_A5:		equ ((ptr_sndA5-SoundIndex)/4)+$A0
0000569C                            sfx_HitSpikes:	equ ((ptr_sndA6-SoundIndex)/4)+$A0
0000569C                            sfx_Push:	equ ((ptr_sndA7-SoundIndex)/4)+$A0
0000569C                            sfx_SSGoal:	equ ((ptr_sndA8-SoundIndex)/4)+$A0
0000569C                            sfx_SSItem:	equ ((ptr_sndA9-SoundIndex)/4)+$A0
0000569C                            sfx_Splash:	equ ((ptr_sndAA-SoundIndex)/4)+$A0
0000569C                            sfx_AB:		equ ((ptr_sndAB-SoundIndex)/4)+$A0
0000569C                            sfx_HitBoss:	equ ((ptr_sndAC-SoundIndex)/4)+$A0
0000569C                            sfx_Bubble:	equ ((ptr_sndAD-SoundIndex)/4)+$A0
0000569C                            sfx_Fireball:	equ ((ptr_sndAE-SoundIndex)/4)+$A0
0000569C                            sfx_Shield:	equ ((ptr_sndAF-SoundIndex)/4)+$A0
0000569C                            sfx_Saw:	equ ((ptr_sndB0-SoundIndex)/4)+$A0
0000569C                            sfx_Electric:	equ ((ptr_sndB1-SoundIndex)/4)+$A0
0000569C                            sfx_Drown:	equ ((ptr_sndB2-SoundIndex)/4)+$A0
0000569C                            sfx_Flamethrower:equ ((ptr_sndB3-SoundIndex)/4)+$A0
0000569C                            sfx_Bumper:	equ ((ptr_sndB4-SoundIndex)/4)+$A0
0000569C                            sfx_Ring:	equ ((ptr_sndB5-SoundIndex)/4)+$A0
0000569C                            sfx_SpikesMove:	equ ((ptr_sndB6-SoundIndex)/4)+$A0
0000569C                            sfx_Rumbling:	equ ((ptr_sndB7-SoundIndex)/4)+$A0
0000569C                            sfx_B8:		equ ((ptr_sndB8-SoundIndex)/4)+$A0
0000569C                            sfx_Collapse:	equ ((ptr_sndB9-SoundIndex)/4)+$A0
0000569C                            sfx_SSGlass:	equ ((ptr_sndBA-SoundIndex)/4)+$A0
0000569C                            sfx_Door:	equ ((ptr_sndBB-SoundIndex)/4)+$A0
0000569C                            sfx_Teleport:	equ ((ptr_sndBC-SoundIndex)/4)+$A0
0000569C                            sfx_ChainStomp:	equ ((ptr_sndBD-SoundIndex)/4)+$A0
0000569C                            sfx_Roll:	equ ((ptr_sndBE-SoundIndex)/4)+$A0
0000569C                            sfx_Continue:	equ ((ptr_sndBF-SoundIndex)/4)+$A0
0000569C                            sfx_Basaran:	equ ((ptr_sndC0-SoundIndex)/4)+$A0
0000569C                            sfx_BreakItem:	equ ((ptr_sndC1-SoundIndex)/4)+$A0
0000569C                            sfx_Warning:	equ ((ptr_sndC2-SoundIndex)/4)+$A0
0000569C                            sfx_GiantRing:	equ ((ptr_sndC3-SoundIndex)/4)+$A0
0000569C                            sfx_Bomb:	equ ((ptr_sndC4-SoundIndex)/4)+$A0
0000569C                            sfx_Cash:	equ ((ptr_sndC5-SoundIndex)/4)+$A0
0000569C                            sfx_RingLoss:	equ ((ptr_sndC6-SoundIndex)/4)+$A0
0000569C                            sfx_ChainRise:	equ ((ptr_sndC7-SoundIndex)/4)+$A0
0000569C                            sfx_Burning:	equ ((ptr_sndC8-SoundIndex)/4)+$A0
0000569C                            sfx_Bonus:	equ ((ptr_sndC9-SoundIndex)/4)+$A0
0000569C                            sfx_EnterSS:	equ ((ptr_sndCA-SoundIndex)/4)+$A0
0000569C                            sfx_WallSmash:	equ ((ptr_sndCB-SoundIndex)/4)+$A0
0000569C                            sfx_Spring:	equ ((ptr_sndCC-SoundIndex)/4)+$A0
0000569C                            sfx_Switch:	equ ((ptr_sndCD-SoundIndex)/4)+$A0
0000569C                            sfx_RingLeft:	equ ((ptr_sndCE-SoundIndex)/4)+$A0
0000569C                            sfx_Signpost:	equ ((ptr_sndCF-SoundIndex)/4)+$A0
0000569C =000000D0                  sfx_Waterfall:	equ $D0
0000569C =000000E1                  sfx_Sega:	equ $E1
0000569C                            
0000569C =0000009F                  bgm_ExtraLife	equ	$9F
0000569C                            
0000569C                            ; ---------------------------------------------------------------------------
0000569C 0000 0000                  Go_SoundPriorities:	dc.l SoundPriorities
000056A0 0000 0000                  Go_SoundD0:		dc.l ptr_sndD0
000056A4 0000 0000                  Go_MusicIndex:		dc.l MusicIndex
000056A8 0000 0000                  Go_MusicIndex2:		dc.l MusicIndex2
000056AC 0000 0000                  Go_SoundIndex:		dc.l SoundIndex
000056B0 0000 0000                  Go_SpeedUpIndex:	dc.l SpeedUpIndex
000056B4 0000 0000                  Go_PSGIndex:		dc.l PSG_Index
000056B8                            
000056B8                            ; ---------------------------------------------------------------------------
000056B8                            ; PSG instruments used in music
000056B8                            ; ---------------------------------------------------------------------------
000056B8                            
000056B8                            PSG_Index:
000056B8 0000 0000 0000 0000 0000+  		dc.l PSG1, PSG2, PSG3
000056C4 0000 0000 0000 0000 0000+  		dc.l PSG4, PSG5, PSG6
000056D0 0000 0000 0000 0000 0000+  		dc.l PSG7, PSG8, PSG9
000056DC                            PSG1:		incbin	"sound/psg1.bin"
000056F3                            PSG2:		incbin	"sound/psg2.bin"
000056FA                            PSG3:		incbin	"sound/psg3.bin"
0000570B                            PSG4:		incbin	"sound/psg4.bin"
00005716                            PSG6:		incbin	"sound/psg6.bin"
00005725                            PSG5:		incbin	"sound/psg5.bin"
0000574F                            PSG7:		incbin	"sound/psg7.bin"
0000576B                            PSG8:		incbin	"sound/psg8.bin"
00005793                            PSG9:		incbin	"sound/psg9.bin"
000057A4                            
000057A4                            ; ---------------------------------------------------------------------------
000057A4                            ; New tempos for songs during speed shoes
000057A4                            ; ---------------------------------------------------------------------------
000057A4                            ; DANGER! several songs will use the first few bytes of MusicIndex as their main
000057A4                            ; tempos while speed shoes are active. If you don't want that, you should add
000057A4                            ; their "correct" sped-up main tempos to the list.
000057A4                            ; ---------------------------------------------------------------------------
000057A4                            
000057A4 0772 7326 1508 FF05        SpeedUpIndex:	dc.b 7,	$72, $73, $26, $15, 8, $FF, 5
000057AC                            
000057AC                            ; ---------------------------------------------------------------------------
000057AC                            ; Priority of sound. New music or SFX must have a priority higher than or equal
000057AC                            ; to what is stored in v_sndprio or it won't play. If bit 7 of new priority is
000057AC                            ; set ($80 and up), the new music or SFX will not set its priority -- meaning
000057AC                            ; any music or SFX can override it (as long as it can override whatever was
000057AC                            ; playing before). Usually, SFX will only override SFX, special SFX ($D0-$DF)
000057AC                            ; will only override special SFX and music will only override music.
000057AC                            ; ---------------------------------------------------------------------------
000057AC                            
000057AC                            SoundPriorities:
000057AC 9090 9090 9090 9090 9090+  		dc.b     $90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90	; $80+
000057BB 9090 9090 9090 9090 9090+  		dc.b $90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90	; $90+
000057CB 8070 7070 7070 7070 7070+  		dc.b $80,$70,$70,$70,$70,$70,$70,$70,$70,$70,$68,$70,$70,$70,$60,$70	; $A0+
000057DB 7060 7060 7070 7070 7070+  		dc.b $70,$60,$70,$60,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70,$7F	; $B0+
000057EB 6070 7070 7070 7070 7070+  		dc.b $60,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70,$70	; $C0+
000057FB 8080 8080 8080 8080 8080+  		dc.b $80,$80,$80,$80,$80,$80,$80,$80,$80,$80,$80,$80,$80,$80,$80,$80	; $D0+
0000580B 9090 9090 9090 9090 9090+  		dc.b $90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90	; $E0+
0000581B 9090 9090 9090 9090 9090+  		dc.b $90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90,$90	; $F0+
0000582C 00                         		even
0000582C                            		
0000582C                            ; ===========================================================================
0000582C                            ; Several subroutines from Sonic 1
0000582C                            ; ===========================================================================
0000582C                            ; ---------------------------------------------------------------------------
0000582C                            ; Subroutine to	load the sound driver
0000582C                            ; ---------------------------------------------------------------------------
0000582C                            
0000582C                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000582C                            
0000582C                            
0000582C                            SoundDriverLoad:			; XREF: GameClrRAM; TitleScreen
0000582C 4E71                       		nop
0000582E 303C 0100                  		move.w	#$100,d0
00005832 33C0 00A1 1100             		move.w	d0,($A11100).l
00005838 33C0 00A1 1200             		move.w	d0,($A11200).l
0000583E 41F9 0000 0000             		lea	(MegaPCM).l,a0
00005844 43F9 00A0 0000             		lea	($A00000).l,a1
0000584A 323C 0000                  		move.w	#(MegaPCM_End-MegaPCM)-1,d1
0000584E                            
0000584E 12D8                       	@Load:	move.b	(a0)+,(a1)+
00005850 51C9 FFFC                  		dbf	d1,@Load
00005854 7200                       		moveq	#0,d1
00005856 33C1 00A1 1200             		move.w	d1,($A11200).l
0000585C 4E71                       		nop
0000585E 4E71                       		nop
00005860 4E71                       		nop
00005862 4E71                       		nop
00005864 33C0 00A1 1200             		move.w	d0,($A11200).l
0000586A 33C1 00A1 1100             		move.w	d1,($A11100).l
00005870 4E75                       		rts
00005872                            ; End of function SoundDriverLoad
00005872                            
00005872                            ; ---------------------------------------------------------------------------
00005872                            ; Subroutine to	play a DAC sample
00005872                            ; ---------------------------------------------------------------------------
00005872                            
00005872                            PlaySample:
00005872 33FC 0100 00A1 1100        	move.w	#$100,($A11100).l	; остановка Z80
0000587A 0839 0000 00A1 1100        @0	btst	#0,($A11100).l
00005882 66F6                       	bne.s	@0
00005884 13C0 00A0 1FFF             	move.b	d0,$A01FFF
0000588A 33FC 0000 00A1 1100        	move.w	#0,($A11100).l
00005892 4E75                       	rts
00005894                            
00005894                            ; ---------------------------------------------------------------------------
00005894                            ; Subroutine to	play a sound or	music track
00005894                            ; ---------------------------------------------------------------------------
00005894                            
00005894                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005894                            
00005894                            
00005894                            PlaySound:
00005894 11C0 F00A                  		move.b	d0,($FFFFF00A).w
00005898 4E75                       		rts	
0000589A                            ; End of function PlaySound
0000589A                            
0000589A                            
0000589A                            
0000589A                            ; ---------------------------------------------------------------------------
0000589A                            ; Subroutine to update music more than once per frame
0000589A                            ; (Called by horizontal & vert. interrupts)
0000589A                            ; ---------------------------------------------------------------------------
0000589A                            
0000589A                            ;sub_71B4C:
0000589A                            UpdateMusic:				; XREF: VBlank; HBlank
0000589A                            
0000589A                            ; ---------------------------------------------------------------------------
0000589A                            ; PAL-modifier
0000589A                            ; ---------------------------------------------------------------------------
0000589A                            
0000589A                            ;		tst.b	SMPS_PALTimer		; is mode PAL
0000589A                            ;		beq.s	@SMPS_Proc		; if not, branch
0000589A                            ;		subq.b	#1,SMPS_PALTimer
0000589A                            ;		bne.s	@SMPS_Proc
0000589A                            ;		bsr.s	@SMPS_Proc
0000589A                            ;		move.b	#6,SMPS_PALTimer
0000589A                            
0000589A                            @SMPS_Proc:
0000589A                            ; ---------------------------------------------------------------------------
0000589A 4DF9 00FF F000             		lea	(v_snddriver_ram&$FFFFFF).l,a6
000058A0 422E 000E                  		clr.b	f_voice_selector(a6)
000058A4 4A2E 0003                  		tst.b	f_stopmusic(a6)			; is music paused?
000058A8 6600 0000                  		bne.w	PauseMusic			; if yes, branch
000058AC                            
000058AC                            
000058AC                            
000058AC 532E 0001                  		subq.b	#1,v_main_tempo_timeout(a6)	; Has main tempo timer expired?
000058B0 6600                       		bne.s	@skipdelay
000058B2 4EBA 0000                  		jsr	TempoWait(pc)
000058B6                            
000058B6                            @skipdelay:
000058B6 102E 0004                  		move.b	v_fadeout_counter(a6),d0
000058BA 6700                       		beq.s	@skipfadeout
000058BC 4EBA 0000                  		jsr	DoFadeOut(pc)
000058C0                            
000058C0                            @skipfadeout:
000058C0 4A2E 0024                  		tst.b	f_fadein_flag(a6)
000058C4 6700                       		beq.s	@skipfadein
000058C6 4EBA 0000                  		jsr	DoFadeIn(pc)
000058CA                            
000058CA                            @skipfadein:
000058CA 4A6E 000A                  		tst.w	v_playsnd1(a6)		; is a music or sound queued for played?
000058CE 6700                       		beq.s	@nosndinput		; if not, branch
000058D0 4EBA 0000                  		jsr	Sound_Play(pc)
000058D4                            
000058D4                            @nosndinput:
000058D4 0C2E 0080 0009             		cmpi.b	#$80,v_playsnd0(a6)	; is song queue set for silence?
000058DA 6700                       		beq.s	@nonewsound		; If yes, branch
000058DC 4EBA 0000                  		jsr	Sound_ChkValue(pc)
000058E0                            
000058E0                            @nonewsound:
000058E0 4BEE 0040                  		lea	v_dac_track(a6),a5
000058E4 4A15                       		tst.b	(a5)			; Is DAC track playing?
000058E6 6A00                       		bpl.s	@dacdone		; Branch if not
000058E8 4EBA 0000                  		jsr	UpdateDAC(pc)
000058EC                            
000058EC                            @dacdone:
000058EC 422E 0008                  		clr.b	f_updating_dac(a6)
000058F0 7E05                       		moveq	#5,d7
000058F2                            		
000058F2 41F9 0000 0000             		lea	FMUpdateTrack,a0	; ++ use standard FM update routine
000058F8 4A2E 0007                  		tst.b	v_extension(a6)		; ++ is extension active?
000058FC 6700                       		beq.s	@0			; ++ if not, branch
000058FE 41F9 0000 0000             		lea	TS_FM_UpdateChannel,a0	; ++ use extension FM update routine
00005904                            	@0:
00005904                            
00005904                            @bgmfmloop:
00005904 4BED 0030                  		lea	zTrackSz(a5),a5
00005908 4A15                       		tst.b	(a5)		; Is track playing?
0000590A 6A00                       		bpl.s	@bgmfmnext	; Branch if not
0000590C 2F08                       		move.l	a0,-(sp)
0000590E 4E90                       		jsr	(a0)
00005910 205F                       		move.l	(sp)+,a0
00005912                            
00005912                            @bgmfmnext:
00005912 51CF FFF0                  		dbf	d7,@bgmfmloop
00005916                            
00005916 7E02                       		moveq	#2,d7
00005918                            
00005918                            @bgmpsgloop:
00005918 DAFC 0030                  		adda.w	#zTrackSz,a5
0000591C 4A15                       		tst.b	(a5)
0000591E 6A00                       		bpl.s	@bgmpsgnext
00005920 4EBA 0000                  		jsr	PSGUpdateTrack(pc)
00005924                            
00005924                            @bgmpsgnext:
00005924 51CF FFF2                  		dbf	d7,@bgmpsgloop
00005928                            
00005928 1D7C 0080 000E             		move.b	#$80,f_voice_selector(a6)	; Now at SFX tracks
0000592E 7E02                       		moveq	#2,d7
00005930                            
00005930                            @sfxfmloop:
00005930 DAFC 0030                  		adda.w	#zTrackSz,a5
00005934 4A15                       		tst.b	(a5)		; Is track playing?
00005936 6A00                       		bpl.s	@sfxfmnext	; Branch if not
00005938 4EBA 0000                  		jsr	FMUpdateTrack(pc)
0000593C                            
0000593C                            @sfxfmnext:
0000593C 51CF FFF2                  		dbf	d7,@sfxfmloop
00005940                            
00005940 7E02                       		moveq	#2,d7
00005942                            
00005942                            @sfxpsgloop:
00005942 DAFC 0030                  		adda.w	#zTrackSz,a5
00005946 4A15                       		tst.b	(a5)
00005948 6A00                       		bpl.s	@sfxpsgnext
0000594A 4EBA 0000                  		jsr	PSGUpdateTrack(pc)
0000594E                            
0000594E                            @sfxpsgnext:
0000594E 51CF FFF2                  		dbf	d7,@sfxpsgloop
00005952                            		
00005952 1D7C 0040 000E             		move.b	#$40,f_voice_selector(a6)	; Now at special SFX tracks
00005958 DAFC 0030                  		adda.w	#zTrackSz,a5
0000595C 4A15                       		tst.b	(a5)		; Is track playing?
0000595E 6A00                       		bpl.s	@specfmdone	; Branch if not
00005960 4EBA 0000                  		jsr	FMUpdateTrack(pc)
00005964                            
00005964                            @specfmdone:
00005964 DAFC 0030                  		adda.w	#zTrackSz,a5
00005968 4A15                       		tst.b	(a5)
0000596A 6A00                       		bpl.s	UpdateMusic_Done
0000596C 4EBA 0000                  		jsr	PSGUpdateTrack(pc)
00005970                            
00005970                            UpdateMusic_Done:
00005970 4E75                       		rts
00005972                            ; End of function UpdateMusic
00005972                            
00005972                            
00005972                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005972                            
00005972                            
00005972                            UpdateDAC:
00005972 532D 000E                  		subq.b	#1,$E(a5)	; Has DAC sample timeout expired?
00005976 6600                       		bne.s	@locret	; Return if not
00005978 1D7C 0080 0008             		move.b	#$80,f_updating_dac(a6)	; Set flag to indicate this is the DAC
0000597E 286D 0004                  		movea.l	4(a5),a4	; DAC track data pointer
00005982                            
00005982                            @sampleloop:
00005982 7A00                       		moveq	#0,d5
00005984 1A1C                       		move.b	(a4)+,d5	; Get next SMPS unit
00005986 0C05 00E0                  		cmpi.b	#$E0,d5		; Is it a coord. flag?
0000598A 6500                       		blo.s	@notcoord	; Branch if not
0000598C 4EBA 0000                  		jsr	CoordFlag(pc)
00005990 60F0                       		bra.s	@sampleloop
00005992                            ; ===========================================================================
00005992                            
00005992                            @notcoord:
00005992 4A05                       		tst.b	d5			; Is it a sample?
00005994 6A00                       		bpl.s	@gotduration	; Branch if not (duration)
00005996 1B45 0010                  		move.b	d5,$10(a5)	; Store new sample
0000599A 1A1C                       		move.b	(a4)+,d5	; Get another byte
0000599C 6A00                       		bpl.s	@gotduration	; Branch if it is a duration
0000599E 534C                       		subq.w	#1,a4		; Put byte back
000059A0 1B6D 000F 000E             		move.b	$F(a5),$E(a5)	; Use last duration
000059A6 6000                       		bra.s	@gotsampleduration
000059A8                            ; ===========================================================================
000059A8                            
000059A8                            @gotduration:
000059A8 4EBA 0000                  		jsr	SetDuration(pc)
000059AC                            
000059AC                            @gotsampleduration:
000059AC 2B4C 0004                  		move.l	a4,4(a5)	; Save pointer
000059B0 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
000059B4 6600                       		bne.s	@locret	; Return if yes
000059B6 7000                       		moveq	#0,d0
000059B8 102D 0010                  		move.b	$10(a5),d0	; Get sample
000059BC 0C00 0080                  		cmpi.b	#$80,d0		; Is it a rest?
000059C0 6700                       		beq.s	@locret		; Return if yes      
000059C2                            		
000059C2 1B40 0028                  		move.b	d0,$28(a5)	; ++
000059C6                            
000059C6 33FC 0100 00A1 1100 4E71+  		stopZ80
000059DE 13C0 00A0 1FFF             		move.b	d0,($A01FFF).l
000059E4 33FC 0000 00A1 1100        		startZ80
000059EC                            
000059EC                            @locret:
000059EC 4E75                       		rts
000059EE                            ; End of function UpdateDAC
000059EE                            
000059EE                            ; ===========================================================================
000059EE                            ; Note: this only defines rates for samples $88-$8D, meaning $8E-$8F are invalid.
000059EE                            ; Also, $8C-$8D are so slow you may want to skip them.
000059EE 1215 1C1D FFFF             DAC_sample_rate: dc.b $12, $15, $1C, $1D, $FF, $FF
000059F4                            
000059F4                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000059F4                            
000059F4                            
000059F4                            FMUpdateTrack:
000059F4 532D 000E                  		subq.b	#1,$E(a5)	; Update duration timeout
000059F8 6600                       		bne.s	@notegoing	; Branch if it hasn't expired
000059FA 0895 0004                  		bclr	#4,(a5)		; Clear do not attack next note bit
000059FE 4EBA 0000                  		jsr	FMDoNext(pc)
00005A02 4EBA 0000                  		jsr	FMPrepareNote(pc)
00005A06 6000 0000                  		bra.w	FMNoteOn
00005A0A                            ; ===========================================================================
00005A0A                            
00005A0A                            @notegoing:
00005A0A 4EBA 0000                  		jsr	NoteFillUpdate(pc)
00005A0E 4EBA 0000                  		jsr	DoModulation(pc)
00005A12 6000 0000                  		bra.w	FMUpdateFreq
00005A16                            ; End of function FMUpdateTrack
00005A16                            
00005A16                            
00005A16                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005A16                            
00005A16                            
00005A16                            FMDoNext:
00005A16 286D 0004                  		movea.l	4(a5),a4	; Track data pointer
00005A1A 0895 0001                  		bclr	#1,(a5)		; Clear 'track at rest' bit
00005A1E                            
00005A1E                            @noteloop:
00005A1E 7A00                       		moveq	#0,d5
00005A20 1A1C                       		move.b	(a4)+,d5	; Get byte from track
00005A22 0C05 00E0                  		cmpi.b	#$E0,d5		; Is this a coord. flag?
00005A26 6500                       		blo.s	@gotnote	; Branch if not
00005A28 4EBA 0000                  		jsr	CoordFlag(pc)
00005A2C 60F0                       		bra.s	@noteloop
00005A2E                            ; ===========================================================================
00005A2E                            
00005A2E                            @gotnote:
00005A2E 4EBA 0000                  		jsr	FMNoteOff(pc)
00005A32 4A05                       		tst.b	d5			; Is this a note?
00005A34 6A00                       		bpl.s	@gotduration	; Branch if not
00005A36 4EBA 0000                  		jsr	FMSetFreq(pc)
00005A3A 1A1C                       		move.b	(a4)+,d5	; Get another byte
00005A3C 6A00                       		bpl.s	@gotduration	; Branch if it is a duration
00005A3E 534C                       		subq.w	#1,a4		; Otherwise, put it back
00005A40 6000 0000                  		bra.w	FinishTrackUpdate
00005A44                            ; ===========================================================================
00005A44                            
00005A44                            @gotduration:
00005A44 4EBA 0000                  		jsr	SetDuration(pc)
00005A48 6000 0000                  		bra.w	FinishTrackUpdate
00005A4C                            ; End of function FMDoNext
00005A4C                            
00005A4C                            
00005A4C                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005A4C                            
00005A4C                            
00005A4C                            FMSetFreq:
00005A4C 0405 0080                  		subi.b	#$80,d5		; Make it a zero-based index
00005A50 6700                       		beq.s	TrackSetRest
00005A52 DA2D 0008                  		add.b	8(a5),d5	; Add track key displacement
00005A56 0245 007F                  		andi.w	#$7F,d5		; Clear high byte and sign bit
00005A5A E34D                       		lsl.w	#1,d5
00005A5C 41FA 0000                  		lea	FM_Notes(pc),a0
00005A60 3C30 5000                  		move.w	(a0,d5.w),d6
00005A64 3B46 0010                  		move.w	d6,$10(a5)	; Store new frequency
00005A68 4E75                       		rts	
00005A6A                            ; End of function FMSetFreq
00005A6A                            
00005A6A                            
00005A6A                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005A6A                            
00005A6A                            
00005A6A                            SetDuration:
00005A6A 1005                       		move.b	d5,d0
00005A6C 122D 0002                  		move.b	2(a5),d1	; Get dividing timing
00005A70                            
00005A70                            @multloop:
00005A70 5301                       		subq.b	#1,d1
00005A72 6700                       		beq.s	@donemult
00005A74 D005                       		add.b	d5,d0
00005A76 60F8                       		bra.s	@multloop
00005A78                            ; ===========================================================================
00005A78                            
00005A78                            @donemult:
00005A78 1B40 000F                  		move.b	d0,$F(a5)	; Save duration
00005A7C 1B40 000E                  		move.b	d0,$E(a5)	; Save duration timeout
00005A80 4E75                       		rts	
00005A82                            ; End of function SetDuration
00005A82                            
00005A82                            ; ===========================================================================
00005A82                            
00005A82                            TrackSetRest:
00005A82 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00005A86 426D 0010                  		clr.w	$10(a5)		; Clear frequency
00005A8A                            
00005A8A                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005A8A                            
00005A8A                            
00005A8A                            FinishTrackUpdate:
00005A8A 2B4C 0004                  		move.l	a4,4(a5)	; Store new track position
00005A8E 1B6D 000F 000E             		move.b	$F(a5),$E(a5)	; Reset note timeout
00005A94 0815 0004                  		btst	#4,(a5)		; Is track set to not attack note?
00005A98 6600                       		bne.s	@locret		; If so, branch
00005A9A 1B6D 0013 0012             		move.b	$13(a5),$12(a5)		; Reset note fill timeout
00005AA0 422D 000C                  		clr.b	$C(a5)		; Reset PSG flutter index
00005AA4 0815 0003                  		btst	#3,(a5)		; Is modulation on?
00005AA8 6700                       		beq.s	@locret		; If not, return
00005AAA 206D 0014                  		movea.l	$14(a5),a0	; Modulation data pointer
00005AAE 1B58 0018                  		move.b	(a0)+,$18(a5)	; Reset wait
00005AB2 1B58 0019                  		move.b	(a0)+,$19(a5)	; Reset speed
00005AB6 1B58 001A                  		move.b	(a0)+,$1A(a5)	; Reset delta
00005ABA 1018                       		move.b	(a0)+,d0	; Get steps
00005ABC E208                       		lsr.b	#1,d0		; Halve them
00005ABE 1B40 001B                  		move.b	d0,$1B(a5)	; Then store
00005AC2 426D 001C                  		clr.w	$1C(a5)		; Reset frequency change
00005AC6                            
00005AC6                            @locret:
00005AC6 4E75                       		rts	
00005AC8                            ; End of function FinishTrackUpdate
00005AC8                            
00005AC8                            
00005AC8                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005AC8                            
00005AC8                            
00005AC8                            NoteFillUpdate:
00005AC8 4A2D 0012                  		tst.b	$12(a5)		; Is note fill on?
00005ACC 6700                       		beq.s	@locret
00005ACE 532D 0012                  		subq.b	#1,$12(a5)	; Update note fill timeout
00005AD2 6600                       		bne.s	@locret		; Return if it hasn't expired
00005AD4 08D5 0001                  		bset	#1,(a5)		; Put track at rest
00005AD8 4A2D 0001                  		tst.b	1(a5)		; Is this a psg track?
00005ADC 6B00 0000                  		bmi.w	@psgnoteoff	; If yes, branch
00005AE0 4EBA 0000                  		jsr	FMNoteOff(pc)
00005AE4 584F                       		addq.w	#4,sp		; Do not return to caller
00005AE6 4E75                       		rts	
00005AE8                            ; ===========================================================================
00005AE8                            
00005AE8                            @psgnoteoff:
00005AE8 4EBA 0000                  		jsr	PSGNoteOff(pc)
00005AEC 584F                       		addq.w	#4,sp		; Do not return to caller
00005AEE                            
00005AEE                            @locret:
00005AEE 4E75                       		rts	
00005AF0                            ; End of function NoteFillUpdate
00005AF0                            
00005AF0                            
00005AF0                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005AF0                            
00005AF0                            
00005AF0                            DoModulation:
00005AF0 584F                       		addq.w	#4,sp		; Do not return to caller (but see below)
00005AF2 0815 0003                  		btst	#3,(a5)		; Is modulation active?
00005AF6 6700                       		beq.s	@locret		; Return if not
00005AF8 4A2D 0018                  		tst.b	$18(a5)		; Has modulation wait expired?
00005AFC 6700                       		beq.s	@waitdone	; If yes, branch
00005AFE 532D 0018                  		subq.b	#1,$18(a5)	; Update wait timeout
00005B02 4E75                       		rts	
00005B04                            ; ===========================================================================
00005B04                            
00005B04                            @waitdone:
00005B04 532D 0019                  		subq.b	#1,$19(a5)	; Update speed
00005B08 6700                       		beq.s	@updatemodulation	; If it expired, want to update modulation
00005B0A 4E75                       		rts	
00005B0C                            ; ===========================================================================
00005B0C                            
00005B0C                            @updatemodulation:
00005B0C 206D 0014                  		movea.l	$14(a5),a0	; Get modulation data
00005B10 1B68 0001 0019             		move.b	1(a0),$19(a5)	; Restore modulation speed
00005B16 4A2D 001B                  		tst.b	$1B(a5)		; Check number of steps
00005B1A 6600                       		bne.s	@calcfreq	; If nonzero, branch
00005B1C 1B68 0003 001B             		move.b	3(a0),$1B(a5)	; Restore from modulation data
00005B22 442D 001A                  		neg.b	$1A(a5)		; Negate modulation delta
00005B26 4E75                       		rts	
00005B28                            ; ===========================================================================
00005B28                            
00005B28                            @calcfreq:
00005B28 532D 001B                  		subq.b	#1,$1B(a5)	; Update modulation steps
00005B2C 1C2D 001A                  		move.b	$1A(a5),d6	; Get modulation delta
00005B30 4886                       		ext.w	d6
00005B32 DC6D 001C                  		add.w	$1C(a5),d6	; Add cumulative modulation change
00005B36 3B46 001C                  		move.w	d6,$1C(a5)	; Store it
00005B3A DC6D 0010                  		add.w	$10(a5),d6	; Add note frequency to it
00005B3E 594F                       		subq.w	#4,sp		; In this case, we want to return to caller after all
00005B40                            
00005B40                            @locret:
00005B40 4E75                       		rts	
00005B42                            ; End of function DoModulation
00005B42                            
00005B42                            
00005B42                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005B42                            
00005B42                            
00005B42                            FMPrepareNote:
00005B42 0815 0001                  		btst	#1,(a5)		; Is track resting?
00005B46 6600                       		bne.s	locret_71E48	; Return if so
00005B48 3C2D 0010                  		move.w	$10(a5),d6		; Get current note frequency
00005B4C 6700                       		beq.s	FMSetRest		; Branch if zero
00005B4E                            
00005B4E                            FMUpdateFreq:
00005B4E 102D 001E                  		move.b	$1E(a5),d0	; Get frequency adjustment
00005B52 4880                       		ext.w	d0
00005B54 DC40                       		add.w	d0,d6		; Add note frequency
00005B56 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
00005B5A 6600                       		bne.s	locret_71E48	; Return if so
00005B5C 3206                       		move.w	d6,d1
00005B5E E049                       		lsr.w	#8,d1
00005B60 103C 00A4                  		move.b	#$A4,d0		; Register for upper 6 bits of frequency
00005B64 4EBA 0000                  		jsr	WriteFMIorII(pc)
00005B68 1206                       		move.b	d6,d1
00005B6A 103C 00A0                  		move.b	#$A0,d0		; Register for lower 8 bits of frequency
00005B6E 4EBA 0000                  		jsr	WriteFMIorII(pc)
00005B72                            
00005B72                            locret_71E48:
00005B72 4E75                       		rts	
00005B74                            ; ===========================================================================
00005B74                            
00005B74                            FMSetRest:
00005B74 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00005B78 4E75                       		rts	
00005B7A                            ; End of function FMPrepareNote
00005B7A                            
00005B7A                            ; ===========================================================================
00005B7A                            
00005B7A                            PauseMusic:
00005B7A 6B00 0000                  		bmi	@unpausemusic		; Branch if music is being unpaused
00005B7E 0C2E 0002 0003             		cmpi.b	#2,f_stopmusic(a6)
00005B84 6700 0000                  		beq.w	@unpausedallfm
00005B88 1D7C 0002 0003             		move.b	#2,f_stopmusic(a6)
00005B8E                            		
00005B8E                            ;	tst.b	v_cda_playing(a6)
00005B8E                            ;	beq.s	@0
00005B8E                            ;	mcdsend	#_MCD_PauseTrack
00005B8E                            ;@0
00005B8E                            
00005B8E 7602                       		moveq	#2,d3
00005B90 103C 00B4                  		move.b	#$B4,d0		; Command to set AMS/FMS/panning
00005B94 7200                       		moveq	#0,d1		; No panning, AMS or FMS
00005B96                            
00005B96                            @killpanloop:
00005B96 4EBA 0000                  		jsr	WriteFMI(pc)
00005B9A 4EBA 0000                  		jsr	WriteFMII(pc)
00005B9E 5200                       		addq.b	#1,d0
00005BA0 51CB FFF4                  		dbf	d3,@killpanloop
00005BA4                            
00005BA4 7602                       		moveq	#2,d3
00005BA6 7028                       		moveq	#$28,d0		; Key on/off register
00005BA8                            
00005BA8                            @noteoffloop:
00005BA8 1203                       		move.b	d3,d1		; FM1, FM2, FM3
00005BAA 4EBA 0000                  		jsr	WriteFMI(pc)
00005BAE 5801                       		addq.b	#4,d1		; FM4, FM5, FM6
00005BB0 4EBA 0000                  		jsr	WriteFMI(pc)
00005BB4 51CB FFF2                  		dbf	d3,@noteoffloop
00005BB8                            
00005BB8 33FC 0100 00A1 1100 4E71+  		stopZ80
00005BD0 13FC 007F 00A0 1FFF        		move.b	#$7F,($A01FFF).l; pause DAC
00005BD8 33FC 0000 00A1 1100        		startZ80
00005BE0                            
00005BE0 4EBA 0000                  		jsr	PSGSilenceAll(pc)
00005BE4 6000 FD8A                  		bra.w	UpdateMusic_Done
00005BE8                            ; ===========================================================================
00005BE8                            
00005BE8                            @unpausemusic:
00005BE8 422E 0003                  		clr.b	f_stopmusic(a6)
00005BEC                            
00005BEC                            ;	tst.b	v_cda_playing(a6)
00005BEC                            ;	beq.s	@1
00005BEC                            ;	mcdsend	#_MCD_UnPauseTrack
00005BEC                            ;@1
00005BEC                            
00005BEC 7630                       		moveq	#zTrackSz,d3
00005BEE 4BEE 0040                  		lea	v_track_ram(a6),a5
00005BF2 7806                       		moveq	#6,d4
00005BF4                            
00005BF4                            @bgmfmloop:
00005BF4 0815 0007                  		btst	#7,(a5)		; Is track playing?
00005BF8 6700                       		beq.s	@bgmfmnext	; Branch if not
00005BFA 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
00005BFE 6600                       		bne.s	@bgmfmnext	; Branch if yes
00005C00 103C 00B4                  		move.b	#$B4,d0		; Command to set AMS/FMS/panning
00005C04 122D 000A                  		move.b	$A(a5),d1	; Get value from track RAM
00005C08 4EBA 0000                  		jsr	WriteFMIorII(pc)
00005C0C                            
00005C0C                            @bgmfmnext:
00005C0C DAC3                       		adda.w	d3,a5
00005C0E 51CC FFE4                  		dbf	d4,@bgmfmloop
00005C12                            
00005C12 4BEE 0220                  		lea	v_sfx_track_ram(a6),a5
00005C16 7802                       		moveq	#2,d4
00005C18                            
00005C18                            @sfxfmloop:
00005C18 0815 0007                  		btst	#7,(a5)		; Is track playing?
00005C1C 6700                       		beq.s	@sfxfmnext	; Branch if not
00005C1E 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
00005C22 6600                       		bne.s	@sfxfmnext	; Branch if yes
00005C24 103C 00B4                  		move.b	#$B4,d0		; Command to set AMS/FMS/panning
00005C28 122D 000A                  		move.b	$A(a5),d1	; Get value from track RAM
00005C2C 4EBA 0000                  		jsr	WriteFMIorII(pc)
00005C30                            
00005C30                            @sfxfmnext:
00005C30 DAC3                       		adda.w	d3,a5
00005C32 51CC FFE4                  		dbf	d4,@sfxfmloop
00005C36                            
00005C36 4BEE 0340                  		lea	v_sfx2_track_ram(a6),a5
00005C3A 0815 0007                  		btst	#7,(a5)		; Is track playing?
00005C3E 6700                       		beq.s	@unpausedac	; Branch if not
00005C40 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
00005C44 6600                       		bne.s	@unpausedac	; Branch if yes
00005C46 103C 00B4                  		move.b	#$B4,d0		; Command to set AMS/FMS/panning
00005C4A 122D 000A                  		move.b	$A(a5),d1	; Get value from track RAM
00005C4E 4EBA 0000                  		jsr	WriteFMIorII(pc)
00005C52                            
00005C52                            @unpausedac:
00005C52 33FC 0100 00A1 1100 4E71+  		stopZ80
00005C6A 13FC 0000 00A0 1FFF        		move.b	#0,($A01FFF).l	; unpause DAC
00005C72 33FC 0000 00A1 1100        		startZ80
00005C7A                            
00005C7A                            @unpausedallfm:
00005C7A 6000 FCF4                  		bra.w	UpdateMusic_Done
00005C7E                            
00005C7E                            ; ---------------------------------------------------------------------------
00005C7E                            ; Subroutine to	play a sound or	music track
00005C7E                            ; ---------------------------------------------------------------------------
00005C7E                            
00005C7E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005C7E                            
00005C7E                            
00005C7E                            Sound_Play:				; XREF: UpdateMusic
00005C7E 2079 0000 569C             	movea.l	(Go_SoundPriorities).l,a0
00005C84 43EE 000A                  	lea	v_playqueue(a6),a1		; load sound queue
00005C88 1616                       	move.b	v_sndprio(a6),d3		; Get priority of currently playing SFX
00005C8A                            
00005C8A 1019                       	move.b	(a1)+,d0			; get sound id to play
00005C8C 6700                       	beq.s	@locret				; if nothing to play, branch
00005C8E 1200                       	move.b	d0,d1
00005C90 0400 0081                  	subi.b	#$81,d0				; Make it into 0-based index
00005C94 0C2E 0080 0009             	cmpi.b	#$80,v_playsnd0(a6)		; is SMPS processing a sound already?
00005C9A 6600                       	bne.s	@locret				; If yes, branch
00005C9C                            
00005C9C                            	; Get ready to play sound
00005C9C 0240 007F                  	andi.w	#$7F,d0				; Clear high byte and sign bit
00005CA0 1430 0000                  	move.b	(a0,d0.w),d2			; Get sound type
00005CA4 B403                       	cmp.b	d3,d2				; Is it a lower priority sound?
00005CA6 6500                       	blo.s	@shiftqueue			; Branch if yes
00005CA8 1D41 0009                  	move.b	d1,v_playsnd0(a6)		; Queue sound for play
00005CAC 1602                       	move.b	d2,d3				; Store new priority
00005CAE 6B00                       	bmi.s	@shiftqueue			; We don't want to change sound priority if it is negative
00005CB0 1C83                       	move.b	d3,v_sndprio(a6)
00005CB2                            
00005CB2                            @shiftqueue:
00005CB2                            	; Shifting sound queue
00005CB2 41E9 FFFF                  	lea	-1(a1),a0
00005CB6 10D9                       	move.b	(a1)+,(a0)+
00005CB8 10D9                       	move.b	(a1)+,(a0)+
00005CBA 10D9                       	move.b	(a1)+,(a0)+
00005CBC 4210                       	clr.b	(a0)				; clear last queue entry
00005CBE                            
00005CBE                            @locret:
00005CBE 4E75                       	rts
00005CC0                            
00005CC0                            
00005CC0                            ;		movea.l	(Go_SoundPriorities).l,a0
00005CC0                            ;		lea	v_playsnd1(a6),a1	; load music track number
00005CC0                            ;		move.b	v_sndprio(a6),d3	; Get priority of currently playing SFX
00005CC0                            ;		moveq	#2,d4
00005CC0                            ;
00005CC0                            ;@inputloop:
00005CC0                            ;		move.b	(a1),d0		; move track number to d0
00005CC0                            ;		move.b	d0,d1
00005CC0                            ;		clr.b	(a1)+		; Clear entry
00005CC0                            ;		subi.b	#$81,d0		; Make it into 0-based index
00005CC0                            ;		blo.s	@nextinput	; If negative (i.e., it was $80 or lower), branch
00005CC0                            ;		cmpi.b	#$80,v_playsnd0(a6)	; Is v_playsnd0 a $80 (silence)?
00005CC0                            ;		beq.s	@havesound	; If yes, branch
00005CC0                            ;		move.b	d1,v_playsnd1(a6)	; Put sound into v_playsnd1
00005CC0                            ;		bra.s	@nextinput
00005CC0                            ;; ===========================================================================
00005CC0                            ;
00005CC0                            ;@havesound:
00005CC0                            ;		andi.w	#$7F,d0		; Clear high byte and sign bit
00005CC0                            ;		move.b	(a0,d0.w),d2	; Get sound type
00005CC0                            ;		cmp.b	d3,d2		; Is it a lower priority sound?
00005CC0                            ;		blo.s	@nextinput	; Branch if yes
00005CC0                            ;		move.b	d2,d3		; Store new priority
00005CC0                            ;		move.b	d1,v_playsnd0(a6)	; Queue sound for play
00005CC0                            ;
00005CC0                            ;@nextinput:
00005CC0                            ;		dbf	d4,@inputloop
00005CC0                            ;
00005CC0                            ;		tst.b	d3		; We don't want to change sound priority if it is negative
00005CC0                            ;		bmi.s	@locret
00005CC0                            ;		move.b	d3,v_sndprio(a6)	; Set new sound priority
00005CC0                            ;
00005CC0                            ;@locret:
00005CC0                            ;		rts
00005CC0                            ; End of function Sound_Play
00005CC0                            
00005CC0                            
00005CC0                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00005CC0                            
00005CC0                            
00005CC0                            Sound_ChkValue:
00005CC0 7E00                       		moveq	#0,d7
00005CC2 1E2E 0009                  		move.b	v_playsnd0(a6),d7
00005CC6 6700 0000                  		beq.w	StopSoundAndMusic
00005CCA 6A00                       		bpl.s	@locret			; If >= 0, return (not a valid sound, bgm or command)
00005CCC 1D7C 0080 0009             		move.b	#$80,v_playsnd0(a6)	; reset	music flag
00005CD2 0C07 009F                  		cmpi.b	#$9F,d7			; Is this music ($81-$9F)?
00005CD6 6300 0000                  		bls.w	Sound_PlayBGM		; Branch if yes
00005CDA 0C07 00CF                  		cmpi.b	#$CF,d7			; Is this sfx ($A0-$CF)?
00005CDE 6300 0000                  		bls.w	Sound_PlaySFX		; Branch if yes
00005CE2 0C07 00D0                  		cmpi.b	#$D0,d7			; Is this sound $D0?
00005CE6 6700 0000                  		beq.w	Sound_PlaySpecial	; Branch if yes
00005CEA 0C07 00DF                  		cmpi.b	#$DF,d7			; Is this sound $D1-$DF?
00005CEE 6300 0000                  		bls	Sound_PlaySFX
00005CF2 0C07 00E4                  		cmpi.b	#$E4,d7			; Is this $E0-$E4?
00005CF6 6300                       		bls.s	Sound_E0toE4		; Branch if yes
00005CF8                            	;	bra.s	Sound_CDA		; $E5-$FF
00005CF8 6000                       		bra.s	Sound_PlayBGM2
00005CFA                            
00005CFA                            @locret:
00005CFA 4E75                       		rts
00005CFC                            ; ===========================================================================
00005CFC                            
00005CFC                            ;Sound_CDA:
00005CFC                            ;	tst.b	SegaCDMode
00005CFC                            ;	beq.s	@ret			; if we aren't in Sega CD mode, don't give a fuck
00005CFC                            ;
00005CFC                            ;	sf.b	v_sndprio(a6)		; clear sound priority
00005CFC                            ;	sf.b	f_1up_playing(a6)	; clear 1-up playback flag
00005CFC                            ;	sf.b	v_fadein_counter(a6)	; clear fade-in counter
00005CFC                            ;	jsr	InitMusicPlayback	; reset SMPS memory
00005CFC                            ;
00005CFC                            ;	st.b	v_cda_playing(a6)	; set CDA playing flag
00005CFC                            ;	moveq	#_MCD_PlayTrack,d6	; play track repeatedly
00005CFC                            ;
00005CFC                            ;	cmpi.b	#_CDA_LevelComplete,d7	; is this level complete jingle?
00005CFC                            ;	seq	d5			; set D5 if yes
00005CFC                            ;	cmpi.b	#_CDA_LevelFail,d7	; is this level fail jignle?
00005CFC                            ;	seq	d4			; set D4 if yes
00005CFC                            ;	or.b	d4,d5			; is the track one of them?
00005CFC                            ;	beq.s	@play			; if not, branch
00005CFC                            ;	moveq	#_MCD_PlayTrack_Once,d6	; if yes, set track to play once
00005CFC                            ;
00005CFC                            ;@play	subi.w	#$E5,d7			; subtract $E5 to get track number
00005CFC                            ;	mcdsend	d6, d7, .w		; request MCD a track
00005CFC                            ;
00005CFC                            ;	addq.w	#4,sp			; Tamper return value so we don't return to caller
00005CFC                            ;@ret	rts
00005CFC                            
00005CFC                            ; ===========================================================================
00005CFC                            Sound_E0toE4:				; XREF: Sound_ChkValue
00005CFC 0407 00E0                  		subi.b	#$E0,d7
00005D00 DE47                       		add.w	d7,d7	;++
00005D02 DE47                       		add.w	d7,d7	;++
00005D04 4EFB 7000                  		jmp	Sound_ExIndex(pc,d7.w)
00005D08                            ; ===========================================================================
00005D08                            
00005D08                            Sound_ExIndex:
00005D08 6000 0000                  		bra.w	FadeOutMusic		; $E0
00005D0C                            ; ===========================================================================
00005D0C 6000 0000                  		bra.w	PlaySega		; $E1
00005D10                            ; ===========================================================================
00005D10 6000 0000                  		bra.w	SpeedUpMusic		; $E2
00005D14                            ; ===========================================================================
00005D14 6000 0000                  		bra.w	SlowDownMusic		; $E3
00005D18                            ; ===========================================================================
00005D18 6000 0000                  		bra.w	StopSoundAndMusic	; $E4
00005D1C                            ; ===========================================================================
00005D1C                            ; ---------------------------------------------------------------------------
00005D1C                            ; Play "Say-gaa" PCM sound
00005D1C                            ; ---------------------------------------------------------------------------
00005D1C                            
00005D1C                            PlaySega:
00005D1C                            ;		stopZ80
00005D1C                            ;		move.b	#$8F,($A01FFF).l	; Queue Sega PCM
00005D1C                            ;		startZ80
00005D1C                            ;
00005D1C                            ;		move.w	#$11,d1
00005D1C                            ;
00005D1C                            ;@busyloop_outer:
00005D1C                            ;		move.w	#-1,d0
00005D1C                            ;
00005D1C                            ;@busyloop:
00005D1C                            ;		nop
00005D1C                            ;		dbf	d0,@busyloop
00005D1C                            ;
00005D1C                            ;		dbf	d1,@busyloop_outer
00005D1C                            ;
00005D1C                            ;		addq.w	#4,sp	; Tamper return value so we don't return to caller
00005D1C 4E75                       		rts
00005D1E                            
00005D1E                            ; ===========================================================================
00005D1E                            ; ---------------------------------------------------------------------------
00005D1E                            ; Play music track $E5-FF
00005D1E                            ; ---------------------------------------------------------------------------
00005D1E                            
00005D1E                            Sound_PlayBGM2:
00005D1E 422E 0027                  		clr.b	f_1up_playing(a6)
00005D22 422E 0026                  		clr.b	v_fadein_counter(a6)
00005D26                            
00005D26 4EBA 0000                          	jsr	InitMusicPlayback(pc)
00005D2A 2879 0000 56B0             		movea.l	(Go_SpeedUpIndex).l,a4		; ~~
00005D30 0407 00E5                  		subi.b	#$E5,d7				; ~~
00005D34 1D74 7000 0029             		move.b	(a4,d7.w),v_speeduptempo(a6)	; ~~
00005D3A 2879 0000 56A8             		movea.l	(Go_MusicIndex2).l,a4
00005D40 E54F                       		lsl.w	#2,d7
00005D42 2874 7000                  		movea.l	(a4,d7.w),a4	; a4 now points to (uncompressed) song data
00005D46                            		
00005D46 4EF9 0000 0000             		jmp	Sound_LoadBGM
00005D4C                            
00005D4C                            ; ===========================================================================
00005D4C                            ; ---------------------------------------------------------------------------
00005D4C                            ; Play music track $81-$9F
00005D4C                            ; ---------------------------------------------------------------------------
00005D4C                            
00005D4C                            Sound_PlayBGM:
00005D4C                            ;		cmpi.b	#bgm_ExtraLife,d7		; is the "extra life" music to be played?
00005D4C                            ;		bne.s	@bgmnot1up	; if not, branch
00005D4C                            ;		tst.b	f_1up_playing(a6)	; Is a 1-up music playing?
00005D4C                            ;		bne.w	@locdblret	; if yes, branch
00005D4C                            ;		lea	v_track_ram(a6),a5
00005D4C                            ;		moveq	#9,d0	; [(1 DAC + 6 FM) or (7 FM)] + 3 PSG
00005D4C                            ;
00005D4C                            ;@clearsfxloop:
00005D4C                            ;		bclr	#2,(a5)	; Clear 'SFX is overriding' bit
00005D4C                            ;		adda.w	#zTrackSz,a5
00005D4C                            ;		dbf	d0,@clearsfxloop
00005D4C                            ;
00005D4C                            ;		lea	v_sfx_track_ram(a6),a5
00005D4C                            ;		moveq	#5,d0	; 3 FM + 3 PSG tracks (SFX)
00005D4C                            ;
00005D4C                            ;@cleartrackplayloop:
00005D4C                            ;		bclr	#7,(a5)	; Clear 'track is playing' bit
00005D4C                            ;		adda.w	#zTrackSz,a5
00005D4C                            ;		dbf	d0,@cleartrackplayloop
00005D4C                            ;
00005D4C                            ;		clr.b	v_sndprio(a6)	; Clear priority
00005D4C                            ;		movea.l	a6,a0
00005D4C                            ;		lea	v_1up_ram_copy(a6),a1
00005D4C                            ;		move.w	#$87,d0	; Backup $220 bytes
00005D4C                            ;
00005D4C                            ;@backupramloop:
00005D4C                            ;		move.l	(a0)+,(a1)+
00005D4C                            ;		dbf	d0,@backupramloop
00005D4C                            ;
00005D4C                            ;		move.b	#$80,f_1up_playing(a6)
00005D4C                            ;		clr.b	0(a6)
00005D4C                            ;		bra.s	@bgm_loadMusic
00005D4C                            ;; ===========================================================================
00005D4C                            ;
00005D4C                            ;@bgmnot1up:
00005D4C 422E 0027                  		clr.b	f_1up_playing(a6)
00005D50 422E 0026                  		clr.b	v_fadein_counter(a6)
00005D54                            
00005D54                            @bgm_loadMusic:
00005D54                            
00005D54                            ;	; If CDA is playing, stop it
00005D54                            ;	tst.b	v_cda_playing(a6)
00005D54                            ;	beq.s	@NoCD
00005D54                            ;	mcdsend	#_MCD_StopTrack
00005D54                            ;	sf.b	v_cda_playing(a6)
00005D54                            ;@NoCD
00005D54                            
00005D54 4EBA 0000                  		jsr	InitMusicPlayback(pc)
00005D58 2879 0000 56B0             		movea.l	(Go_SpeedUpIndex).l,a4
00005D5E 0407 0081                  		subi.b	#$81,d7
00005D62 1D74 7000 0029             		move.b	(a4,d7.w),v_speeduptempo(a6)
00005D68 2879 0000 56A4             		movea.l	(Go_MusicIndex).l,a4
00005D6E E54F                       		lsl.w	#2,d7
00005D70 2874 7000                  		movea.l	(a4,d7.w),a4	; a4 now points to (uncompressed) song data
00005D74                            		
00005D74                            Sound_LoadBGM:
00005D74 7000                       		moveq	#0,d0
00005D76 3014                       		move.w	(a4),d0		; load voice pointer
00005D78 D08C                       		add.l	a4,d0		; It is a relative pointer
00005D7A 2D40 0018                  		move.l	d0,v_voice_ptr(a6)
00005D7E 102C 0005                  		move.b	5(a4),d0	; load tempo
00005D82 1D40 0028                  		move.b	d0,v_tempo_mod(a6)
00005D86 4A2E 002A                  		tst.b	f_speedup(a6)
00005D8A 6700                       		beq.s	@nospeedshoes
00005D8C 102E 0029                  		move.b	v_speeduptempo(a6),d0
00005D90                            
00005D90                            @nospeedshoes:
00005D90 1D40 0002                  		move.b	d0,v_main_tempo(a6)
00005D94 1D40 0001                  		move.b	d0,v_main_tempo_timeout(a6)
00005D98 7200                       		moveq	#0,d1
00005D9A 264C                       		movea.l	a4,a3
00005D9C 5C4C                       		addq.w	#6,a4		; Point past header
00005D9E 7E00                       		moveq	#0,d7
00005DA0 1E2B 0002                  		move.b	2(a3),d7	; load number of FM+DAC channels
00005DA4 6700 0000                  		beq.w	@bgm_fmdone	; branch if zero
00005DA8 0887 0007                  		bclr	#7,d7		; ++
00005DAC 56EE 0007                  		sne.b	v_extension(a6)	; ++
00005DB0 5307                       		subq.b	#1,d7
00005DB2 123C 00C0                  		move.b	#$C0,d1		; Default AMS+FMS+Panning
00005DB6 182B 0004                  		move.b	4(a3),d4	; load tempo dividing timing
00005DBA 7C30                       		moveq	#zTrackSz,d6
00005DBC 1A3C 0001                  		move.b	#1,d5		; Note duration for first "note"
00005DC0 43EE 0040                  		lea	v_track_ram(a6),a1
00005DC4 45FA 0000                  		lea	FMDACInitBytes(pc),a2
00005DC8                            
00005DC8                            @bmg_fmloadloop:
00005DC8 08D1 0007                  		bset	#7,(a1)		; Initial playback control: set 'track playing' bit
00005DCC 135A 0001                  		move.b	(a2)+,1(a1)	; Voice control bits
00005DD0 1344 0002                  		move.b	d4,2(a1)
00005DD4 1346 000D                  		move.b	d6,$D(a1)	; set "gosub" (coord flag F8h) stack init value
00005DD8 1341 000A                  		move.b	d1,$A(a1)	; Set AMS/FMS/Panning
00005DDC 1345 000E                  		move.b	d5,$E(a1)	; Set duration of first "note"
00005DE0 7000                       		moveq	#0,d0
00005DE2 301C                       		move.w	(a4)+,d0	; load DAC/FM pointer
00005DE4 D08B                       		add.l	a3,d0		; Relative pointer
00005DE6 2340 0004                  		move.l	d0,4(a1)	; Store track pointer
00005DEA 335C 0008                  		move.w	(a4)+,8(a1)	; load FM channel modifier
00005DEE D2C6                       		adda.w	d6,a1
00005DF0 51CF FFD6                  		dbf	d7,@bmg_fmloadloop
00005DF4                            		
00005DF4 0C2B 0007 0002             		cmpi.b	#7,2(a3)	; Are 7 FM channels defined?
00005DFA 6600                       		bne.s	@silencefm6
00005DFC 702B                       		moveq	#$2B,d0		; DAC enable/disable register
00005DFE 7200                       		moveq	#0,d1		; Disable DAC
00005E00 4EBA 0000                  		jsr	WriteFMI(pc)
00005E04 6000 0000                  		bra.w	@bgm_fmdone
00005E08                            ; ===========================================================================
00005E08                            
00005E08                            @silencefm6:
00005E08 7028                       		moveq	#$28,d0		; Key on/off register
00005E0A 7206                       		moveq	#6,d1		; Note off on all operators of channel 6
00005E0C 4EBA 0000                  		jsr	WriteFMI(pc)
00005E10 103C 0042                  		move.b	#$42,d0		; TL for operator 1 of FM6
00005E14 727F                       		moveq	#$7F,d1		; Total silence
00005E16 4EBA 0000                  		jsr	WriteFMII(pc)
00005E1A 103C 004A                  		move.b	#$4A,d0		; TL for operator 3 of FM6
00005E1E 727F                       		moveq	#$7F,d1		; Total silence
00005E20 4EBA 0000                  		jsr	WriteFMII(pc)
00005E24 103C 0046                  		move.b	#$46,d0		; TL for operator 2 of FM6
00005E28 727F                       		moveq	#$7F,d1		; Total silence
00005E2A 4EBA 0000                  		jsr	WriteFMII(pc)
00005E2E 103C 004E                  		move.b	#$4E,d0		; TL for operator 4 of FM6
00005E32 727F                       		moveq	#$7F,d1		; Total silence
00005E34 4EBA 0000                  		jsr	WriteFMII(pc)
00005E38 103C 00B6                  		move.b	#$B6,d0		; AMS/FMS/panning of FM6
00005E3C 123C 00C0                  		move.b	#$C0,d1		; Stereo
00005E40 4EBA 0000                  		jsr	WriteFMII(pc)
00005E44                            
00005E44                            @bgm_fmdone:
00005E44 7E00                       		moveq	#0,d7
00005E46 1E2B 0003                  		move.b	3(a3),d7	; Load number of PSG channels
00005E4A 6700                       		beq.s	@bgm_psgdone	; branch if zero
00005E4C 5307                       		subq.b	#1,d7
00005E4E 43EE 0190                  		lea	v_psg1_track(a6),a1
00005E52 45FA 0000                  		lea	PSGInitBytes(pc),a2
00005E56                            
00005E56                            @bgm_psgloadloop:
00005E56 08D1 0007                  		bset	#7,(a1)		; Initial playback control: set 'track playing' bit
00005E5A 135A 0001                  		move.b	(a2)+,1(a1)	; Voice control bits
00005E5E 1344 0002                  		move.b	d4,2(a1)
00005E62 1346 000D                  		move.b	d6,$D(a1)	; set "gosub" (coord flag F8h) stack init value
00005E66 1345 000E                  		move.b	d5,$E(a1)	; Set duration of first "note"
00005E6A 7000                       		moveq	#0,d0
00005E6C 301C                       		move.w	(a4)+,d0	; load PSG channel pointer
00005E6E D08B                       		add.l	a3,d0		; Relative pointer
00005E70 2340 0004                  		move.l	d0,4(a1)	; Store track pointer
00005E74 335C 0008                  		move.w	(a4)+,8(a1)	; load PSG modifier
00005E78 101C                       		move.b	(a4)+,d0	; load redundant byte
00005E7A 135C 000B                  		move.b	(a4)+,$B(a1)	; Initial PSG tone
00005E7E D2C6                       		adda.w	d6,a1
00005E80 51CF FFD4                  		dbf	d7,@bgm_psgloadloop
00005E84                            
00005E84                            @bgm_psgdone:
00005E84 43EE 0220                  		lea	v_sfx_fm3_track(a6),a1
00005E88 7E05                       		moveq	#5,d7		; 6 SFX tracks
00005E8A                            
00005E8A                            @sfxstoploop:
00005E8A 4A11                       		tst.b	(a1)		; Is SFX playing?
00005E8C 6A00 0000                  		bpl.w	@sfxnext	; Branch if not
00005E90 7000                       		moveq	#0,d0
00005E92 1029 0001                  		move.b	1(a1),d0	; Get playback control bits
00005E96 6B00                       		bmi.s	@sfxpsgchannel	; Branch if this is a PSG channel
00005E98 5500                       		subq.b	#2,d0		; SFX can't have FM1 or FM2
00005E9A E508                       		lsl.b	#2,d0		; Convert to index
00005E9C 6000                       		bra.s	@gotchannelindex
00005E9E                            ; ===========================================================================
00005E9E                            
00005E9E                            @sfxpsgchannel:
00005E9E E608                       		lsr.b	#3,d0		; Convert to index
00005EA0                            
00005EA0                            @gotchannelindex:
00005EA0 41FA 0000                  		lea	BGMChannelRAM(pc),a0
00005EA4 2070 0000                  		movea.l	(a0,d0.w),a0
00005EA8 08D0 0002                  		bset	#2,(a0)		; Set 'SFX is overriding' bit
00005EAC                            
00005EAC                            @sfxnext:
00005EAC D2C6                       		adda.w	d6,a1
00005EAE 51CF FFDA                  		dbf	d7,@sfxstoploop
00005EB2                            
00005EB2 4A6E 0340                  		tst.w	v_sfx2_fm4_playback_control(a6)	; Is special SFX being played?
00005EB6 6A00                       		bpl.s	@checkspecialpsg		; Branch if not
00005EB8 08EE 0002 0100             		bset	#2,v_fm4_playback_control(a6)	; Set 'SFX is overriding' bit
00005EBE                            
00005EBE                            @checkspecialpsg:
00005EBE 4A6E 0370                  		tst.w	v_sfx2_psg3_playback_control(a6)	; Is special SFX being played?
00005EC2 6A00                       		bpl.s	@sendfmnoteoff		; Branch if not
00005EC4 08EE 0002 01F0             		bset	#2,v_psg3_playback_control(a6)	; Set 'SFX is overriding' bit
00005ECA                            
00005ECA                            @sendfmnoteoff:
00005ECA 4BEE 0070                  		lea	v_fm1_track(a6),a5
00005ECE 7805                       		moveq	#5,d4
00005ED0                            
00005ED0                            @fmnoteoffloop:
00005ED0 4EBA 0000                  		jsr	FMNoteOff(pc)
00005ED4 DAC6                       		adda.w	d6,a5
00005ED6 51CC FFF8                  		dbf	d4,@fmnoteoffloop	; run all FM channels
00005EDA 7802                       		moveq	#2,d4
00005EDC                            
00005EDC                            @psgnoteoffloop:
00005EDC 4EBA 0000                  		jsr	PSGNoteOff(pc)
00005EE0 DAC6                       		adda.w	d6,a5
00005EE2 51CC FFF8                  		dbf	d4,@psgnoteoffloop	; run all PSG channels
00005EE6                            
00005EE6                            @locdblret:
00005EE6 584F                       		addq.w	#4,sp	; Tamper with return value to not return to caller
00005EE8 4E75                       		rts	
00005EEA                            ; ===========================================================================
00005EEA 0600 0102 0405 0600        FMDACInitBytes:	dc.b 6,	0, 1, 2, 4, 5, 6, 0
00005EF2                            		even
00005EF2 80A0 C000                  PSGInitBytes:	dc.b $80, $A0, $C0, 0
00005EF6                            		even
00005EF6                            ; ===========================================================================
00005EF6                            ; ---------------------------------------------------------------------------
00005EF6                            ; Play normal sound effect
00005EF6                            ; ---------------------------------------------------------------------------
00005EF6                            
00005EF6                            Sound_PlaySFX:
00005EF6 4A2E 0027                  		tst.b	f_1up_playing(a6)	; Is 1-up playing?
00005EFA 6600 0000                  		bne.w	PlaySFX_ResetPrio	; Exit is it is
00005EFE 4A2E 0004                  		tst.b	v_fadeout_counter(a6)	; Is music being faded out?
00005F02 6600 0000                  		bne.w	PlaySFX_ResetPrio	; Exit if it is
00005F06 4A2E 0024                  		tst.b	f_fadein_flag(a6)	; Is music being faded in?
00005F0A 6600 0000                  		bne.w	PlaySFX_ResetPrio	; Exit if it is
00005F0E                            		
00005F0E 0C07 00D1                  		cmpi.b	#$D1,d7			; ++ is this Spin Dash sound?
00005F12 6700                       		beq.s	@DontResetRev
00005F14 422E 000F                  		clr.b	v_revsound(a6)
00005F18                            	@DontResetRev:
00005F18                            
00005F18 0C07 0000                  		cmpi.b	#sfx_Ring,d7		; is ring sound	effect played?
00005F1C 6600                       		bne.s	@sfx_notRing		; if not, branch
00005F1E 4A2E 002B                  		tst.b	v_ring_speaker(a6)	; Is the ring sound playing on right speaker?
00005F22 6600                       		bne.s	@gotringspeaker		; Branch if not
00005F24 1E3C 0000                  		move.b	#sfx_RingLeft,d7		; play ring sound in left speaker
00005F28                            
00005F28                            	@gotringspeaker:
00005F28 086E 0000 002B             		bchg	#0,v_ring_speaker(a6)	; change speaker
00005F2E                            
00005F2E                            	@sfx_notRing:
00005F2E 0C07 0000                  		cmpi.b	#sfx_Push,d7		; is "pushing" sound played?
00005F32 6600                       		bne.s	Sound_LoadSFX		; if not, branch
00005F34 4A2E 002C                  		tst.b	f_push_playing(a6)	; Is pushing sound already playing?
00005F38 6600 0000                  		bne.w	PlaySFX_Done		; Return if not
00005F3C 1D7C 0080 002C             		move.b	#$80,f_push_playing(a6)	; Mark it as playing
00005F42                            
00005F42                            ; ===========================================================================
00005F42                            Sound_LoadSFX:
00005F42 2079 0000 56AC             		movea.l	(Go_SoundIndex).l,a0
00005F48 0407 00A0                  		subi.b	#$A0,d7		; Make it 0-based
00005F4C E54F                       		lsl.w	#2,d7		; Convert sfx ID into index
00005F4E 2670 7000                  		movea.l	(a0,d7.w),a3	; SFX data pointer
00005F52 224B                       		movea.l	a3,a1
00005F54 7200                       		moveq	#0,d1
00005F56 3219                       		move.w	(a1)+,d1	; Voice pointer
00005F58 D28B                       		add.l	a3,d1		; Relative pointer
00005F5A 1A19                       		move.b	(a1)+,d5	; Dividing timing
00005F5C 1E19                       		move.b	(a1)+,d7	; Number of channels (FM + PSG)
00005F5E 5307                       		subq.b	#1,d7
00005F60 7C30                       		moveq	#zTrackSz,d6
00005F62                            
00005F62                            	@sfx_loadloop:
00005F62 7600                       		moveq	#0,d3
00005F64 1629 0001                  		move.b	1(a1),d3	; Channel assignment bits
00005F68 1803                       		move.b	d3,d4
00005F6A 6B00                       		bmi.s	@sfxinitpsg	; Branch if PSG
00005F6C 5543                       		subq.w	#2,d3		; SFX can only have FM3, FM4 or FM5
00005F6E E54B                       		lsl.w	#2,d3
00005F70 4BFA 0000                  		lea	BGMChannelRAM(pc),a5
00005F74 2A75 3000                  		movea.l	(a5,d3.w),a5
00005F78 08D5 0002                  		bset	#2,(a5)		; Mark music track as being overridden
00005F7C 6000                       		bra.s	@sfxoverridedone
00005F7E                            
00005F7E                            	@sfxinitpsg:
00005F7E E64B                       		lsr.w	#3,d3
00005F80 4BFA 0000                  		lea	BGMChannelRAM(pc),a5
00005F84 2A75 3000                  		movea.l	(a5,d3.w),a5
00005F88 08D5 0002                  		bset	#2,(a5)		; Mark music track as being overridden
00005F8C 0C04 00C0                  		cmpi.b	#$C0,d4		; Is this PSG 3?
00005F90 6600                       		bne.s	@sfxoverridedone	; Branch if not
00005F92 1004                       		move.b	d4,d0
00005F94 0000 001F                  		ori.b	#$1F,d0		; Command to silence PSG 3
00005F98 13C0 00C0 0011             		move.b	d0,(PSG).l
00005F9E 0840 0005                  		bchg	#5,d0		; Command to silence noise channel
00005FA2 13C0 00C0 0011             		move.b	d0,(PSG).l
00005FA8                            
00005FA8                            	@sfxoverridedone:
00005FA8 2A7B 3000                  		movea.l	SFXChannelRAM(pc,d3.w),a5
00005FAC 244D                       		movea.l	a5,a2
00005FAE 700B                       		moveq	#$B,d0	; $30 bytes
00005FB0                            
00005FB0                            	@clearsfxtrackram:
00005FB0 429A                       		clr.l	(a2)+
00005FB2 51C8 FFFC                  		dbf	d0,@clearsfxtrackram
00005FB6                            
00005FB6 3A99                       		move.w	(a1)+,(a5)	; Initial playback control bits
00005FB8 1B45 0002                  		move.b	d5,2(a5)	; Initial voice control bits
00005FBC 7000                       		moveq	#0,d0
00005FBE 3019                       		move.w	(a1)+,d0	; Track data pointer
00005FC0 D08B                       		add.l	a3,d0		; Relative pointer
00005FC2 2B40 0004                  		move.l	d0,4(a5)	; Store track pointer
00005FC6 3B59 0008                  		move.w	(a1)+,8(a5)	; load FM/PSG channel modifier
00005FCA 1B7C 0001 000E             		move.b	#1,$E(a5)	; Set duration of first "note"
00005FD0 1B46 000D                  		move.b	d6,$D(a5)	; set "gosub" (coord flag F8h) stack init value
00005FD4 4A04                       		tst.b	d4			; Is this a PSG channel?
00005FD6 6B00                       		bmi.s	@sfxpsginitdone	; Branch if yes
00005FD8 1B7C 00C0 000A             		move.b	#$C0,$A(a5)	; AMS/FMS/Panning
00005FDE 2B41 0020                  		move.l	d1,$20(a5)	; Voice pointer
00005FE2                            
00005FE2                            	@sfxpsginitdone:
00005FE2 51CF FF7E                  		dbf	d7,@sfx_loadloop
00005FE6                            
00005FE6 4A2E 0250                  		tst.b	v_sfx_fm4_playback_control(a6)	; Is special SFX being played?
00005FEA 6A00                       		bpl.s	@doneoverride		; Branch if not
00005FEC 08EE 0002 0340             		bset	#2,v_sfx2_fm4_playback_control(a6)	; Set SFX is overriding bit
00005FF2                            
00005FF2                            	@doneoverride:
00005FF2 4A2E 0310                  		tst.b	v_sfx_psg3_track(a6)	; Is special SFX being played?
00005FF6 6A00                       		bpl.s	PlaySFX_Done		; Branch if not
00005FF8 08EE 0002 0370             		bset	#2,v_sfx2_psg3_playback_control(a6)	; Set SFX is overriding bit
00005FFE                            
00005FFE                            PlaySFX_Done:
00005FFE 4E75                       		rts	
00006000                            ; ===========================================================================
00006000                            
00006000                            PlaySFX_ResetPrio:
00006000 4216                       		clr.b	v_sndprio(a6)		; Clear priority
00006002 4E75                       		rts	
00006004                            		
00006004                            
00006004                            ; ===========================================================================
00006004                            ; ---------------------------------------------------------------------------
00006004                            ; RAM addresses for FM and PSG channel variables
00006004                            ; ---------------------------------------------------------------------------
00006004 00FF F0D0                  BGMChannelRAM:	dc.l (v_snddriver_ram+v_fm3_track)&$FFFFFF
00006008 0000 0000                  		dc.l 0
0000600C 00FF F100                  		dc.l (v_snddriver_ram+v_fm4_track)&$FFFFFF
00006010 00FF F130                  		dc.l (v_snddriver_ram+v_fm5_track)&$FFFFFF
00006014 00FF F190                  		dc.l (v_snddriver_ram+v_psg1_track)&$FFFFFF
00006018 00FF F1C0                  		dc.l (v_snddriver_ram+v_psg2_track)&$FFFFFF
0000601C 00FF F1F0                  		dc.l (v_snddriver_ram+v_psg3_track)&$FFFFFF	; Plain PSG3
00006020 00FF F1F0                  		dc.l (v_snddriver_ram+v_psg3_track)&$FFFFFF	; Noise
00006024 00FF F220                  SFXChannelRAM:	dc.l (v_snddriver_ram+v_sfx_fm3_track)&$FFFFFF
00006028 0000 0000                  		dc.l 0
0000602C 00FF F250                  		dc.l (v_snddriver_ram+v_sfx_fm4_track)&$FFFFFF
00006030 00FF F280                  		dc.l (v_snddriver_ram+v_sfx_fm5_track)&$FFFFFF
00006034 00FF F2B0                  		dc.l (v_snddriver_ram+v_sfx_psg1_track)&$FFFFFF
00006038 00FF F2E0                  		dc.l (v_snddriver_ram+v_sfx_psg2_track)&$FFFFFF
0000603C 00FF F310                  		dc.l (v_snddriver_ram+v_sfx_psg3_track)&$FFFFFF	; Plain PSG3
00006040 00FF F310                  		dc.l (v_snddriver_ram+v_sfx_psg3_track)&$FFFFFF	; Noise
00006044                            ; ===========================================================================
00006044                            ; ---------------------------------------------------------------------------
00006044                            ; Play GHZ waterfall sound
00006044                            ; ---------------------------------------------------------------------------
00006044                            
00006044                            Sound_PlaySpecial:
00006044 4A2E 0027                  		tst.b	f_1up_playing(a6)	; Is 1-up playing?
00006048 6600 0000                  		bne.w	@locret		; Return if so
0000604C 4A2E 0004                  		tst.b	v_fadeout_counter(a6)	; Is music being faded out?
00006050 6600 0000                  		bne.w	@locret		; Exit if it is
00006054 4A2E 0024                  		tst.b	f_fadein_flag(a6)	; Is music being faded in?
00006058 6600 0000                  		bne.w	@locret		; Exit if it is
0000605C 2079 0000 56A0             		movea.l	(Go_SoundD0).l,a0
00006062 0407 00D0                  		subi.b	#$D0,d7		; Make it 0-based
00006066 E54F                       		lsl.w	#2,d7
00006068 2670 7000                  		movea.l	(a0,d7.w),a3
0000606C 224B                       		movea.l	a3,a1
0000606E 7000                       		moveq	#0,d0
00006070 3019                       		move.w	(a1)+,d0	; Voice pointer
00006072 D08B                       		add.l	a3,d0		; Relative pointer
00006074 2D40 0020                  		move.l	d0,$20(a6)	; Store voice pointer
00006078 1A19                       		move.b	(a1)+,d5	; Dividing timing
0000607A 1E19                       		move.b	(a1)+,d7	; Number of channels (FM + PSG)
0000607C 5307                       		subq.b	#1,d7
0000607E 7C30                       		moveq	#zTrackSz,d6
00006080                            
00006080                            @sfxloadloop:
00006080 1829 0001                  		move.b	1(a1),d4	; Voice control bits
00006084 6B00                       		bmi.s	@sfxoverridepsg	; Branch if PSG
00006086 08EE 0002 0100             		bset	#2,v_fm4_playback_control(a6)	; Set SFX is overriding bit
0000608C 4BEE 0340                  		lea	v_sfx2_fm4_track(a6),a5
00006090 6000                       		bra.s	@sfxinitpsg
00006092                            ; ===========================================================================
00006092                            
00006092                            @sfxoverridepsg:
00006092 08EE 0002 01F0             		bset	#2,v_psg3_playback_control(a6)	; Set SFX is overriding bit
00006098 4BEE 0370                  		lea	v_sfx2_psg3_track(a6),a5
0000609C                            
0000609C                            @sfxinitpsg:
0000609C 244D                       		movea.l	a5,a2
0000609E 700B                       		moveq	#$B,d0
000060A0                            
000060A0                            @clearsfxtrackram:
000060A0 429A                       		clr.l	(a2)+
000060A2 51C8 FFFC                  		dbf	d0,@clearsfxtrackram
000060A6                            
000060A6 3A99                       		move.w	(a1)+,(a5)	; Initial playback control bits
000060A8 1B45 0002                  		move.b	d5,2(a5)	; Initial voice control bits
000060AC 7000                       		moveq	#0,d0
000060AE 3019                       		move.w	(a1)+,d0	; Track data pointer
000060B0 D08B                       		add.l	a3,d0		; Relative pointer
000060B2 2B40 0004                  		move.l	d0,4(a5)	; Store track pointer
000060B6 3B59 0008                  		move.w	(a1)+,8(a5)	; load FM/PSG channel modifier
000060BA 1B7C 0001 000E             		move.b	#1,$E(a5)	; Set duration of first "note"
000060C0 1B46 000D                  		move.b	d6,$D(a5)	; set "gosub" (coord flag F8h) stack init value
000060C4 4A04                       		tst.b	d4			; Is this a PSG channel?
000060C6 6B00                       		bmi.s	@sfxpsginitdone	; Branch if yes
000060C8 1B7C 00C0 000A             		move.b	#$C0,$A(a5)	; AMS/FMS/Panning
000060CE                            
000060CE                            @sfxpsginitdone:
000060CE 51CF FFB0                  		dbf	d7,@sfxloadloop
000060D2                            
000060D2 4A2E 0250                  		tst.b	v_sfx_fm4_playback_control(a6)	; Is track playing?
000060D6 6A00                       		bpl.s	@doneoverride	; Branch if not
000060D8 08EE 0002 0340             		bset	#2,v_sfx2_fm4_playback_control(a6)	; Set SFX is overriding track
000060DE                            
000060DE                            @doneoverride:
000060DE 4A2E 0310                  		tst.b	v_sfx_psg3_playback_control(a6)	; Is track playing?
000060E2 6A00                       		bpl.s	@locret		; Branch if not
000060E4 08EE 0002 0370             		bset	#2,v_sfx2_psg3_playback_control(a6)	; Set SFX is overriding track
000060EA 0004 001F                  		ori.b	#$1F,d4		; Command to silence channel
000060EE 13C4 00C0 0011             		move.b	d4,(PSG).l
000060F4 0844 0005                  		bchg	#5,d4		; Command to silence noise channel
000060F8 13C4 00C0 0011             		move.b	d4,(PSG).l
000060FE                            
000060FE                            @locret:
000060FE 4E75                       		rts	
00006100                            ; End of function Sound_ChkValue
00006100                            
00006100                            ; ===========================================================================
00006100                            ; Unused
00006100 00FF F100                  		dc.l (v_snddriver_ram+v_fm4_track)&$FFFFFF
00006104 00FF F1F0                  		dc.l (v_snddriver_ram+v_psg3_track)&$FFFFFF
00006108 00FF F250                  		dc.l (v_snddriver_ram+v_sfx_fm4_track)&$FFFFFF
0000610C 00FF F310                  		dc.l (v_snddriver_ram+v_sfx_psg3_track)&$FFFFFF
00006110 00FF F340                  		dc.l (v_snddriver_ram+v_sfx2_fm4_track)&$FFFFFF
00006114 00FF F370                  		dc.l (v_snddriver_ram+v_sfx2_psg3_track)&$FFFFFF
00006118                            
00006118                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006118                            
00006118                            
00006118                            Snd_FadeOutSFX:
00006118 4216                       		clr.b	v_sndprio(a6)		; Clear priority
0000611A 4BEE 0220                  		lea	v_sfx_track_ram(a6),a5
0000611E 7E05                       		moveq	#5,d7
00006120                            
00006120                            @trackloop:
00006120 4A15                       		tst.b	(a5)		; Is track playing?
00006122 6A00 0000                  		bpl.w	@nexttrack	; Branch if not
00006126 0895 0007                  		bclr	#7,(a5)		; Stop track
0000612A 7600                       		moveq	#0,d3
0000612C 162D 0001                  		move.b	1(a5),d3	; Get voice control bits
00006130 6B00                       		bmi.s	@trackpsg	; Branch if PSG
00006132 4EBA 0000                  		jsr	FMNoteOff(pc)
00006136 0C03 0004                  		cmpi.b	#4,d3		; Is this FM4?
0000613A 6600                       		bne.s	@getfmpointer	; Branch if not
0000613C 4A2E 0340                  		tst.b	v_sfx2_fm4_playback_control(a6)	; Is special SFX playing?
00006140 6A00                       		bpl.s	@getfmpointer	; Branch if not
00006142 264D                       		movea.l	a5,a3
00006144                            		; DANGER! there is a missing 'movea.l	a5,a3' here, without which the
00006144                            		; code is broken. It is dangerous to do a fade out when a GHZ waterfall
00006144                            		; is playing its sound!
00006144 4BEE 0340                  		lea	v_sfx2_fm4_track(a6),a5
00006148 226E 0020                  		movea.l	v_special_voice_ptr(a6),a1	; Get special voice pointer
0000614C 6000                       		bra.s	@gotfmpointer
0000614E                            ; ===========================================================================
0000614E                            
0000614E                            @getfmpointer:
0000614E 5503                       		subq.b	#2,d3		; SFX only has FM3 and up
00006150 E50B                       		lsl.b	#2,d3
00006152 41FA FEB0                  		lea	BGMChannelRAM(pc),a0
00006156 264D                       		movea.l	a5,a3
00006158 2A70 3000                  		movea.l	(a0,d3.w),a5
0000615C 226E 0018                  		movea.l	v_voice_ptr(a6),a1	; Get music voice pointer
00006160                            
00006160                            @gotfmpointer:
00006160 0895 0002                  		bclr	#2,(a5)		; Clear SFX is overriding bit
00006164 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00006168 102D 000B                  		move.b	$B(a5),d0	; Current voice
0000616C 4EBA 0000                  		jsr	SetVoice(pc)
00006170 2A4B                       		movea.l	a3,a5
00006172 6000                       		bra.s	@nexttrack
00006174                            ; ===========================================================================
00006174                            
00006174                            @trackpsg:
00006174 4EBA 0000                  		jsr	PSGNoteOff(pc)
00006178 41EE 0370                  		lea	v_sfx2_psg3_track(a6),a0
0000617C 0C03 00E0                  		cmpi.b	#$E0,d3		; Is this a noise channel:
00006180 6700                       		beq.s	@gotpsgpointer	; Branch if yes
00006182 0C03 00C0                  		cmpi.b	#$C0,d3		; Is this PSG 3?
00006186 6700                       		beq.s	@gotpsgpointer	; Branch if yes
00006188 E60B                       		lsr.b	#3,d3
0000618A 41FA FE78                  		lea	BGMChannelRAM(pc),a0
0000618E 2070 3000                  		movea.l	(a0,d3.w),a0
00006192                            
00006192                            @gotpsgpointer:
00006192 0890 0002                  		bclr	#2,(a0)		; Clear SFX is overriding bit
00006196 08D0 0001                  		bset	#1,(a0)		; Set track at rest bit
0000619A 0C28 00E0 0001             		cmpi.b	#$E0,1(a0)	; Is this a noise channel?
000061A0 6600                       		bne.s	@nexttrack	; Branch if not
000061A2 13E8 001F 00C0 0011        		move.b	$1F(a0),(PSG).l	; Set noise type
000061AA                            
000061AA                            @nexttrack:
000061AA DAFC 0030                  		adda.w	#zTrackSz,a5
000061AE 51CF FF70                  		dbf	d7,@trackloop
000061B2                            
000061B2 4E75                       		rts	
000061B4                            ; End of function Snd_FadeOutSFX
000061B4                            
000061B4                            
000061B4                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000061B4                            
000061B4                            
000061B4                            Snd_FadeOutSFX2:
000061B4 4BEE 0340                  		lea	v_sfx2_fm4_track(a6),a5
000061B8 4A15                       		tst.b	(a5)		; Is track playing?
000061BA 6A00                       		bpl.s	@fadedfm	; Branch if not
000061BC 0895 0007                  		bclr	#7,(a5)		; Stop track
000061C0 0815 0002                  		btst	#2,(a5)		; Is SFX overriding?
000061C4 6600                       		bne.s	@fadedfm	; Branch if not
000061C6 4EBA 0000                  		jsr	SendFMNoteOff(pc)
000061CA 4BEE 0100                  		lea	v_fm4_track(a6),a5
000061CE 0895 0002                  		bclr	#2,(a5)		; Clear SFX is overriding bit
000061D2 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
000061D6 4A15                       		tst.b	(a5)		; Is track playing?
000061D8 6A00                       		bpl.s	@fadedfm	; Branch if not
000061DA 226E 0018                  		movea.l	v_voice_ptr(a6),a1	; Voice pointer
000061DE 102D 000B                  		move.b	$B(a5),d0	; Current voice
000061E2 4EBA 0000                  		jsr	SetVoice(pc)
000061E6                            
000061E6                            @fadedfm:
000061E6 4BEE 0370                  		lea	v_sfx2_psg3_track(a6),a5
000061EA 4A15                       		tst.b	(a5)		; Is track playing?
000061EC 6A00                       		bpl.s	@fadedpsg	; Branch if not
000061EE 0895 0007                  		bclr	#7,(a5)		; Stop track
000061F2 0815 0002                  		btst	#2,(a5)		; Is SFX overriding?
000061F6 6600                       		bne.s	@fadedpsg	; Return if not
000061F8 4EBA 0000                  		jsr	SendPSGNoteOff(pc)
000061FC 4BEE 01F0                  		lea	v_psg3_track(a6),a5
00006200 0895 0002                  		bclr	#2,(a5)		; Clear SFX is overriding bit
00006204 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00006208 4A15                       		tst.b	(a5)		; Is track playing?
0000620A 6A00                       		bpl.s	@fadedpsg	; Return if not
0000620C 0C2D 00E0 0001             		cmpi.b	#$E0,1(a5)	; Is this a noise channel?
00006212 6600                       		bne.s	@fadedpsg	; Return if not
00006214 13ED 001F 00C0 0011        		move.b	$1F(a5),(PSG).l	; Set noise type
0000621C                            
0000621C                            @fadedpsg:
0000621C 4E75                       		rts
0000621E                            ; End of function Snd_FadeOutSFX2
0000621E                            
0000621E                            ; ===========================================================================
0000621E                            ; ---------------------------------------------------------------------------
0000621E                            ; Fade out music
0000621E                            ; ---------------------------------------------------------------------------
0000621E                            
0000621E                            FadeOutMusic:
0000621E 4EBA FEF8                  		jsr	Snd_FadeOutSFX(pc)
00006222 4EBA FF90                  		jsr	Snd_FadeOutSFX2(pc)
00006226 1D7C 0003 0006             		move.b	#3,v_fadeout_delay(a6)		; Set fadeout delay to 3
0000622C 1D7C 0028 0004             		move.b	#$28,v_fadeout_counter(a6)		; Set fadeout counter
00006232 422E 0040                  		clr.b	v_dac_playback_control(a6)	; Stop DAC track
00006236 422E 002A                  		clr.b	f_speedup(a6)	; Disable speed shoes tempo
0000623A 4E75                       		rts
0000623C                            
0000623C                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000623C                            
0000623C                            
0000623C                            DoFadeOut:
0000623C 102E 0006                  		move.b	v_fadeout_delay(a6),d0	; Has fadeout delay expired?
00006240 6700                       		beq.s	@continuefade	; Branch if yes
00006242 532E 0006                  		subq.b	#1,v_fadeout_delay(a6)
00006246 4E75                       		rts
00006248                            ; ===========================================================================
00006248                            
00006248                            @continuefade:
00006248                            
00006248                            ;	; Fade out CD track
00006248                            ;	tst.b	v_cda_playing(a6)
00006248                            ;	beq.s	@0
00006248                            ;	moveq	#0,d0
00006248                            ;	move.b	v_fadeout_counter(a6),d0
00006248                            ;	mulu.w	#$19,d0
00006248                            ;	mcdsend	#_MCD_SetVolume, d0, .w
00006248                            ;@0
00006248                            
00006248 532E 0004                  		subq.b	#1,v_fadeout_counter(a6)	; Update fade counter
0000624C 6700 0000                  		beq.w	StopSoundAndMusic	; Branch if fade is done
00006250 1D7C 0003 0006             		move.b	#3,v_fadeout_delay(a6)	; Reset fade delay
00006256 4BEE 0070                  		lea	v_fm1_track(a6),a5
0000625A 7E05                       		moveq	#5,d7
0000625C                            
0000625C                            @fmloop:
0000625C 4A15                       		tst.b	(a5)		; Is track playing?
0000625E 6A00                       		bpl.s	@nextfm	; Branch if not
00006260 522D 0009                  		addq.b	#1,9(a5)	; Increase volume attenuation
00006264 6A00                       		bpl.s	@sendfmtl	; Branch if still positive
00006266 0895 0007                  		bclr	#7,(a5)		; Stop track
0000626A 6000                       		bra.s	@nextfm
0000626C                            ; ===========================================================================
0000626C                            
0000626C                            @sendfmtl:
0000626C 4EBA 0000                  		jsr	SendVoiceTL(pc)
00006270                            
00006270                            @nextfm:
00006270 DAFC 0030                  		adda.w	#zTrackSz,a5
00006274 51CF FFE6                  		dbf	d7,@fmloop
00006278                            
00006278 7E02                       		moveq	#2,d7
0000627A                            
0000627A                            @psgloop:
0000627A 4A15                       		tst.b	(a5)		; Is track playing?
0000627C 6A00                       		bpl.s	@nextpsg	; branch if not
0000627E 522D 0009                  		addq.b	#1,9(a5)	; Increase volume attenuation
00006282 0C2D 0010 0009             		cmpi.b	#$10,9(a5)	; Is it greater than $F?
00006288 6500                       		blo.s	@sendpsgvol	; Branch if not
0000628A 0895 0007                  		bclr	#7,(a5)		; Stop track
0000628E 6000                       		bra.s	@nextpsg
00006290                            ; ===========================================================================
00006290                            
00006290                            @sendpsgvol:
00006290 1C2D 0009                  		move.b	9(a5),d6	;Store new volume attenuation
00006294 4EBA 0000                  		jsr	SetPSGVolume(pc)
00006298                            
00006298                            @nextpsg:
00006298 DAFC 0030                  		adda.w	#zTrackSz,a5
0000629C 51CF FFDC                  		dbf	d7,@psgloop
000062A0                            
000062A0 4E75                       		rts	
000062A2                            ; End of function DoFadeOut
000062A2                            
000062A2                            
000062A2                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000062A2                            
000062A2                            
000062A2                            FMSilenceAll:
000062A2 7602                       		moveq	#2,d3		; 3 FM channels for each YM2612 parts
000062A4 7028                       		moveq	#$28,d0		; FM key on/off register
000062A6                            
000062A6                            @noteoffloop:
000062A6 1203                       		move.b	d3,d1
000062A8 4EBA 0000                  		jsr	WriteFMI(pc)
000062AC 5801                       		addq.b	#4,d1		; Move to YM2612 part 1
000062AE 4EBA 0000                  		jsr	WriteFMI(pc)
000062B2 51CB FFF2                  		dbf	d3,@noteoffloop
000062B6                            
000062B6 7040                       		moveq	#$40,d0		; Set TL on FM channels...
000062B8 727F                       		moveq	#$7F,d1		; ... to total attenuation...
000062BA 7802                       		moveq	#2,d4		; ... for all 3 channels...
000062BC                            
000062BC                            @channelloop:
000062BC 7603                       		moveq	#3,d3		; ... for all operators on each channel...
000062BE                            
000062BE                            @channeltlloop:
000062BE 4EBA 0000                  		jsr	WriteFMI(pc)	; ... for part 0...
000062C2 4EBA 0000                  		jsr	WriteFMII(pc)	; ... and part 1.
000062C6 5840                       		addq.w	#4,d0		; Next TL operator
000062C8 51CB FFF4                  		dbf	d3,@channeltlloop
000062CC                            
000062CC 0400 000F                  		subi.b	#$F,d0		; Move to TL operator 1 of next channel
000062D0 51CC FFEA                  		dbf	d4,@channelloop
000062D4                            
000062D4 4E75                       		rts	
000062D6                            ; End of function FMSilenceAll
000062D6                            
000062D6                            ; ===========================================================================
000062D6                            ; ---------------------------------------------------------------------------
000062D6                            ; Stop music
000062D6                            ; ---------------------------------------------------------------------------
000062D6                            
000062D6                            StopSoundAndMusic:
000062D6                            
000062D6                            ;	; If CDA is playing, stop it
000062D6                            ;	tst.b	v_cda_playing(a6)
000062D6                            ;	beq.s	@NoCD
000062D6                            ;	mcdsend	#_MCD_StopTrack
000062D6                            ;	sf.b	v_cda_playing(a6)
000062D6                            ;@NoCD
000062D6                            
000062D6 702B                       		moveq	#$2B,d0		; Enable/disable DAC
000062D8 123C 0080                  		move.b	#$80,d1		; Enable DAC
000062DC 4EBA 0000                  		jsr	WriteFMI(pc)
000062E0 7027                       		moveq	#$27,d0		; Timers, FM3/FM6 mode
000062E2 7200                       		moveq	#0,d1		; FM3/FM6 normal mode, disable timers
000062E4 4EBA 0000                  		jsr	WriteFMI(pc)
000062E8 204E                       		movea.l	a6,a0
000062EA 303C 00E3                  		move.w	#$E3,d0		; Clear $390 bytes
000062EE                            
000062EE                            @clearramloop:
000062EE 4298                       		clr.l	(a0)+
000062F0 51C8 FFFC                  		dbf	d0,@clearramloop
000062F4                            
000062F4 33FC 0100 00A1 1100 4E71+  		stopZ80
0000630C 13FC 0080 00A0 1FFF        		move.b	#$80,($A01FFF).l ; stop DAC playback
00006314 33FC 0000 00A1 1100        		startZ80
0000631C                            
0000631C 1D7C 0080 0009             		move.b	#$80,v_playsnd0(a6)	; set music to $80 (silence)
00006322 4EBA FF7E                  		jsr	FMSilenceAll(pc)
00006326 6000 0000                  		bra.w	PSGSilenceAll
0000632A                            
0000632A                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000632A                            
0000632A                            
0000632A                            InitMusicPlayback:
0000632A 204E                       		movea.l	a6,a0
0000632C                            		; Save several values
0000632C 1216                       		move.b	v_sndprio(a6),d1
0000632E 142E 0027                  		move.b	f_1up_playing(a6),d2
00006332 162E 002A                  		move.b	f_speedup(a6),d3
00006336 182E 0026                  		move.b	v_fadein_counter(a6),d4
0000633A 2A2E 000A                  		move.l	v_playsnd1(a6),d5	; fixed to L
0000633E                            
0000633E 7021                       		moveq	#$220/$10-1,d0		; Clear $220 bytes
00006340 7C00                       		moveq	#0,d6
00006342                            
00006342                            @clearramloop:
00006342 20C6                       		move.l	d6,(a0)+
00006344 20C6                       		move.l	d6,(a0)+
00006346 20C6                       		move.l	d6,(a0)+
00006348 20C6                       		move.l	d6,(a0)+
0000634A 51C8 FFF6                  		dbf	d0,@clearramloop
0000634E                            
0000634E                            		; Restore the values saved above
0000634E 1C81                       		move.b	d1,v_sndprio(a6)
00006350 1D42 0027                  		move.b	d2,f_1up_playing(a6)
00006354 1D43 002A                  		move.b	d3,f_speedup(a6)
00006358 1D44 0026                  		move.b	d4,v_fadein_counter(a6)
0000635C 2D45 000A                  		move.l	d5,v_playsnd1(a6)	; fixed to L
00006360 1D7C 0080 0009             		move.b	#$80,v_playsnd0(a6)	; set music to $80 (silence)
00006366                            
00006366 51EE 0007                  		sf.b	v_extension(a6)		; reset extension flague
0000636A 4EB9 0000 0000             		jsr	TS_InitExtChannels	; ++
00006370 4EBA FF30                  		jsr	FMSilenceAll(pc)
00006374 6000 0000                  		bra.w	PSGSilenceAll
00006378                            ; End of function InitMusicPlayback
00006378                            
00006378                            
00006378                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006378                            
00006378                            
00006378                            TempoWait:
00006378 1D6E 0002 0001             		move.b	v_main_tempo(a6),v_main_tempo_timeout(a6)	; Reset main tempo timeout
0000637E 41EE 004E                  		lea	v_dac_note_timeout(a6),a0
00006382 7030                       		moveq	#zTrackSz,d0
00006384 7209                       		moveq	#9,d1	; [(1 DAC + 6 FM) or (7 FM)] + 3 PSG
00006386                            
00006386                            @tempoloop:
00006386 5210                       		addq.b	#1,(a0)	; Delay note by 1 frame
00006388 D0C0                       		adda.w	d0,a0	; Advance to next track
0000638A 51C9 FFFA                  		dbf	d1,@tempoloop
0000638E                            
0000638E 4E75                       		rts	
00006390                            ; End of function TempoWait
00006390                            
00006390                            ; ===========================================================================
00006390                            ; ---------------------------------------------------------------------------
00006390                            ; Speed	up music
00006390                            ; ---------------------------------------------------------------------------
00006390                            
00006390                            SpeedUpMusic:
00006390 4A2E 0027                  		tst.b	f_1up_playing(a6)
00006394 6600                       		bne.s	@speedup_1up
00006396 1D6E 0029 0002             		move.b	v_speeduptempo(a6),v_main_tempo(a6)
0000639C 1D6E 0029 0001             		move.b	v_speeduptempo(a6),v_main_tempo_timeout(a6)
000063A2 1D7C 0080 002A             		move.b	#$80,f_speedup(a6)
000063A8 4E75                       		rts	
000063AA                            ; ===========================================================================
000063AA                            
000063AA                            @speedup_1up:
000063AA 1D6E 03C9 03A2             		move.b	v_1up_ram_copy+v_speeduptempo(a6),v_1up_ram_copy+v_main_tempo(a6)
000063B0 1D6E 03C9 03A1             		move.b	v_1up_ram_copy+v_speeduptempo(a6),v_1up_ram_copy+v_main_tempo_timeout(a6)
000063B6 1D7C 0080 03CA             		move.b	#$80,v_1up_ram_copy+f_speedup(a6)
000063BC 4E75                       		rts	
000063BE                            ; ===========================================================================
000063BE                            ; ---------------------------------------------------------------------------
000063BE                            ; Change music back to normal speed
000063BE                            ; ---------------------------------------------------------------------------
000063BE                            
000063BE                            SlowDownMusic:
000063BE 4A2E 0027                  		tst.b	f_1up_playing(a6)
000063C2 6600                       		bne.s	@slowdown_1up
000063C4 1D6E 0028 0002             		move.b	v_tempo_mod(a6),v_main_tempo(a6)
000063CA 1D6E 0028 0001             		move.b	v_tempo_mod(a6),v_main_tempo_timeout(a6)
000063D0 422E 002A                  		clr.b	f_speedup(a6)
000063D4 4E75                       		rts	
000063D6                            ; ===========================================================================
000063D6                            
000063D6                            @slowdown_1up:
000063D6 1D6E 03C8 03A2             		move.b	v_1up_ram_copy+v_tempo_mod(a6),v_1up_ram_copy+v_main_tempo(a6)
000063DC 1D6E 03C8 03A1             		move.b	v_1up_ram_copy+v_tempo_mod(a6),v_1up_ram_copy+v_main_tempo_timeout(a6)
000063E2 422E 03CA                  		clr.b	v_1up_ram_copy+f_speedup(a6)
000063E6 4E75                       		rts	
000063E8                            
000063E8                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000063E8                            
000063E8                            
000063E8                            DoFadeIn:
000063E8 4A2E 0025                  		tst.b	v_fadein_delay(a6)	; Has fadein delay expired?
000063EC 6700                       		beq.s	@continuefade		; Branch if yes
000063EE 532E 0025                  		subq.b	#1,v_fadein_delay(a6)
000063F2 4E75                       		rts	
000063F4                            ; ===========================================================================
000063F4                            
000063F4                            @continuefade:
000063F4 4A2E 0026                  		tst.b	v_fadein_counter(a6)	; Is fade done?
000063F8 6700                       		beq.s	@fadedone			; Branch if yes
000063FA 532E 0026                  		subq.b	#1,v_fadein_counter(a6)	; Update fade counter
000063FE 1D7C 0002 0025             		move.b	#2,v_fadein_delay(a6)	; Reset fade delay
00006404 4BEE 0070                  		lea	v_fm1_track(a6),a5
00006408 7E05                       		moveq	#5,d7
0000640A                            
0000640A                            @fmloop:
0000640A 4A15                       		tst.b	(a5)		; Is track playing?
0000640C 6A00                       		bpl.s	@nextfm	; Branch if not
0000640E 532D 0009                  		subq.b	#1,9(a5)	; Reduce volume attenuation
00006412 4EBA 0000                  		jsr	SendVoiceTL(pc)
00006416                            
00006416                            @nextfm:
00006416 DAFC 0030                  		adda.w	#zTrackSz,a5
0000641A 51CF FFEE                  		dbf	d7,@fmloop
0000641E 7E02                       		moveq	#2,d7
00006420                            
00006420                            @psgloop:
00006420 4A15                       		tst.b	(a5)		; Is track playing?
00006422 6A00                       		bpl.s	@nextpsg	; Branch if not
00006424 532D 0009                  		subq.b	#1,9(a5)	; Reduce volume attenuation
00006428 1C2D 0009                  		move.b	9(a5),d6	; Get value
0000642C 0C06 0010                  		cmpi.b	#$10,d6		; Is it is < $10?
00006430 6500                       		blo.s	@sendpsgvol	; Branch if yes
00006432 7C0F                       		moveq	#$F,d6		; Limit to $F (maximum attenuation)
00006434                            
00006434                            @sendpsgvol:
00006434 4EBA 0000                  		jsr	SetPSGVolume(pc)
00006438                            
00006438                            @nextpsg:
00006438 DAFC 0030                  		adda.w	#zTrackSz,a5
0000643C 51CF FFE2                  		dbf	d7,@psgloop
00006440 4E75                       		rts	
00006442                            ; ===========================================================================
00006442                            
00006442                            @fadedone:
00006442 08AE 0002 0040             		bclr	#2,v_dac_playback_control(a6)	; Clear SFX overriding bit
00006448 422E 0024                  		clr.b	f_fadein_flag(a6)		; Stop fadein
0000644C 4E75                       		rts	
0000644E                            ; End of function DoFadeIn
0000644E                            
0000644E                            ; ===========================================================================
0000644E                            
0000644E                            FMNoteOn:
0000644E 0815 0001                  		btst	#1,(a5)		; Is track resting?
00006452 6600                       		bne.s	@locret		; Return if so
00006454 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
00006458 6600                       		bne.s	@locret		; Return if so
0000645A 7028                       		moveq	#$28,d0		; Note on/off register
0000645C 122D 0001                  		move.b	1(a5),d1	; Get channel bits
00006460 0001 00F0                  		ori.b	#$F0,d1		; Note on on all operators
00006464 6000 0000                  		bra.w	WriteFMI
00006468                            ; ===========================================================================
00006468                            
00006468                            @locret:
00006468 4E75                       		rts	
0000646A                            
0000646A                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000646A                            
0000646A                            
0000646A                            FMNoteOff:
0000646A 0815 0004                  		btst	#4,(a5)		; Is 'do not attack next note' set?
0000646E 6600                       		bne.s	locret_72714	; Return if yes
00006470 0815 0002                  		btst	#2,(a5)		; Is SFX overriding?
00006474 6600                       		bne.s	locret_72714	; Return if yes
00006476                            
00006476                            SendFMNoteOff:
00006476 7028                       		moveq	#$28,d0		; Note on/off register
00006478 122D 0001                  		move.b	1(a5),d1	; Note off to this channel
0000647C 6000 0000                  		bra.w	WriteFMI
00006480                            ; ===========================================================================
00006480                            
00006480                            locret_72714:
00006480 4E75                       		rts	
00006482                            ; End of function FMNoteOff
00006482                            
00006482                            ; ===========================================================================
00006482                            
00006482                            WriteFMIorIIMain:
00006482 0815 0002                  		btst	#2,(a5)		; Is track being overriden by sfx?
00006486 6600                       		bne.s	@locret	; Return if yes
00006488 6000 0000                  		bra.w	WriteFMIorII
0000648C                            ; ===========================================================================
0000648C                            
0000648C                            @locret:
0000648C 4E75                       		rts	
0000648E                            
0000648E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000648E                            
0000648E                            
0000648E                            WriteFMIorII:
0000648E 082D 0002 0001             		btst	#2,1(a5)	; Is this bound for part I or II?
00006494 6600                       		bne.s	WriteFMIIPart	; Branch if for part II
00006496 D02D 0001                  		add.b	1(a5),d0	; Add in voice control bits
0000649A                            ; End of function WriteFMIorII
0000649A                            
0000649A                            
0000649A                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000649A                            
0000649A                            
0000649A                            WriteFMI:
0000649A 33FC 0100 00A1 1100 4E71+  		stopZ80
000064B2 1439 00A0 4000 0802 0007+  		waitYM
000064BE 13C0 00A0 4000             		move.b	d0,($A04000).l
000064C4 1439 00A0 4000 0802 0007+  		waitYM
000064D0 13C1 00A0 4001             		move.b	d1,($A04001).l
000064D6 1439 00A0 4000 0802 0007+  		waitYM
000064E2 13FC 002A 00A0 4000        		move.b	#$2A,($A04000).l
000064EA 33FC 0000 00A1 1100        		startZ80
000064F2 4E75                       		rts
000064F4                            ; End of function WriteFMI
000064F4                            
000064F4                            ; ===========================================================================
000064F4                            
000064F4                            WriteFMIIPart:
000064F4 142D 0001                  		move.b	1(a5),d2	; Get voice control bits
000064F8 0882 0002                  		bclr	#2,d2		; Clear chip toggle
000064FC D002                       		add.b	d2,d0		; Add in to destination register
000064FE                            
000064FE                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000064FE                            
000064FE                            
000064FE                            WriteFMII:
000064FE 33FC 0100 00A1 1100 4E71+  		stopZ80
00006516 1439 00A0 4000 0802 0007+  		waitYM
00006522 13C0 00A0 4002             		move.b	d0,($A04002).l
00006528 1439 00A0 4000 0802 0007+  		waitYM
00006534 13C1 00A0 4003             		move.b	d1,($A04003).l
0000653A 1439 00A0 4000 0802 0007+  		waitYM
00006546 13FC 002A 00A0 4000        		move.b	#$2A,($A04000).l
0000654E 33FC 0000 00A1 1100        		startZ80
00006556 4E75                       		rts
00006558                            ; End of function WriteFMII
00006558                            
00006558                            ; ===========================================================================
00006558                            ; ---------------------------------------------------------------------------
00006558                            ; FM Note Values: b-0 to a#8
00006558                            ; ---------------------------------------------------------------------------
00006558                            FM_Notes:
00006558 025E 0284 02AB 02D3 02FE+  	dc.w $025E,$0284,$02AB,$02D3,$02FE,$032D,$035C,$038F,$03C5,$03FF,$043C,$047C
00006570 0A5E 0A84 0AAB 0AD3 0AFE+  	dc.w $0A5E,$0A84,$0AAB,$0AD3,$0AFE,$0B2D,$0B5C,$0B8F,$0BC5,$0BFF,$0C3C,$0C7C
00006588 125E 1284 12AB 12D3 12FE+  	dc.w $125E,$1284,$12AB,$12D3,$12FE,$132D,$135C,$138F,$13C5,$13FF,$143C,$147C
000065A0 1A5E 1A84 1AAB 1AD3 1AFE+  	dc.w $1A5E,$1A84,$1AAB,$1AD3,$1AFE,$1B2D,$1B5C,$1B8F,$1BC5,$1BFF,$1C3C,$1C7C
000065B8 225E 2284 22AB 22D3 22FE+  	dc.w $225E,$2284,$22AB,$22D3,$22FE,$232D,$235C,$238F,$23C5,$23FF,$243C,$247C
000065D0 2A5E 2A84 2AAB 2AD3 2AFE+  	dc.w $2A5E,$2A84,$2AAB,$2AD3,$2AFE,$2B2D,$2B5C,$2B8F,$2BC5,$2BFF,$2C3C,$2C7C
000065E8 325E 3284 32AB 32D3 32FE+  	dc.w $325E,$3284,$32AB,$32D3,$32FE,$332D,$335C,$338F,$33C5,$33FF,$343C,$347C
00006600 3A5E 3A84 3AAB 3AD3 3AFE+  	dc.w $3A5E,$3A84,$3AAB,$3AD3,$3AFE,$3B2D,$3B5C,$3B8F,$3BC5,$3BFF,$3C3C,$3C7C
00006618                            
00006618                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006618                            
00006618                            
00006618                            PSGUpdateTrack:
00006618 532D 000E                  		subq.b	#1,$E(a5)		; Update note timeout
0000661C 6600                       		bne.s	@notegoing
0000661E 0895 0004                  		bclr	#4,(a5)			; Clear 'do not attack note' flag
00006622 4EBA 0000                  		jsr	PSGDoNext(pc)
00006626 4EBA 0000                  		jsr	PSGDoNoteOn(pc)
0000662A 6000 0000                  		bra.w	PSGDoVolFX
0000662E                            ; ===========================================================================
0000662E                            
0000662E                            @notegoing:
0000662E 4EBA F498                  		jsr	NoteFillUpdate(pc)
00006632 4EBA 0000                  		jsr	PSGUpdateVolFX(pc)
00006636 4EBA F4B8                  		jsr	DoModulation(pc)
0000663A 4EBA 0000                  		jsr	PSGUpdateFreq(pc)
0000663E 4E75                       		rts	
00006640                            ; End of function PSGUpdateTrack
00006640                            
00006640                            
00006640                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006640                            
00006640                            
00006640                            PSGDoNext:
00006640 0895 0001                  		bclr	#1,(a5)		; Clear track at rest bit
00006644 286D 0004                  		movea.l	4(a5),a4	; Get track data pointer
00006648                            
00006648                            @noteloop:
00006648 7A00                       		moveq	#0,d5
0000664A 1A1C                       		move.b	(a4)+,d5	; Get byte from track
0000664C 0C05 00E0                  		cmpi.b	#$E0,d5		; Is it a coord. flag?
00006650 6500                       		blo.s	@gotnote	; Branch if not
00006652 4EBA 0000                  		jsr	CoordFlag(pc)
00006656 60F0                       		bra.s	@noteloop
00006658                            ; ===========================================================================
00006658                            
00006658                            @gotnote:
00006658 4A05                       		tst.b	d5			; Is it a note?
0000665A 6A00                       		bpl.s	@gotduration	; Branch if not
0000665C 4EBA 0000                  		jsr	PSGSetFreq(pc)
00006660 1A1C                       		move.b	(a4)+,d5	; Get another byte
00006662 4A05                       		tst.b	d5			; Is it a duration?
00006664 6A00                       		bpl.s	@gotduration	; Branch if yes
00006666 534C                       		subq.w	#1,a4		; Put byte back
00006668 6000 F420                  		bra.w	FinishTrackUpdate
0000666C                            ; ===========================================================================
0000666C                            
0000666C                            @gotduration:
0000666C 4EBA F3FC                  		jsr	SetDuration(pc)
00006670 6000 F418                  		bra.w	FinishTrackUpdate
00006674                            ; End of function PSGDoNext
00006674                            
00006674                            
00006674                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006674                            
00006674                            
00006674                            PSGSetFreq:
00006674 0405 0081                  		subi.b	#$81,d5		; Convert to 0-based index
00006678 6500                       		blo.s	@restpsg	; If $80, put track at rest
0000667A DA2D 0008                  		add.b	8(a5),d5	; Add in channel key displacement
0000667E 0245 007F                  		andi.w	#$7F,d5		; Clear high byte and sign bit
00006682 E34D                       		lsl.w	#1,d5
00006684 41FA 0000                  		lea	PSGFrequencies(pc),a0
00006688 3B70 5000 0010             		move.w	(a0,d5.w),$10(a5)	; Set new frequency
0000668E 6000 F3FA                  		bra.w	FinishTrackUpdate
00006692                            ; ===========================================================================
00006692                            
00006692                            @restpsg:
00006692 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00006696 3B7C FFFF 0010             		move.w	#-1,$10(a5)	; Invalidate note frequency
0000669C 4EBA F3EC                  		jsr	FinishTrackUpdate(pc)
000066A0 6000 0000                  		bra.w	PSGNoteOff
000066A4                            ; End of function PSGSetFreq
000066A4                            
000066A4                            
000066A4                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000066A4                            
000066A4                            
000066A4                            PSGDoNoteOn:
000066A4 3C2D 0010                  		move.w	$10(a5),d6	; Get note frequency
000066A8 6B00                       		bmi.s	PSGSetRest	; If invalid, branch
000066AA                            ; End of function PSGDoNoteOn
000066AA                            
000066AA                            
000066AA                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000066AA                            
000066AA                            
000066AA                            PSGUpdateFreq:
000066AA 102D 001E                  		move.b	$1E(a5),d0		; Get frequency note adjustment
000066AE 4880                       		ext.w	d0
000066B0 DC40                       		add.w	d0,d6		; Add to frequency
000066B2 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
000066B6 6600                       		bne.s	@locret		; Return if yes
000066B8 0815 0001                  		btst	#1,(a5)		; Is track at rest?
000066BC 6600                       		bne.s	@locret		; Return if yes
000066BE 102D 0001                  		move.b	1(a5),d0	; Get channel bits
000066C2 0C00 00E0                  		cmpi.b	#$E0,d0		; Is it a noise channel?
000066C6 6600                       		bne.s	@notnoise	; Branch if not
000066C8 103C 00C0                  		move.b	#$C0,d0		; Use PSG 3 channel bits
000066CC                            
000066CC                            @notnoise:
000066CC 3206                       		move.w	d6,d1
000066CE 0201 000F                  		andi.b	#$F,d1		; Low nibble of frequency
000066D2 8001                       		or.b	d1,d0		; Latch tone data to channel
000066D4 E84E                       		lsr.w	#4,d6		; Get upper 6 bits of frequency
000066D6 0206 003F                  		andi.b	#$3F,d6		; Send to latched channel
000066DA 13C0 00C0 0011             		move.b	d0,(PSG).l
000066E0 13C6 00C0 0011             		move.b	d6,(PSG).l
000066E6                            
000066E6                            @locret:
000066E6 4E75                       		rts	
000066E8                            ; End of function PSGUpdateFreq
000066E8                            
000066E8                            ; ===========================================================================
000066E8                            
000066E8                            PSGSetRest:
000066E8 08D5 0001                  		bset	#1,(a5)
000066EC 4E75                       		rts	
000066EE                            
000066EE                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
000066EE                            
000066EE                            
000066EE                            PSGUpdateVolFX:
000066EE 4A2D 000B                  		tst.b	$B(a5)		; Test PSG tone
000066F2 6700 0000                  		beq.w	locret_7298A	; Return if it is zero
000066F6                            
000066F6                            PSGDoVolFX:
000066F6 1C2D 0009                  		move.b	9(a5),d6	; Get volume
000066FA 7000                       		moveq	#0,d0
000066FC 102D 000B                  		move.b	$B(a5),d0	; Get PSG tone
00006700 6700                       		beq.s	SetPSGVolume
00006702 2079 0000 56B4             		movea.l	(Go_PSGIndex).l,a0
00006708 5340                       		subq.w	#1,d0
0000670A E548                       		lsl.w	#2,d0
0000670C 2070 0000                  		movea.l	(a0,d0.w),a0
00006710 102D 000C                  		move.b	$C(a5),d0	; Get flutter index
00006714 1030 0000                  		move.b	(a0,d0.w),d0	; Flutter value
00006718 522D 000C                  		addq.b	#1,$C(a5)	; Increment flutter index
0000671C 0800 0007                  		btst	#7,d0		; Is flutter value negative?
00006720 6700                       		beq.s	@gotflutter	; Branch if not
00006722 0C00 0080                  		cmpi.b	#$80,d0		; Is it the terminator?
00006726 6700                       		beq.s	FlutterDone	; If so, branch
00006728                            
00006728                            @gotflutter:
00006728 DC40                       		add.w	d0,d6		; Add flutter to volume
0000672A 0C06 0010                  		cmpi.b	#$10,d6		; Is volume $10 or higher?
0000672E 6500                       		blo.s	SetPSGVolume	; Branch if not
00006730 7C0F                       		moveq	#$F,d6		; Limit to silence and fall through
00006732                            ; End of function PSGUpdateVolFX
00006732                            
00006732                            
00006732                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006732                            
00006732                            
00006732                            SetPSGVolume:
00006732 0815 0001                  		btst	#1,(a5)		; Is track at rest?
00006736 6600                       		bne.s	locret_7298A	; Return if so
00006738 0815 0002                  		btst	#2,(a5)		; Is SFX overriding?
0000673C 6600                       		bne.s	locret_7298A	; Return if so
0000673E 0815 0004                  		btst	#4,(a5)		; Is track set to not attack next note?
00006742 6600                       		bne.s	PSGCheckNoteFill	; Branch if yes
00006744                            
00006744                            PSGSendVolume:
00006744 8C2D 0001                  		or.b	1(a5),d6	; Add in track selector bits
00006748 0606 0010                  		addi.b	#$10,d6		; Mark it as a volume command
0000674C 13C6 00C0 0011             		move.b	d6,(PSG).l
00006752                            
00006752                            locret_7298A:
00006752 4E75                       		rts	
00006754                            ; ===========================================================================
00006754                            
00006754                            PSGCheckNoteFill:
00006754 4A2D 0013                  		tst.b	$13(a5)		; Is note fill on?
00006758 67EA                       		beq.s	PSGSendVolume	; Branch if not
0000675A 4A2D 0012                  		tst.b	$12(a5)		; Has note fill timeout expired?
0000675E 66E4                       		bne.s	PSGSendVolume	; Branch if not
00006760 4E75                       		rts	
00006762                            ; End of function SetPSGVolume
00006762                            
00006762                            ; ===========================================================================
00006762                            
00006762                            FlutterDone:
00006762 532D 000C                  		subq.b	#1,$C(a5)	; Decrement flutter index
00006766 4E75                       		rts	
00006768                            
00006768                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006768                            
00006768                            
00006768                            PSGNoteOff:
00006768 0815 0002                  		btst	#2,(a5)		; Is SFX overriding?
0000676C 6600                       		bne.s	locret_729B4	; Return if so
0000676E                            
0000676E                            SendPSGNoteOff:
0000676E 102D 0001                  		move.b	1(a5),d0	; PSG channel to change
00006772 0000 001F                  		ori.b	#$1F,d0		; Maximum volume attenuation
00006776 13C0 00C0 0011             		move.b	d0,(PSG).l
0000677C                            
0000677C                            locret_729B4:
0000677C 4E75                       		rts	
0000677E                            ; End of function PSGNoteOff
0000677E                            
0000677E                            
0000677E                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
0000677E                            
0000677E                            
0000677E                            PSGSilenceAll:
0000677E 41F9 00C0 0011             		lea	(PSG).l,a0
00006784 10BC 009F                  		move.b	#$9F,(a0)	; Silence PSG 1
00006788 10BC 00BF                  		move.b	#$BF,(a0)	; Silence PSG 2
0000678C 10BC 00DF                  		move.b	#$DF,(a0)	; Silence PSG 3
00006790 10BC 00FF                  		move.b	#$FF,(a0)	; Silence noise channel
00006794 4E75                       		rts	
00006796                            ; End of function PSGSilenceAll
00006796                            
00006796                            ; ===========================================================================
00006796                            PSGFrequencies:
00006796 0356 0326 02F9 02CE 02A5+  		dc.w $356, $326, $2F9, $2CE, $2A5, $280, $25C, $23A
000067A6 021A 01FB 01DF 01C4 01AB+  		dc.w $21A, $1FB, $1DF, $1C4, $1AB, $193, $17D, $167
000067B6 0153 0140 012E 011D 010D+  		dc.w $153, $140, $12E, $11D, $10D,  $FE,  $EF,  $E2
000067C6 00D6 00C9 00BE 00B4 00A9+  		dc.w  $D6,  $C9,  $BE,  $B4,  $A9,  $A0,  $97,  $8F
000067D6 0087 007F 0078 0071 006B+  		dc.w  $87,  $7F,  $78,  $71,  $6B,  $65,  $5F,  $5A
000067E6 0055 0050 004B 0047 0043+  		dc.w  $55,  $50,  $4B,  $47,  $43,  $40,  $3C,  $39
000067F6 0036 0033 0030 002D 002B+  		dc.w  $36,  $33,  $30,  $2D,  $2B,  $28,  $26,  $24
00006806 0022 0020 001F 001D 001B+  		dc.w  $22,  $20,  $1F,  $1D,  $1B,  $1A,  $18,  $17
00006816 0016 0015 0013 0012 0011+  		dc.w  $16,  $15,  $13,  $12,  $11,    0
00006822                            
00006822                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006822                            
00006822                            
00006822                            CoordFlag:
00006822 0445 00E0                  		subi.w	#$E0,d5
00006826 E54D                       		lsl.w	#2,d5
00006828 4EFB 5000                  		jmp	coordflagLookup(pc,d5.w)
0000682C                            ; End of function CoordFlag
0000682C                            
0000682C                            ; ===========================================================================
0000682C                            
0000682C                            coordflagLookup:
0000682C 6000 0000                  		bra.w	cfPanningAMSFMS		; $E0
00006830                            ; ===========================================================================
00006830 6000 0000                  		bra.w	cfAlterNotes		; $E1
00006834                            ; ===========================================================================
00006834 6000 0000                  		bra.w	cfUnknown1		; $E2
00006838                            ; ===========================================================================
00006838 6000 0000                  		bra.w	cfJumpReturn		; $E3
0000683C                            ; ===========================================================================
0000683C 6000 0000                  		bra.w	cfFadeInToPrevious	; $E4
00006840                            ; ===========================================================================
00006840 6000 0000                  		bra.w	cfSetTempoDivider	; $E5
00006844                            ; ===========================================================================
00006844 6000 0000                  		bra.w	cfSetVolume		; $E6
00006848                            ; ===========================================================================
00006848 6000 0000                  		bra.w	cfPreventAttack		; $E7
0000684C                            ; ===========================================================================
0000684C 6000 0000                  		bra.w	cfNoteFill		; $E8
00006850                            ; ===========================================================================
00006850 6000 0000                  		bra.w	cfAddKey		; $E9
00006854                            ; ===========================================================================
00006854 6000 0000                  		bra.w	cfSetTempo		; $EA
00006858                            ; ===========================================================================
00006858 6000 0000                  		bra.w	cfSetTempoMod		; $EB
0000685C                            ; ===========================================================================
0000685C 6000 0000                  		bra.w	cfChangeVolume		; $EC
00006860                            ; ===========================================================================
00006860 6000 0000                  		bra.w	cfClearPush		; $ED
00006864                            ; ===========================================================================
00006864 6000 0000                  		bra.w	cfStopSpecialFM4	; $EE
00006868                            ; ===========================================================================
00006868 6000 0000                  		bra.w	cfSetVoice		; $EF
0000686C                            ; ===========================================================================
0000686C 6000 0000                  		bra.w	cfModulation		; $F0
00006870                            ; ===========================================================================
00006870 6000 0000                  		bra.w	cfEnableModulation	; $F1
00006874                            ; ===========================================================================
00006874 6000 0000                  		bra.w	cfStopTrack		; $F2
00006878                            ; ===========================================================================
00006878 6000 0000                  		bra.w	cfSetPSGNoise		; $F3
0000687C                            ; ===========================================================================
0000687C 6000 0000                  		bra.w	cfDisableModulation	; $F4
00006880                            ; ===========================================================================
00006880 6000 0000                  		bra.w	cfSetPSGTone		; $F5
00006884                            ; ===========================================================================
00006884 6000 0000                  		bra.w	cfJumpTo		; $F6
00006888                            ; ===========================================================================
00006888 6000 0000                  		bra.w	cfRepeatAtPos		; $F7
0000688C                            ; ===========================================================================
0000688C 6000 0000                  		bra.w	cfJumpToGosub		; $F8
00006890                            ; ===========================================================================
00006890 6000 0000                  		bra.w	cfOpF9			; $F9
00006894                            ; ===========================================================================
00006894 6000 0000                  		bra.w	TS_Flag_SetPortamentoMode	; $FA
00006898                            ; ===========================================================================  
00006898 6000 0000                  		bra.w	TS_Flag_SetPortamentoSpeed	; $FB
0000689C                            ; ===========================================================================
0000689C 6000 0000                  		bra.w	cfRevving			; $FC
000068A0                            ; ===========================================================================
000068A0                            
000068A0                            cfPanningAMSFMS:
000068A0 121C                       		move.b	(a4)+,d1	; New AMS/FMS/panning value
000068A2 4A2D 0001                  		tst.b	1(a5)		; Is this a PSG track?
000068A6 6B00                       		bmi.s	locret_72AEA	; Return if yes
000068A8 102D 000A                  		move.b	$A(a5),d0	; Get current AMS/FMS/panning
000068AC 0200 0037                  		andi.b	#$37,d0		; Retain bits 0-2, 3-4 if set
000068B0 8200                       		or.b	d0,d1		; Mask in new value
000068B2 1B41 000A                  		move.b	d1,$A(a5)	; Store value
000068B6 103C 00B4                  		move.b	#$B4,d0		; Command to set AMS/FMS/panning
000068BA 6000 FBC6                  		bra.w	WriteFMIorIIMain
000068BE                            ; ===========================================================================
000068BE                            
000068BE                            locret_72AEA:
000068BE 4E75                       		rts	
000068C0                            ; ===========================================================================
000068C0                            
000068C0                            cfAlterNotes:
000068C0 1B5C 001E                  		move.b	(a4)+,$1E(a5)	; Set frequency adjustment
000068C4 4E75                       		rts	
000068C6                            ; ===========================================================================
000068C6                            
000068C6                            cfUnknown1:
000068C6                            ;		move.b	(a4)+,7(a6)		; Set otherwise unused value to parameter
000068C6 4E75                       		rts	
000068C8                            ; ===========================================================================
000068C8                            
000068C8                            cfJumpReturn:
000068C8 7000                       		moveq	#0,d0
000068CA 102D 000D                  		move.b	$D(a5),d0		; Track stack pointer
000068CE 2875 0000                  		movea.l	(a5,d0.w),a4	; Set track return address
000068D2 2BBC 0000 0000 0000        		move.l	#0,(a5,d0.w)	; Set 'popped' value to zero
000068DA 544C                       		addq.w	#2,a4			; Skip jump target address from gosub flag
000068DC 5800                       		addq.b	#4,d0			; Actually 'pop' value
000068DE 1B40 000D                  		move.b	d0,$D(a5)		; Set new stack pointer
000068E2 4E75                       		rts	
000068E4                            ; ===========================================================================
000068E4                            
000068E4                            cfFadeInToPrevious:
000068E4 204E                       		movea.l	a6,a0
000068E6 43EE 03A0                  		lea	v_1up_ram_copy(a6),a1
000068EA 303C 0087                  		move.w	#$87,d0		; $220 bytes to restore
000068EE                            
000068EE                            @restoreramloop:
000068EE 20D9                       		move.l	(a1)+,(a0)+
000068F0 51C8 FFFC                  		dbf	d0,@restoreramloop
000068F4                            
000068F4 08EE 0002 0040             		bset	#2,v_dac_playback_control(a6)	; Set SFX overriding bit
000068FA 264D                       		movea.l	a5,a3
000068FC 1C3C 0028                  		move.b	#$28,d6
00006900 9C2E 0026                  		sub.b	v_fadein_counter(a6),d6		; If fade already in progress, this adjusts track volume accordingly
00006904 7E05                       		moveq	#5,d7
00006906 4BEE 0070                  		lea	v_fm1_track(a6),a5
0000690A                            
0000690A                            @fmloop:
0000690A 0815 0007                  		btst	#7,(a5)		; Is track playing?
0000690E 6700                       		beq.s	@nextfm	; Branch if not
00006910 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00006914 DD2D 0009                  		add.b	d6,9(a5)	; Apply current volume fade-in
00006918 0815 0002                  		btst	#2,(a5)		; Is SFX overriding?
0000691C 6600                       		bne.s	@nextfm	; Branch if yes
0000691E 7000                       		moveq	#0,d0
00006920 102D 000B                  		move.b	$B(a5),d0	; Get voice
00006924 226E 0018                  		movea.l	v_voice_ptr(a6),a1	; Voice pointer
00006928 4EBA 0000                  		jsr	SetVoice(pc)
0000692C                            
0000692C                            @nextfm:
0000692C DAFC 0030                  		adda.w	#zTrackSz,a5
00006930 51CF FFD8                  		dbf	d7,@fmloop
00006934                            
00006934 7E02                       		moveq	#2,d7
00006936                            
00006936                            @psgloop:
00006936 0815 0007                  		btst	#7,(a5)		; Is track playing?
0000693A 6700                       		beq.s	@nextpsg	; Branch if not
0000693C 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00006940 4EBA FE26                  		jsr	PSGNoteOff(pc)
00006944 DD2D 0009                  		add.b	d6,9(a5)	; Apply current volume fade-in
00006948                            
00006948                            @nextpsg:
00006948 DAFC 0030                  		adda.w	#zTrackSz,a5
0000694C 51CF FFE8                  		dbf	d7,@psgloop
00006950                            		
00006950 2A4B                       		movea.l	a3,a5
00006952 1D7C 0080 0024             		move.b	#$80,f_fadein_flag(a6)	; Trigger fade-in
00006958 1D7C 0028 0026             		move.b	#$28,v_fadein_counter(a6)	; Fade-in delay
0000695E 422E 0027                  		clr.b	f_1up_playing(a6)
00006962 33FC 0000 00A1 1100        		startZ80
0000696A 504F                       		addq.w	#8,sp		; Tamper return value so we don't return to caller
0000696C 4E75                       		rts	
0000696E                            ; ===========================================================================
0000696E                            
0000696E                            cfSetTempoDivider:
0000696E 1B5C 0002                  		move.b	(a4)+,2(a5)	; Set tempo divider on current track
00006972 4E75                       		rts	
00006974                            ; ===========================================================================
00006974                            
00006974                            cfSetVolume:
00006974 101C                       		move.b	(a4)+,d0	; Get parameter
00006976 D12D 0009                  		add.b	d0,9(a5)	; Add to current volume
0000697A 6000 0000                  		bra.w	SendVoiceTL
0000697E                            ; ===========================================================================
0000697E                            
0000697E                            cfPreventAttack:
0000697E 08D5 0004                  		bset	#4,(a5)		; Set 'do not attack next note' bit
00006982 4E75                       		rts	
00006984                            ; ===========================================================================
00006984                            
00006984                            cfNoteFill:
00006984 1B54 0012                  		move.b	(a4),$12(a5)	; Note fill timeout
00006988 1B5C 0013                  		move.b	(a4)+,$13(a5)	; Note fill master
0000698C 4E75                       		rts	
0000698E                            ; ===========================================================================
0000698E                            
0000698E                            cfRevving:
0000698E 101C                       		move.b	(a4)+,d0
00006990 D02E 000F                  		add.b	v_revsound(a6),d0
00006994 0C00 0010                  		cmp.b	#$10,d0
00006998 6200                       		bhi.s	@0
0000699A 1D40 000F                  		move.b	d0,v_revsound(a6)
0000699E D12D 0008                  	@0:	add.b	d0,8(a5)
000069A2 4E75                               	rts
000069A4                            
000069A4                            ; ===========================================================================
000069A4                            cfAddKey:
000069A4 101C                       		move.b	(a4)+,d0	; Get parameter
000069A6 D12D 0008                  		add.b	d0,8(a5)	; Add to track key displacement
000069AA 4E75                       		rts
000069AC                            ; ===========================================================================
000069AC                            
000069AC                            cfSetTempo:
000069AC 1D54 0002                  		move.b	(a4),v_main_tempo(a6)	; Set main tempo
000069B0 1D5C 0001                  		move.b	(a4)+,v_main_tempo_timeout(a6)	; And reset timeout (!)
000069B4 4E75                       		rts	
000069B6                            ; ===========================================================================
000069B6                            
000069B6                            cfSetTempoMod:
000069B6 41EE 0040                  		lea	v_track_ram(a6),a0
000069BA 101C                       		move.b	(a4)+,d0		; Get new tempo divider
000069BC 7230                       		moveq	#zTrackSz,d1
000069BE 7409                       		moveq	#9,d2
000069C0                            
000069C0                            @trackloop:
000069C0 1140 0002                  		move.b	d0,2(a0)	; Set track's tempo divider
000069C4 D0C1                       		adda.w	d1,a0
000069C6 51CA FFF8                  		dbf	d2,@trackloop
000069CA                            
000069CA 4E75                       		rts	
000069CC                            ; ===========================================================================
000069CC                            
000069CC                            cfChangeVolume:
000069CC 101C                       		move.b	(a4)+,d0	; Get volume change
000069CE D12D 0009                  		add.b	d0,9(a5)	; Apply it
000069D2 4E75                       		rts	
000069D4                            ; ===========================================================================
000069D4                            
000069D4                            cfClearPush:
000069D4 422E 002C                  		clr.b	f_push_playing(a6)	; Allow push sound to be played once more
000069D8 4E75                       		rts	
000069DA                            ; ===========================================================================
000069DA                            
000069DA                            cfStopSpecialFM4:
000069DA 0895 0007                  		bclr	#7,(a5)		; Stop track
000069DE 0895 0004                  		bclr	#4,(a5)		; Clear 'do not attack next note' bit
000069E2 4EBA FA86                  		jsr	FMNoteOff(pc)
000069E6 4A2E 0250                  		tst.b	v_sfx_fm4_track(a6)		; Is SFX using FM4?
000069EA 6B00                       		bmi.s	@locexit	; Branch if yes
000069EC 264D                       		movea.l	a5,a3
000069EE 4BEE 0100                  		lea	v_fm4_track(a6),a5
000069F2 226E 0018                  		movea.l	v_voice_ptr(a6),a1	; Voice pointer
000069F6 0895 0002                  		bclr	#2,(a5)		; Clear SFX is overriding bit
000069FA 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
000069FE 102D 000B                  		move.b	$B(a5),d0	; Current voice
00006A02 4EBA 0000                  		jsr	SetVoice(pc)
00006A06 2A4B                       		movea.l	a3,a5
00006A08                            
00006A08                            @locexit:
00006A08 504F                       		addq.w	#8,sp		; Tamper with return value so we don't return to caller
00006A0A 4E75                       		rts	
00006A0C                            ; ===========================================================================
00006A0C                            
00006A0C                            cfSetVoice:
00006A0C 7000                       		moveq	#0,d0
00006A0E 101C                       		move.b	(a4)+,d0	; Get new voice
00006A10 1B40 000B                  		move.b	d0,$B(a5)	; Store it
00006A14 0815 0002                  		btst	#2,(a5)		; Is SFX overriding this track?
00006A18 6600 0000                  		bne.w	locret_72CAA	; Return if yes
00006A1C 226E 0018                  		movea.l	v_voice_ptr(a6),a1	; Music voice pointer
00006A20 4A2E 000E                  		tst.b	f_voice_selector(a6)	; Are we updating a music track?
00006A24 6700                       		beq.s	SetVoice	; If yes, branch
00006A26 226D 0020                  		movea.l	$20(a5),a1	; SFX track voice pointer
00006A2A 4A2E 000E                  		tst.b	f_voice_selector(a6)	; Are we updating a SFX track?
00006A2E 6B00                       		bmi.s	SetVoice	; If yes, branch
00006A30 226E 0020                  		movea.l	v_special_voice_ptr(a6),a1	; Special SFX voice pointer
00006A34                            
00006A34                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006A34                            
00006A34                            
00006A34                            SetVoice:
00006A34 5340                       		subq.w	#1,d0
00006A36 6B00                       		bmi.s	@havevoiceptr
00006A38 323C 0019                  		move.w	#25,d1
00006A3C                            
00006A3C                            @voicemultiply:
00006A3C D2C1                       		adda.w	d1,a1
00006A3E 51C8 FFFC                  		dbf	d0,@voicemultiply
00006A42                            
00006A42                            @havevoiceptr:
00006A42 1219                       		move.b	(a1)+,d1	; feedback/algorithm
00006A44 1B41 001F                  		move.b	d1,$1F(a5)	; Save it to track RAM
00006A48 1801                       		move.b	d1,d4
00006A4A 103C 00B0                  		move.b	#$B0,d0		; Command to write feedback/algorithm
00006A4E 4EBA FA3E                  		jsr	WriteFMIorII(pc)
00006A52 45FA 0000                  		lea	FMInstrumentOperatorTable(pc),a2
00006A56 7613                       		moveq	#$13,d3		; Don't want to send TL yet
00006A58                            
00006A58                            @sendvoiceloop:
00006A58 101A                       		move.b	(a2)+,d0
00006A5A 1219                       		move.b	(a1)+,d1
00006A5C 4EBA FA30                  		jsr	WriteFMIorII(pc)
00006A60 51CB FFF6                  		dbf	d3,@sendvoiceloop
00006A64                            
00006A64 7A03                       		moveq	#3,d5
00006A66 0244 0007                  		andi.w	#7,d4		; Get algorithm
00006A6A 183B 4000                  		move.b	FMSlotMask(pc,d4.w),d4	; Get slot mask for algorithm
00006A6E 162D 0009                  		move.b	9(a5),d3	; Track volume attenuation
00006A72                            
00006A72                            @sendtlloop:
00006A72 101A                       		move.b	(a2)+,d0
00006A74 1219                       		move.b	(a1)+,d1
00006A76 E20C                       		lsr.b	#1,d4		; Is bit set for this operator in the mask?
00006A78 6400                       		bcc.s	@sendtl		; Branch if not
00006A7A D203                       		add.b	d3,d1		; Include additional attenuation
00006A7C                            
00006A7C                            @sendtl:
00006A7C 4EBA FA10                  		jsr	WriteFMIorII(pc)
00006A80 51CD FFF0                  		dbf	d5,@sendtlloop
00006A84                            		
00006A84 103C 00B4                  		move.b	#$B4,d0		; Register for AMS/FMS/Panning
00006A88 122D 000A                  		move.b	$A(a5),d1	; Value to send
00006A8C 4EBA FA00                  		jsr	WriteFMIorII(pc)
00006A90                            
00006A90                            locret_72CAA:
00006A90 4E75                       		rts	
00006A92                            ; End of function SetVoice
00006A92                            
00006A92                            ; ===========================================================================
00006A92 0808 0808 0A0E 0E0F        FMSlotMask:	dc.b 8,	8, 8, 8, $A, $E, $E, $F
00006A9A                            
00006A9A                            ; ||||||||||||||| S U B	R O U T	I N E |||||||||||||||||||||||||||||||||||||||
00006A9A                            
00006A9A                            
00006A9A                            SendVoiceTL:
00006A9A 0815 0002                  		btst	#2,(a5)		; Is SFX overriding?
00006A9E 6600                       		bne.s	@locret	; Return if so
00006AA0 7000                       		moveq	#0,d0
00006AA2 102D 000B                  		move.b	$B(a5),d0	; Current voice
00006AA6 226E 0018                  		movea.l	v_voice_ptr(a6),a1	; Voice pointer
00006AAA 4A2E 000E                  		tst.b	f_voice_selector(a6)
00006AAE 6700                       		beq.s	@gotvoiceptr
00006AB0                            		; DANGER! This uploads the wrong voice! It should have been a5 instead
00006AB0                            		; of a6!
00006AB0 226E 0020                  		movea.l	$20(a6),a1
00006AB4 4A2E 000E                  		tst.b	f_voice_selector(a6)
00006AB8 6B00                       		bmi.s	@gotvoiceptr
00006ABA 226E 0020                  		movea.l	v_special_voice_ptr(a6),a1
00006ABE                            
00006ABE                            @gotvoiceptr:
00006ABE 5340                       		subq.w	#1,d0
00006AC0 6B00                       		bmi.s	@gotvoice
00006AC2 323C 0019                  		move.w	#25,d1
00006AC6                            
00006AC6                            @voicemultiply:
00006AC6 D2C1                       		adda.w	d1,a1
00006AC8 51C8 FFFC                  		dbf	d0,@voicemultiply
00006ACC                            
00006ACC                            @gotvoice:
00006ACC D2FC 0015                  		adda.w	#21,a1		; Want TL
00006AD0 45FA 0000                  		lea	FMInstrumentTLTable(pc),a2
00006AD4 102D 001F                  		move.b	$1F(a5),d0		; Get feedback/algorithm
00006AD8 0240 0007                  		andi.w	#7,d0			; Want only algorithm
00006ADC 183B 00B4                  		move.b	FMSlotMask(pc,d0.w),d4	; Get slot mask
00006AE0 162D 0009                  		move.b	9(a5),d3		; Get track volume attenuation
00006AE4 6B00                       		bmi.s	@locret	; If negative, stop
00006AE6 7A03                       		moveq	#3,d5
00006AE8                            
00006AE8                            @sendtlloop:
00006AE8 101A                       		move.b	(a2)+,d0
00006AEA 1219                       		move.b	(a1)+,d1
00006AEC E20C                       		lsr.b	#1,d4		; Is bit set for this operator in the mask?
00006AEE 6400                       		bcc.s	@senttl		; Branch if not
00006AF0 D203                       		add.b	d3,d1		; Include additional attenuation
00006AF2 6500                       		blo.s	@senttl		; Branch on overflow
00006AF4 4EBA F998                  		jsr	WriteFMIorII(pc)
00006AF8                            
00006AF8                            @senttl:
00006AF8 51CD FFEE                  		dbf	d5,@sendtlloop
00006AFC                            
00006AFC                            @locret:
00006AFC 4E75                       		rts	
00006AFE                            ; End of function SendVoiceTL
00006AFE                            
00006AFE                            ; ===========================================================================
00006AFE                            FMInstrumentOperatorTable:
00006AFE 30                         		dc.b  $30								; Detune/multiple operator 1
00006AFF 38                         		dc.b  $38								; Detune/multiple operator 3
00006B00 34                         		dc.b  $34								; Detune/multiple operator 2
00006B01 3C                         		dc.b  $3C								; Detune/multiple operator 4
00006B02 50                         		dc.b  $50								; Rate scalling/attack rate operator 1
00006B03 58                         		dc.b  $58								; Rate scalling/attack rate operator 3
00006B04 54                         		dc.b  $54								; Rate scalling/attack rate operator 2
00006B05 5C                         		dc.b  $5C								; Rate scalling/attack rate operator 4
00006B06 60                         		dc.b  $60								; Amplitude modulation/first decay rate operator 1
00006B07 68                         		dc.b  $68								; Amplitude modulation/first decay rate operator 3
00006B08 64                         		dc.b  $64								; Amplitude modulation/first decay rate operator 2
00006B09 6C                         		dc.b  $6C								; Amplitude modulation/first decay rate operator 4
00006B0A 70                         		dc.b  $70								; Secondary decay rate operator 1
00006B0B 78                         		dc.b  $78								; Secondary decay rate operator 3
00006B0C 74                         		dc.b  $74								; Secondary decay rate operator 2
00006B0D 7C                         		dc.b  $7C								; Secondary decay rate operator 4
00006B0E 80                         		dc.b  $80								; Secondary amplitude/release rate operator 1
00006B0F 88                         		dc.b  $88								; Secondary amplitude/release rate operator 3
00006B10 84                         		dc.b  $84								; Secondary amplitude/release rate operator 2
00006B11 8C                         		dc.b  $8C								; Secondary amplitude/release rate operator 4
00006B12                            FMInstrumentTLTable:
00006B12 40                         		dc.b  $40								; Total level operator 1
00006B13 48                         		dc.b  $48								; Total level operator 3
00006B14 44                         		dc.b  $44								; Total level operator 2
00006B15 4C                         		dc.b  $4C								; Total level operator 4
00006B16                            ; ===========================================================================
00006B16                            
00006B16                            cfModulation:
00006B16 08D5 0003                  		bset	#3,(a5)		; Turn on modulation
00006B1A 2B4C 0014                  		move.l	a4,$14(a5)	; Save pointer to modulation data
00006B1E 1B5C 0018                  		move.b	(a4)+,$18(a5)	; Modulation delay
00006B22 1B5C 0019                  		move.b	(a4)+,$19(a5)	; Modulation speed
00006B26 1B5C 001A                  		move.b	(a4)+,$1A(a5)	; Modulation delta
00006B2A 101C                       		move.b	(a4)+,d0	; Modulation steps...
00006B2C E208                       		lsr.b	#1,d0		; ... divided by 2...
00006B2E 1B40 001B                  		move.b	d0,$1B(a5)	; ... before being stored
00006B32 426D 001C                  		clr.w	$1C(a5)		; Total accumulated modulation frequency change
00006B36 4E75                       		rts	
00006B38                            ; ===========================================================================
00006B38                            
00006B38                            cfEnableModulation:
00006B38 08D5 0003                  		bset	#3,(a5)		; Turn on modulation
00006B3C 4E75                       		rts	
00006B3E                            ; ===========================================================================
00006B3E                            
00006B3E                            cfStopTrack:
00006B3E 0895 0007                  		bclr	#7,(a5)		; Stop track
00006B42 0895 0004                  		bclr	#4,(a5)		; Clear 'do not attack next note' bit
00006B46 4A2D 0001                  		tst.b	1(a5)		; Is this a PSG track?
00006B4A 6B00                       		bmi.s	@stoppsg	; Branch if yes
00006B4C 4A2E 0008                  		tst.b	f_updating_dac(a6)	; Is this the DAC we are updating?
00006B50 6B00 0000                  		bmi.w	@locexit	; Exit if yes
00006B54 4EBA F914                  		jsr	FMNoteOff(pc)
00006B58 6000                       		bra.s	@stoppedchannel
00006B5A                            ; ===========================================================================
00006B5A                            
00006B5A                            @stoppsg:
00006B5A 4EBA FC0C                  		jsr	PSGNoteOff(pc)
00006B5E                            
00006B5E                            @stoppedchannel:
00006B5E 4A2E 000E                  		tst.b	f_voice_selector(a6)	; Are we updating SFX?
00006B62 6A00 0000                  		bpl.w	@locexit				; Exit if not
00006B66 4216                       		clr.b	v_sndprio(a6)		; Clear priority
00006B68 7000                       		moveq	#0,d0
00006B6A 102D 0001                  		move.b	1(a5),d0	; Get voice control bits
00006B6E 6B00                       		bmi.s	@getpsgptr	; Branch if PSG
00006B70 41FA F492                  		lea	BGMChannelRAM(pc),a0
00006B74 264D                       		movea.l	a5,a3
00006B76 0C00 0004                  		cmpi.b	#4,d0	; Is this FM4?
00006B7A 6600                       		bne.s	@getpointer	; Branch if not
00006B7C 4A2E 0340                  		tst.b	v_sfx2_fm4_playback_control(a6)	; Is special SFX playing?
00006B80 6A00                       		bpl.s	@getpointer		; Branch if not
00006B82 4BEE 0340                  		lea	v_sfx2_fm4_track(a6),a5
00006B86 226E 0020                  		movea.l	v_special_voice_ptr(a6),a1	; Get voice pointer
00006B8A 6000                       		bra.s	@gotpointer
00006B8C                            ; ===========================================================================
00006B8C                            
00006B8C                            @getpointer:
00006B8C 5500                       		subq.b	#2,d0		; SFX can only use FM3 and up
00006B8E E508                       		lsl.b	#2,d0
00006B90 2A70 0000                  		movea.l	(a0,d0.w),a5
00006B94 4A15                       		tst.b	(a5)		; Is track playing?
00006B96 6A00                       		bpl.s	@novoiceupd	; Branch if not
00006B98 226E 0018                  		movea.l	v_voice_ptr(a6),a1	; Get voice pointer
00006B9C                            
00006B9C                            @gotpointer:
00006B9C 0895 0002                  		bclr	#2,(a5)		; Clear SFX overriding bit
00006BA0 08D5 0001                  		bset	#1,(a5)		; Set track at rest bit
00006BA4 102D 000B                  		move.b	$B(a5),d0	; Current voice
00006BA8 4EBA FE8A                  		jsr	SetVoice(pc)
00006BAC                            
00006BAC                            @novoiceupd:
00006BAC 2A4B                       		movea.l	a3,a5
00006BAE 6000                       		bra.s	@locexit
00006BB0                            ; ===========================================================================
00006BB0                            
00006BB0                            @getpsgptr:
00006BB0 41EE 0370                  		lea	v_sfx2_psg3_track(a6),a0
00006BB4 4A10                       		tst.b	(a0)	; Is track playing?
00006BB6 6A00                       		bpl.s	@getchannelptr	; Branch if not
00006BB8 0C00 00E0                  		cmpi.b	#$E0,d0		; Is it the noise channel?
00006BBC 6700                       		beq.s	@gotchannelptr	; Branch if yes
00006BBE 0C00 00C0                  		cmpi.b	#$C0,d0		; Is it PSG 3?
00006BC2 6700                       		beq.s	@gotchannelptr	; Branch if yes
00006BC4                            
00006BC4                            @getchannelptr:
00006BC4 41FA F43E                  		lea	BGMChannelRAM(pc),a0
00006BC8 E608                       		lsr.b	#3,d0
00006BCA 2070 0000                  		movea.l	(a0,d0.w),a0
00006BCE                            
00006BCE                            @gotchannelptr:
00006BCE 0890 0002                  		bclr	#2,(a0)		; Clear SFX overriding bit
00006BD2 08D0 0001                  		bset	#1,(a0)		; Set track at rest bit
00006BD6 0C28 00E0 0001             		cmpi.b	#$E0,1(a0)	; Is this a noise pointer?
00006BDC 6600                       		bne.s	@locexit	; Branch if not
00006BDE 13E8 001F 00C0 0011        		move.b	$1F(a0),(PSG).l	; Set noise tone
00006BE6                            
00006BE6                            @locexit:
00006BE6 504F                       		addq.w	#8,sp		; Tamper with return value so we don't go back to caller
00006BE8 4E75                       		rts	
00006BEA                            ; ===========================================================================
00006BEA                            
00006BEA                            cfSetPSGNoise:
00006BEA 1B7C 00E0 0001             		move.b	#$E0,1(a5)	; Turn channel into noise channel
00006BF0 1B5C 001F                  		move.b	(a4)+,$1F(a5)	; Save noise tone
00006BF4 0815 0002                  		btst	#2,(a5)		; Is track being overridden?
00006BF8 6600                       		bne.s	@locret	; Return if yes
00006BFA 13EC FFFF 00C0 0011        		move.b	-1(a4),(PSG).l	; Set tone
00006C02                            
00006C02                            @locret:
00006C02 4E75                       		rts	
00006C04                            ; ===========================================================================
00006C04                            
00006C04                            cfDisableModulation:
00006C04 0895 0003                  		bclr	#3,(a5)		; Disable modulation
00006C08 4E75                       		rts	
00006C0A                            ; ===========================================================================
00006C0A                            
00006C0A                            cfSetPSGTone:
00006C0A 1B5C 000B                  		move.b	(a4)+,$B(a5)	; Set current PSG tone
00006C0E 4E75                       		rts	
00006C10                            ; ===========================================================================
00006C10                            
00006C10                            cfJumpTo:
00006C10 101C                       		move.b	(a4)+,d0	; High byte of offset
00006C12 E148                       		lsl.w	#8,d0		; Shift it into place
00006C14 101C                       		move.b	(a4)+,d0	; Low byte of offset
00006C16 D8C0                       		adda.w	d0,a4		; Add to current position
00006C18 534C                       		subq.w	#1,a4		; Put back one byte
00006C1A 4E75                       		rts	
00006C1C                            ; ===========================================================================
00006C1C                            
00006C1C                            cfRepeatAtPos:
00006C1C 7000                       		moveq	#0,d0
00006C1E 101C                       		move.b	(a4)+,d0	; Loop index
00006C20 121C                       		move.b	(a4)+,d1	; Repeat count
00006C22 4A35 0024                  		tst.b	$24(a5,d0.w)	; Has this loop already started?
00006C26 6600                       		bne.s	@loopexists	; Branch if yes
00006C28 1B81 0024                  		move.b	d1,$24(a5,d0.w)	; Initialize repeat count
00006C2C                            
00006C2C                            @loopexists:
00006C2C 5335 0024                  		subq.b	#1,$24(a5,d0.w)	; Decrease loop's repeat count
00006C30 66DE                       		bne.s	cfJumpTo	; If nonzero, branch to target
00006C32 544C                       		addq.w	#2,a4	; Skip target address
00006C34 4E75                       		rts	
00006C36                            ; ===========================================================================
00006C36                            
00006C36                            cfJumpToGosub:
00006C36 7000                       		moveq	#0,d0
00006C38 102D 000D                  		move.b	$D(a5),d0	; Current stack pointer
00006C3C 5900                       		subq.b	#4,d0		; Add space for another target
00006C3E 2B8C 0000                  		move.l	a4,(a5,d0.w)	; Put in current address (*before* target for jump!)
00006C42 1B40 000D                  		move.b	d0,$D(a5)	; Store new stack pointer
00006C46 60C8                       		bra.s	cfJumpTo
00006C48                            ; ===========================================================================
00006C48                            
00006C48                            cfOpF9:
00006C48 103C 0088                  		move.b	#$88,d0		; D1L/RR of Operator 3
00006C4C 123C 000F                  		move.b	#$F,d1		; Loaded with fixed value (max RR, 1TL)
00006C50 4EBA F848                  		jsr	WriteFMI(pc)
00006C54 103C 008C                  		move.b	#$8C,d0		; D1L/RR of Operator 4
00006C58 123C 000F                  		move.b	#$F,d1		; Loaded with fixed value (max RR, 1TL)
00006C5C 6000 F83C                  		bra.w	WriteFMI
00006C60                            
00006C60                            ; ===========================================================================
00006C60                            
00006C60                            		include	'_proc\swa.smps.extension.asm'
00006C60                            
00006C60                            ; ===============================================================
00006C60                            ; ---------------------------------------------------------------
00006C60                            ; SMPS Extension Module
00006C60                            ; 2014, Vladikcomper
00006C60                            ; ---------------------------------------------------------------
00006C60                            ;	* Updated FM channel tracker
00006C60                            ;	* Alternative note system
00006C60                            ;	* Improved frequency calculation
00006C60                            ;	* Portamento support with 4 different modes
00006C60                            ; ---------------------------------------------------------------
00006C60                            
00006C60                            ; WARNING! Memory used overlaps with v_1up_ram_copy
00006C60                            
00006C60                            ; Extended channel struct
00006C60                            		rsreset
00006C60 =00000000                  note		rs.w	1
00006C60 =00000002                  note_target	rs.w	1
00006C60 =00000004                  note_step	rs.w	1
00006C60 =00000006                  lastnote	rs.b	1		; last note read from track
00006C60 =00000007                  slide_mode	rs.b	1
00006C60 =00000008                  slide_speed	rs.b	1
00006C60 =00000009                  unused		rs.b	1
00006C60                            
00006C60 =0000000A                  TS_ExtChannelSize	= __RS-note
00006C60                            
00006C60                            ; Extended SMPS memory usage
00006C60                            		rsset	v_1up_ram_copy
00006C60 =000003A0                  TS_ExtChannels	rs.b	TS_ExtChannelSize*6		; extended RAM for 6 FM channels
00006C60                            
00006C60                            ; ===============================================================
00006C60                            ; ---------------------------------------------------------------
00006C60                            ; Subroutine to init extended channels RAM
00006C60                            ; ---------------------------------------------------------------
00006C60                            
00006C60                            TS_InitExtChannels:
00006C60 2F0D                       	move.l	a5,-(sp)
00006C62                            
00006C62 4BEE 03A0                  	lea	TS_ExtChannels(a6),a5
00006C66 7000                       	moveq	#0,d0
00006C68 7205                       	moveq	#6-1,d1				; number of channels
00006C6A                            
00006C6A                            @clearchannel:
00006C6A                            	rept	TS_ExtChannelSize/4
00006C6A                            		move.l	d0,(a5)+		; clear channel struct
00006C6A 2AC0 2AC0                  	endr
00006C6E 51C9 FFFA                  	dbf	d1, @clearchannel
00006C72                            
00006C72 2A5F                       	move.l	(sp)+,a5
00006C74 4E75                       	rts
00006C76                            
00006C76                            ; ===============================================================
00006C76                            ; ---------------------------------------------------------------
00006C76                            ; Subroutine to update FM channel
00006C76                            ; ---------------------------------------------------------------
00006C76                            
00006C76                            ExtChannelsRAM:   
00006C76 0000                       	dc.w	0
00006C78 000A                       	dc.w	TS_ExtChannelSize
00006C7A 0014                       	dc.w	TS_ExtChannelSize*2
00006C7C 001E                       	dc.w	TS_ExtChannelSize*3
00006C7E 0028                       	dc.w	TS_ExtChannelSize*4
00006C80 0032                       	dc.w	TS_ExtChannelSize*5
00006C82                            
00006C82                            ; ---------------------------------------------------------------
00006C82                            TS_FM_UpdateChannel:
00006C82 3007                       	move.w	d7,d0
00006C84 D040                       	add.w	d0,d0
00006C86 47EE 03A0                  	lea	TS_ExtChannels(a6),a3
00006C8A D6FB 00EA                  	adda.w	ExtChannelsRAM(pc,d0),a3
00006C8E                            
00006C8E 102B 0008                  	move.b	slide_speed(a3),d0	; load slide speed
00006C92 0200 007F                  	andi.b	#$7F,d0			; clear bit 7
00006C96 6700                       	beq.s	@NoSlide		; if speed is zero, branch
00006C98 4EB9 0000 0000             	jsr	TS_FM_SlideNote		; otherwise, update sliding
00006C9E                            @NoSlide:
00006C9E                            
00006C9E 532D 000E                  	subq.b	#1,$E(a5)		; decrease note timer
00006CA2 6700                       	beq.s	@LoadNewNote		; if timer has expired, branch
00006CA4 4EB8 5AC8                  	jsr	NoteFillUpdate
00006CA8 4EB8 5AF0                  	jsr	DoModulation
00006CAC 4EF8 5B4E                  	jmp	FMUpdateFreq
00006CB0                            
00006CB0                            ; ---------------------------------------------------------------
00006CB0                            @LoadNewNote:
00006CB0 4878 644E                  	pea	FMNoteOn
00006CB4 4878 5B42                  	pea	FMPrepareNote
00006CB8                            
00006CB8 0895 0004                  	bclr	#4,(a5)			; Clear do not attack next note bit
00006CBC 286D 0004                  	movea.l	4(a5),a4		; load channel track
00006CC0                            	
00006CC0 7A00                       @0	moveq	#0,d5
00006CC2 1A1C                       	move.b	(a4)+,d5		; get a byte from track
00006CC4 0C05 00E0                  	cmpi.b	#$E0,d5			; is this a coordination flag?
00006CC8 6500                       	blo.s	@1
00006CCA 2F0B                       	move.l	a3,-(sp)
00006CCC 4EB8 6822                  	jsr	CoordFlag		; execute coordinate flag
00006CD0 265F                       	move.l	(sp)+,a3
00006CD2 60EC                       	bra.s	@0			; repeat
00006CD4                            	
00006CD4 4EB9 0000 0000             @1	jsr	TS_FM_NoteOff_SetSlide
00006CDA 4EB8 646A                  	jsr	FMNoteOff		; call NoteOff event
00006CDE 0895 0001                  	bclr	#1,(a5)			; clear track at rest bit
00006CE2 4A05                       	tst.b	d5			; did we get a note?
00006CE4 6A00                       	bpl.s	@RepeatNote		; if got duration, branch
00006CE6 4EB9 0000 0000             	jsr	TS_FM_UpdateNote
00006CEC 1A1C                       	move.b	(a4)+,d5		; get a byte from track
00006CEE 6A00                       	bpl.s	@UpdateDuration		; if this is duration, branch
00006CF0 534C                       	subq.w	#1,a4
00006CF2 4EF8 5A8A                  	jmp	FinishTrackUpdate
00006CF6                            
00006CF6                            ; ---------------------------------------------------------------
00006CF6                            @RepeatNote:
00006CF6 3F05                       	move.w	d5,-(sp)		; save duration to stack
00006CF8 1A13                       	move.b	note(a3),d5
00006CFA 4EB9 0000 0000             	jsr	TS_FM_UpdateNote
00006D00 3A1F                       	move.w	(sp)+,d5		; load duration from stack
00006D02                            
00006D02                            @UpdateDuration:
00006D02 4EB8 5A6A                  	jsr	SetDuration
00006D06 4EF8 5A8A                  	jmp	FinishTrackUpdate
00006D0A                            
00006D0A                            
00006D0A                            ; ===============================================================
00006D0A                            ; ---------------------------------------------------------------
00006D0A                            ; Subroutine to calculate note sliding
00006D0A                            ; ---------------------------------------------------------------
00006D0A                            
00006D0A                            TS_FM_SlideNote:
00006D0A 322B 0004                  	move.w	note_step(a3),d1	; d1 = Note Step
00006D0E 6700                       	beq.s	@Ret
00006D10 3013                       	move.w	note(a3),d0		; d0 = Note
00006D12 E708                       	lsl.b	#3,d0			; d0 = Note (fractional format)
00006D14 D041                       	add.w	d1,d0			; d0 = Note + Note Step
00006D16 342B 0002                  	move.w	note_target(a3),d2	; d2 = Target Note
00006D1A E70A                       	lsl.b	#3,d2			; d2 = Target Note (fractional format)
00006D1C 9042                       	sub.w	d2,d0			; d0 = (Note + Note Step) - Target Note
00006D1E B141                       	eor.w	d0,d1
00006D20 6B00                       	bmi.s	@UpdateNote
00006D22 426B 0004                  	clr.w	note_step(a3)		; reset Note Step
00006D26 7000                       	moveq	#0,d0			; set Note to Target Note
00006D28                            
00006D28                            @UpdateNote:
00006D28 D042                       	add.w	d2,d0
00006D2A E608                       	lsr.b	#3,d0
00006D2C 0200 001F                  	andi.b	#$1F,d0
00006D30 3680                       	move.w	d0,note(a3)
00006D32                            
00006D32 0815 0001                  	btst	#1,(a5)			; is track resting?
00006D36 6600                       	bne.s	@Ret			; if yes, branch
00006D38 4EB9 0000 0000                     jsr	TS_SetNoteFrequency
00006D3E 3C2D 0010                          move.w	$10(a5),d6		; load frequency stored
00006D42 4EF8 5B4E                  	jmp	FMUpdateFreq		; apply it
00006D46                            
00006D46 4E75                       @Ret	rts
00006D48                            
00006D48                            ; ===============================================================
00006D48                            ; ---------------------------------------------------------------
00006D48                            ; Subroutine to set sliding after note off
00006D48                            ; ---------------------------------------------------------------
00006D48                            
00006D48                            TS_FM_NoteOff_SetSlide:
00006D48 4A2B 0006                  	tst.b	lastnote(a3)		; was the last note zero?
00006D4C 6700                       	beq.s	@Ret			; if yes, branch
00006D4E 082B 0007 0007             	btst	#7,slide_mode(a3)	; is sliding disabled on note off?
00006D54 6700                       	beq.s	@Ret			; if yes, branch
00006D56 102B 0008                  	move.b	slide_speed(a3),d0	; load slide speed
00006D5A 0240 007F                  	andi.w	#$7F,d0
00006D5E 0440 0064                  	sub.w	#100,d0
00006D62 4440                       	neg.w	d0
00006D64 D040                       	add.w	d0,d0
00006D66 343C 5FFC                  	move.w	#$5FFC,d2		; set Target note to $5FFC
00006D6A                            
00006D6A 082B 0006 0007             	btst	#6,slide_mode(a3)	; is sliding direction up?
00006D70 6700                       	beq.s	@SetSlide		; branch if yes
00006D72 4440                       	neg.w	d0
00006D74 7400                       	moveq	#0,d2			; set Target note to $0000
00006D76                            
00006D76                            @SetSlide:
00006D76 3740 0004                  	move.w	d0,note_step(a3)
00006D7A 3742 0002                  	move.w	d2,note_target(a3)
00006D7E                            
00006D7E 4E75                       @Ret	rts
00006D80                            
00006D80                            ; ===============================================================
00006D80                            ; ---------------------------------------------------------------
00006D80                            ; Coordination flag to set portamento mode
00006D80                            ; ---------------------------------------------------------------
00006D80                            
00006D80                            TS_Flag_SetPortamentoMode:
00006D80 101C                       	move.b	(a4)+,d0
00006D82 0240 0003                  	andi.w	#3,d0
00006D86 D040                       	add.w	d0,d0			; d0 = x*2
00006D88 3200                       	move.w	d0,d1
00006D8A E748                       	lsl.w	#3,d0			; d0 = x*16
00006D8C 9041                       	sub.w	d1,d0			; d0 = x*14
00006D8E 4EFB 0000                  	jmp	@0(pc,d0)
00006D92                            
00006D92                            ; ---------------------------------------------------------------
00006D92 08AB 0007 0008             @0	bclr	#7,slide_speed(a3)	; originally FlagF4
00006D98 08AB 0007 0007             	bclr	#7,slide_mode(a3)
00006D9E 4E75                       	rts
00006DA0                            ; ---------------------------------------------------------------
00006DA0 08EB 0007 0008             	bset	#7,slide_speed(a3)	; originally FlagF5
00006DA6 08AB 0007 0007             	bclr	#7,slide_mode(a3)
00006DAC 4E75                       	rts
00006DAE                            ; ---------------------------------------------------------------
00006DAE 08EB 0007 0007             	bset	#7,slide_mode(a3)	; originally FlagF6
00006DB4 08AB 0006 0007             	bclr	#6,slide_mode(a3)
00006DBA 4E75                             	rts
00006DBC                            ; ---------------------------------------------------------------
00006DBC 08EB 0007 0007             	bset	#7,slide_mode(a3)	; originally FlagF7
00006DC2 08EB 0006 0007             	bset	#6,slide_mode(a3)
00006DC8 4E75                       	rts
00006DCA                            
00006DCA                            ; ===============================================================
00006DCA                            ; ---------------------------------------------------------------
00006DCA                            ; Coordination flag to set portamento speed
00006DCA                            ; ---------------------------------------------------------------
00006DCA                            
00006DCA                            TS_Flag_SetPortamentoSpeed:
00006DCA 101C                       	move.b	(a4)+,d0
00006DCC 0200 007F                  	andi.b	#$7F,d0
00006DD0 122B 0008                  	move.b	slide_speed(a3),d1
00006DD4 0201 0080                  	andi.b	#$80,d1
00006DD8 8200                       	or.b	d0,d1
00006DDA 1741 0008                  	move.b	d1,slide_speed(a3)
00006DDE 4E75                       	rts
00006DE0                            
00006DE0                            ; ===============================================================
00006DE0                            ; ---------------------------------------------------------------
00006DE0                            ; Subroutine to update note
00006DE0                            ; ---------------------------------------------------------------
00006DE0                            ; INPUT:
00006DE0                            ;	d5 .b	Note
00006DE0                            ; ---------------------------------------------------------------
00006DE0                            
00006DE0                            TS_FM_UpdateNote:
00006DE0 0405 0080                  	subi.b	#$80,d5			; subtract $80 from the note
00006DE4 6700                       	beq.s	@SetRest		; if note $80, branch
00006DE6 3F05                       	move.w	d5,-(sp)
00006DE8                            
00006DE8 DA2D 0008                  	add.b	8(a5),d5		; add pitch to note
00006DEC 0245 007F                  	andi.w	#$7F,d5
00006DF0 4EB9 0000 0000             	jsr	TS_SetTargetNote
00006DF6 4EB9 0000 0000             	jsr	TS_SetNoteFrequency
00006DFC                            
00006DFC 3A1F                       	move.w	(sp)+,d5
00006DFE 1745 0006                  	move.b	d5,lastnote(a3)
00006E02 4E75                       	rts
00006E04                            
00006E04                            ; ---------------------------------------------------------------
00006E04                            @SetRest
00006E04 1745 0006                  	move.b	d5,lastnote(a3)		; save as last note read
00006E08 426D 0010                  	clr.w	$10(a5)
00006E0C 08D5 0001                  	bset	#1,(a5)
00006E10 4E75                       	rts
00006E12                            
00006E12                            ; ===============================================================
00006E12                            ; ---------------------------------------------------------------
00006E12                            ; Subroutine to set target note
00006E12                            ; ---------------------------------------------------------------
00006E12                            ; INPUT:
00006E12                            ;	d5 .b	Pitched Note
00006E12                            ; ---------------------------------------------------------------
00006E12                            
00006E12                            TS_SetTargetNote:
00006E12                            	; TODOh: Frequency displacement support
00006E12 1745 0002                  	move.b	d5,note_target(a3)
00006E16 422B 0003                  	clr.b	note_target+1(a3)		; clear note's fractional part
00006E1A                            
00006E1A 102B 0008                  	move.b	slide_speed(a3),d0
00006E1E 0240 007F                  	andi.w	#$7F,d0
00006E22 6700                       	beq.s	@NoPortamento
00006E24 082B 0007 0007             	btst	#7,slide_mode(a3)		; does sliding mode works for note off only?
00006E2A 6600                       	bne.s	@SetNoteToTarget		; if yes, branch
00006E2C 4A2B 0006                  	tst.b	lastnote(a3)			; ~~ was the last note zero?
00006E30 6600                       	bne.s	@SetSlide			; ~~ is yes, branch
00006E32 082B 0007 0008             	btst	#7,slide_speed(a3)
00006E38 6600                       	bne.s	@NoPortamento
00006E3A                            
00006E3A                            @SetSlide:
00006E3A 0400 0064                  	sub.b	#100,d0
00006E3E 342B 0002                  	move.w	note_target(a3),d2
00006E42 9453                       	sub.w	note(a3),d2			; Target Note < Note ?
00006E44 6500                       	bcs.s	@CalcNoteStep			; if yes, branch
00006E46 4400                       	neg.b	d0				; otherwise, negate byte
00006E48                            
00006E48                            @CalcNoteStep:
00006E48 4880                       	ext.w	d0
00006E4A EB40                       	asl.w	#5,d0
00006E4C 3740 0004                  	move.w	d0,note_step(a3)
00006E50 4E75                       	rts
00006E52                            
00006E52                            ; ---------------------------------------------------------------
00006E52                            @NoPortamento:
00006E52 426B 0004                  	clr.w	note_step(a3)
00006E56                            	
00006E56                            @SetNoteToTarget:
00006E56 36AB 0002                  	move.w	note_target(a3),note(a3)	; set Note to Target Note
00006E5A 4E75                       	rts
00006E5C                            
00006E5C                            ; ===============================================================
00006E5C                            ; ---------------------------------------------------------------
00006E5C                            ; Subroutine to update note
00006E5C                            ; ---------------------------------------------------------------
00006E5C                            
00006E5C                            TS_SetNoteFrequency:
00006E5C 1A13                       	move.b	note(a3),d5
00006E5E 0245 007F                  	andi.w	#$7F,d5
00006E62 78FF                       	moveq	#-1,d4				; d4 = octave
00006E64 760C                       	moveq	#12,d3				; d3 = octave size (in notes)
00006E66                            
00006E66                            @SplitNoteAndOctave:
00006E66 5244                       	addq.w	#1,d4
00006E68 9A43                       	sub.w	d3,d5
00006E6A 64FA                       	bcc.s	@SplitNoteAndOctave
00006E6C DA43                       	add.w	d3,d5
00006E6E DA45                       	add.w	d5,d5				; d5 = Note*2
00006E70 303B 5000                  	move.w	FM_Frequencies(pc,d5),d0
00006E74 EA5C                       	ror.w	#5,d4				; d4 = Octave<<11
00006E76 8044                       	or.w	d4,d0				; d0 = Octave<<11 + Frequency
00006E78 162B 0001                  	move.b	note+1(a3),d3			; d3 = Subnote
00006E7C 0243 001F                  	andi.w	#$1F,d3
00006E80 E94D                       	lsl.w	#4,d5				; d5 = Note*32
00006E82 DA43                       	add.w	d3,d5				; d5 = Note*32 + Subnote
00006E84 163B 5000                  	move.b	FM_PortamentoFreq(pc,d5),d3
00006E88 D043                       	add.w	d3,d0				; d0 = Octave<<11 + Frequency + PortamentoFreq
00006E8A 3B40 0010                  	move.w	d0,$10(a5)			; save frequency
00006E8E 4E75                       	rts
00006E90                            
00006E90                            ; ---------------------------------------------------------------
00006E90                            ; FM Frequencies table
00006E90                            ; ---------------------------------------------------------------
00006E90                            
00006E90                            FM_Frequencies:
00006E90 0284 02AA 02D3 02FE 032B+  	dc.w	$284, $2AA, $2D3, $2FE, $32B, $35B, $38E, $3C4, $3FE, $43B, $47B, $4BF
00006EA8                            
00006EA8                            FM_PortamentoFreq:
00006EA8 0001 0204 0506 0708 0A0B+  	dc.b	0, 1, 2, 4, 5, 6,  7,  8,   $A,  $B,  $C,  $D,  $E,  $10, $11, $12, $13, $14, $16, $17, $18, $19, $1A, $1C, $1D, $1E, $1F, $20, $21, $23, $24, $25
00006EC8 0001 0304 0506 0809 0A0B+  	dc.b	0, 1, 3, 4, 5, 6,  8,  9,   $A,  $B,  $D,  $E,  $F,  $10, $12, $13, $14, $16, $17, $18, $19, $1B, $1C, $1D, $1E, $20, $21, $22, $23, $25, $26, $27
00006EE8 0001 0304 0507 0809 0B0C+  	dc.b	0, 1, 3, 4, 5, 7,  8,  9,   $B,  $C,  $D,  $F,  $10, $11, $13, $14, $15, $17, $18, $1A, $1B, $1C, $1E, $1F, $20, $22, $23, $24, $26, $27, $28, $2A
00006F08 0001 0304 0607 090A 0B0D+  	dc.b	0, 1, 3, 4, 6, 7,  9,  $A,  $B,  $D,  $E,  $10, $11, $12, $14, $15, $17, $18, $1A, $1B, $1C, $1E, $1F, $21, $22, $24, $25, $26, $28, $29, $2B, $2C
00006F28 0002 0305 0608 090B 0C0E+  	dc.b	0, 2, 3, 5, 6, 8,  9,  $B,  $C,  $E,  $F,  $11, $12, $14, $15, $17, $18, $1A, $1B, $1D, $1E, $20, $21, $23, $24, $26, $27, $29, $2A, $2C, $2D, $2F
00006F48 0002 0305 0608 0A0B 0D0E+  	dc.b	0, 2, 3, 5, 6, 8,  $A, $B,  $D,  $E,  $10, $12, $13, $15, $16, $18, $1A, $1B, $1D, $1E, $20, $22, $23, $25, $26, $28, $2A, $2B, $2D, $2E, $30, $31
00006F68 0002 0305 0708 0A0C 0E0F+  	dc.b	0, 2, 3, 5, 7, 8,  $A, $C,  $E,  $F,  $11, $13, $14, $16, $18, $19, $1B, $1D, $1E, $20, $22, $24, $25, $27, $29, $2A, $2C, $2E, $2F, $30, $33, $34
00006F88 0002 0405 0709 0B0D 0E10+  	dc.b	0, 2, 4, 5, 7, 9,  $B, $D,  $E,  $10, $12, $14, $16, $17, $19, $1B, $1D, $1E, $20, $22, $24, $26, $27, $29, $2B, $2D, $2F, $30, $32, $34, $36, $38
00006FA8 0002 0406 0809 0B0D 0F11+  	dc.b	0, 2, 4, 6, 8, 9,  $B, $D,  $F,  $11, $13, $15, $17, $19, $1B, $1C, $1E, $20, $22, $24, $26, $28, $2A, $2C, $2E, $2F, $31, $33, $35, $37, $39, $3B
00006FC8 0002 0406 080A 0C0E 1012+  	dc.b	0, 2, 4, 6, 8, $A, $C, $E,  $10, $12, $14, $16, $18, $1A, $1C, $1E, $20, $22, $24, $26, $28, $2A, $2C, $2E, $30, $32, $34, $36, $38, $3A, $3C, $3E
00006FE8 0002 0406 090B 0D0F 1113+  	dc.b	0, 2, 4, 6, 9, $B, $D, $F,  $11, $13, $15, $17, $1A, $1C, $1E, $20, $22, $24, $26, $28, $2B, $2D, $2F, $31, $33, $35, $37, $3A, $3C, $3E, $40, $42
00007008 0002 0507 090B 0E10 1214+  	dc.b	0, 2, 5, 7, 9, $B, $E, $10, $12, $14, $17, $19, $1B, $1D, $20, $22, $24, $26, $29, $2B, $2D, $2F, $32, $34, $36, $38, $3B, $3D, $3F, $41, $44, $46
00007028                            
00007028                            
00007028                            		include	'_proc\swa.smps.music.asm'
00007028                            ; ---------------------------------------------------------------------------
00007028                            ; Music	Pointers
00007028                            ; ---------------------------------------------------------------------------
00007028                            
00007028 0000 0000                  MusicIndex:	dc.l Music81
0000702C                            		; , Music82
0000702C                            		; dc.l Music83, Music84
0000702C                            		; dc.l Music85, Music86
0000702C                            		; dc.l Music87, Music88
0000702C                            		; dc.l Music89, Music8A
0000702C                            		; dc.l Music8B, Music8C
0000702C                            		; dc.l Music8D, Music8E
0000702C                            		; dc.l Music8F, Music90
0000702C                            		; dc.l Music91, Music92
0000702C                            		; dc.l Music93, Music94
0000702C                            		; dc.l Music95, Music96
0000702C                            		; dc.l Music97, Music98
0000702C                            		; dc.l Music99, Music9A
0000702C                            		; dc.l Music9B, Music9C
0000702C                            		; dc.l Music9D, Music9E
0000702C                                    ; dc.l Music9F
0000702C                            
0000702C                            ; ---------------------------------------------------------------------------
0000702C                            MusicIndex2:	
0000702C                            		; dc.l MusicE5, MusicE6
0000702C                            		; dc.l MusicE7, MusicE8
0000702C                            		; dc.l MusicE9, MusicEA
0000702C                            		; dc.l MusicEB, MusicEC
0000702C                            		; dc.l MusicED, MusicEE
0000702C                            		; dc.l MusicEF, MusicF0
0000702C                            		; dc.l MusicF1, MusicF2
0000702C                            		; dc.l MusicF3, MusicF4
0000702C                                    ; dc.l MusicF5, MusicF6
0000702C                            		; dc.l MusicF7, MusicF8
0000702C                            		; dc.l MusicF9, MusicFA
0000702C                            		; dc.l MusicFB, MusicFC
0000702C                            		; dc.l MusicFD, MusicFE
0000702C                            		; dc.l MusicFF
0000702C                            
0000702C                            ; ---------------------------------------------------------------------------
0000702C                            Music81:	incbin	sound\music81.bin
0000861A                            		even
0000861A                            ; Music82:	incbin	sound\music82.bin
0000861A                            		; even
0000861A                            ; Music83:	incbin	sound\music83.bin
0000861A                            		; even
0000861A                            ; Music84:	incbin	sound\music84.bin
0000861A                            		; even
0000861A                            ; Music85:	incbin	sound\music85.bin
0000861A                            		; even
0000861A                            ; Music86:	incbin	sound\music86.bin
0000861A                            		; even
0000861A                            ; Music87:	incbin	sound\music87.bin
0000861A                            		; even
0000861A                            ; Music88:	incbin	sound\music88.bin
0000861A                            		; even
0000861A                            ; Music89:	incbin	sound\music89.bin
0000861A                            		; even
0000861A                            ; Music8A:	incbin	sound\music8A.bin
0000861A                            		; even
0000861A                            ; Music8B:	incbin	sound\music8B.bin
0000861A                            		; even
0000861A                            ; Music8C:	incbin	sound\music8C.bin
0000861A                            		; even
0000861A                            ; Music8D:	incbin	sound\music8D.bin
0000861A                            		; even
0000861A                            ; Music8E:	incbin	sound\music8E.bin
0000861A                            		; even
0000861A                            ; Music8F:	incbin	sound\music8F.bin
0000861A                            		; even
0000861A                            ; Music90:	incbin	sound\music90.bin
0000861A                            		; even
0000861A                            ; Music91:	incbin	sound\music91.bin
0000861A                            		; even
0000861A                            ; Music92:	incbin	sound\music82.bin
0000861A                            		; even
0000861A                            ; Music93:	incbin	sound\music93.bin
0000861A                            		; even
0000861A                            ; Music94:	incbin	sound\music94.bin
0000861A                            		; even
0000861A                            ; Music95:	incbin	sound\music95.bin
0000861A                            		; even
0000861A                            ; Music96:	incbin	sound\music96.bin
0000861A                            		; even
0000861A                            ; Music97:	incbin	sound\music97.bin
0000861A                            		; even
0000861A                            ; Music98:	incbin	sound\music98.bin
0000861A                            		; even
0000861A                            ; Music99:	incbin	sound\music99.bin
0000861A                            		; even
0000861A                            ; Music9A:	incbin	sound\music9A.bin
0000861A                            		; even
0000861A                            ; Music9B:	incbin	sound\music9B.bin
0000861A                            		; even
0000861A                            ; Music9C:	incbin	sound\music9C.bin
0000861A                            		; even
0000861A                            ; Music9D:	incbin	sound\music9D.bin
0000861A                            		; even
0000861A                            ; Music9E:	incbin	sound\music9E.bin
0000861A                            		; even
0000861A                            ; Music9F:	incbin	sound\music9F.bin
0000861A                            		; even
0000861A                            
0000861A                            ; ---------------------------------------------------------------------------
0000861A                            ; MusicE5:	incbin	sound\musicE5.bin
0000861A                            		; even
0000861A                            ; MusicE6:	incbin	sound\musicE6.bin
0000861A                            		; even
0000861A                            ; MusicE7:	incbin	sound\musicE7.bin
0000861A                            		; even
0000861A                            ; MusicE8:	incbin	sound\musicE8.bin
0000861A                            		; even
0000861A                            ; MusicE9:	incbin	sound\musicE9.bin
0000861A                            		; even
0000861A                            ; MusicEA:	incbin	sound\musicEA.bin
0000861A                            		; even
0000861A                            ; MusicEB:	incbin	sound\musicEB.bin
0000861A                            		; even
0000861A                            ; MusicEC:	incbin	sound\musicEC.bin
0000861A                            		; even
0000861A                            ; MusicED:	incbin	sound\musicED.bin
0000861A                            		; even
0000861A                            ; MusicEE:	incbin	sound\musicEE.bin
0000861A                            		; even
0000861A                            ; MusicEF:	incbin	sound\musicEF.bin
0000861A                            		; even
0000861A                            ; MusicF0:	incbin	sound\musicF0.bin
0000861A                            		; even
0000861A                            ; MusicF1:	incbin	sound\musicF1.bin
0000861A                            		; even
0000861A                            ; MusicF2:	incbin	sound\musicF2.bin
0000861A                            		; even
0000861A                            ; MusicF3:	incbin	sound\musicF3.bin
0000861A                            		; even
0000861A                            ; MusicF4:	incbin	sound\musicF4.bin
0000861A                            		; even
0000861A                            ; MusicF5:	incbin	sound\musicF5.bin
0000861A                            		; even
0000861A                            ; MusicF6:	incbin	sound\musicF6.bin
0000861A                            		; even
0000861A                            ; MusicF7:	incbin	sound\musicF7.bin
0000861A                            		; even
0000861A                            ; MusicF8:	incbin	sound\musicF8.bin
0000861A                            		; even
0000861A                            ; MusicF9:	incbin	sound\musicF9.bin
0000861A                            		; even
0000861A                            ; MusicFA:	incbin	sound\musicFA.bin
0000861A                            		; even
0000861A                            ; MusicFB:	incbin	sound\musicFB.bin
0000861A                            		; even
0000861A                            ; MusicFC:	incbin	sound\musicFC.bin
0000861A                            		; even
0000861A                            ; MusicFD:	incbin	sound\musicFD.bin
0000861A                            		; even
0000861A                            ; MusicFE:	incbin	sound\musicFE.bin
0000861A                            		; even
0000861A                            ; MusicFF:	incbin	sound\musicFF.bin
0000861A                            		; even
0000861A                            		; even
0000861A                            		include	'_proc\swa.smps.sounds.asm'
0000861A                            
0000861A                            ; ---------------------------------------------------------------------------
0000861A                            ; Sound	effect pointers
0000861A                            ; ---------------------------------------------------------------------------
0000861A                            SoundIndex:
0000861A 0000 0000                  ptr_sndA0:	dc.l SoundA0
0000861E 0000 0000                  ptr_sndA1:	dc.l SoundA1
00008622 0000 0000                  ptr_sndA2:	dc.l SoundA2
00008626 0000 0000                  ptr_sndA3:	dc.l SoundA3
0000862A 0000 0000                  ptr_sndA4:	dc.l SoundA4
0000862E 0000 0000                  ptr_sndA5:	dc.l SoundA5
00008632 0000 0000                  ptr_sndA6:	dc.l SoundA6
00008636 0000 0000                  ptr_sndA7:	dc.l SoundA7
0000863A 0000 0000                  ptr_sndA8:	dc.l SoundA8
0000863E 0000 0000                  ptr_sndA9:	dc.l SoundA9
00008642 0000 0000                  ptr_sndAA:	dc.l SoundAA
00008646 0000 0000                  ptr_sndAB:	dc.l SoundAB
0000864A 0000 0000                  ptr_sndAC:	dc.l SoundAC
0000864E 0000 0000                  ptr_sndAD:	dc.l SoundAD
00008652 0000 0000                  ptr_sndAE:	dc.l SoundAE
00008656 0000 0000                  ptr_sndAF:	dc.l SoundAF
0000865A 0000 0000                  ptr_sndB0:	dc.l SoundB0
0000865E 0000 0000                  ptr_sndB1:	dc.l SoundB1
00008662 0000 0000                  ptr_sndB2:	dc.l SoundB2
00008666 0000 0000                  ptr_sndB3:	dc.l SoundB3
0000866A 0000 0000                  ptr_sndB4:	dc.l SoundB4
0000866E 0000 0000                  ptr_sndB5:	dc.l SoundB5
00008672 0000 0000                  ptr_sndB6:	dc.l SoundB6
00008676 0000 0000                  ptr_sndB7:	dc.l SoundB7
0000867A 0000 0000                  ptr_sndB8:	dc.l SoundB8
0000867E 0000 0000                  ptr_sndB9:	dc.l SoundB9
00008682 0000 0000                  ptr_sndBA:	dc.l SoundBA
00008686 0000 0000                  ptr_sndBB:	dc.l SoundBB
0000868A 0000 0000                  ptr_sndBC:	dc.l SoundBC
0000868E 0000 0000                  ptr_sndBD:	dc.l SoundBD
00008692 0000 0000                  ptr_sndBE:	dc.l SoundBE
00008696 0000 0000                  ptr_sndBF:	dc.l SoundBF
0000869A 0000 0000                  ptr_sndC0:	dc.l SoundC0
0000869E 0000 0000                  ptr_sndC1:	dc.l SoundC1
000086A2 0000 0000                  ptr_sndC2:	dc.l SoundC2
000086A6 0000 0000                  ptr_sndC3:	dc.l SoundC3
000086AA 0000 0000                  ptr_sndC4:	dc.l SoundC4
000086AE 0000 0000                  ptr_sndC5:	dc.l SoundC5
000086B2 0000 0000                  ptr_sndC6:	dc.l SoundC6
000086B6 0000 0000                  ptr_sndC7:	dc.l SoundC7
000086BA 0000 0000                  ptr_sndC8:	dc.l SoundC8
000086BE 0000 0000                  ptr_sndC9:	dc.l SoundC9
000086C2 0000 0000                  ptr_sndCA:	dc.l SoundCA
000086C6 0000 0000                  ptr_sndCB:	dc.l SoundCB
000086CA 0000 0000                  ptr_sndCC:	dc.l SoundCC
000086CE 0000 0000                  ptr_sndCD:	dc.l SoundCD
000086D2 0000 0000                  ptr_sndCE:	dc.l SoundCE
000086D6 0000 0000                  ptr_sndCF:	dc.l SoundCF
000086DA 0000 0000                  ptr_sndD0:	dc.l SoundD0
000086DE 0000 0000                  		dc.l SoundD1
000086E2 0000 0000                  		dc.l SoundD2
000086E6 0000 0000                  		dc.l SoundD3
000086EA 0000 0000                  		dc.l SoundD4
000086EE 0000 0000                  		dc.l SoundD5
000086F2 0000 0000                  		dc.l SoundD6
000086F6 0000 0000                  		dc.l SoundD7
000086FA                            
000086FA                            SoundA0:	incbin	sound\soundA0.bin
00008710                            		even
00008710                            SoundA1:	incbin	sound\soundA1.bin
0000873A                            		even
0000873A                            SoundA2:	incbin	sound\soundA2.bin
0000875A                            		even
0000875A                            SoundA3:	incbin	sound\soundA3.bin
0000878C                            		even
0000878C                            SoundA4:	incbin	sound\soundA4.bin
000087C2                            		even
000087C2                            SoundA5:	incbin	sound\soundA5.bin
000087EE                            		even
000087EE                            SoundA6:	incbin	sound\soundA6.bin
0000881E                            		even
0000881E                            SoundA7:	incbin	sound\soundA7.bin
0000884E                            		even
0000884E                            SoundA8:	incbin	sound\soundA8.bin
00008882                            		even
00008882                            SoundA9:	incbin	sound\soundA9.bin
00008894                            		even
00008894                            SoundAA:	incbin	sound\soundAA.bin
000088D6                            		even
000088D6                            SoundAB:	incbin	sound\soundAB.bin
000088F6                            		even
000088F6                            SoundAC:	incbin	sound\soundAC.bin
0000892A                            		even
0000892A                            SoundAD:	incbin	sound\soundAD.bin
00008960                            		even
00008960                            SoundAE:	incbin	sound\soundAE.bin
000089AA                            		even
000089AA                            SoundAF:	incbin	sound\soundAF.bin
000089D8                            		even
000089D8                            SoundB0:	incbin	sound\soundB0.bin
00008A0A                            		even
00008A0A                            SoundB1:	incbin	sound\soundB1.bin
00008A36                            		even
00008A36                            SoundB2:	incbin	sound\soundB2.bin
00008A86                            		even
00008A86                            SoundB3:	incbin	sound\soundB3.bin
00008AD0                            		even
00008AD0                            SoundB4:	incbin	sound\soundB4.bin
00008B2C                            		even
00008B2C                            SoundB5:	incbin	sound\soundB5.bin
00008B5A                            		even
00008B5A                            SoundB6:	incbin	sound\soundB6.bin
00008B78                            		even
00008B78                            SoundB7:	incbin	sound\soundB7.bin
00008BB4                            		even
00008BB4                            SoundB8:	incbin	sound\soundB8.bin
00008BD2                            		even
00008BD2                            SoundB9:	incbin	sound\soundB9.bin
00008C36                            		even
00008C36                            SoundBA:	incbin	sound\soundBA.bin
00008C5E                            		even
00008C5E                            SoundBB:	incbin	sound\soundBB.bin
00008C8A                            		even
00008C8A                            SoundBC:	incbin	sound\soundBC.bin
00008CCC                            		even
00008CCC                            SoundBD:	incbin	sound\soundBD.bin
00008D20                            		even
00008D20                            SoundBE:	incbin	sound\soundBE.bin
00008D5A                            		even
00008D5A                            SoundBF:	incbin	sound\soundBF.bin
00008DCC                            		even
00008DCC                            SoundC0:	incbin	sound\soundC0.bin
00008DFA                            		even
00008DFA                            SoundC1:	incbin	sound\soundC1.bin
00008E34                            		even
00008E34                            SoundC2:	incbin	sound\soundC2.bin
00008E5E                            		even
00008E5E                            SoundC3:	incbin	sound\soundC3.bin
00008ED8                            		even
00008ED8                            SoundC4:	incbin	sound\soundC4.bin
00008F00                            		even
00008F00                            SoundC5:	incbin	sound\soundC5.bin
00008F68                            		even
00008F68                            SoundC6:	incbin	sound\soundC6.bin
00008FAA                            		even
00008FAA                            SoundC7:	incbin	sound\soundC7.bin
00008FD8                            		even
00008FD8                            SoundC8:	incbin	sound\soundC8.bin
00008FEA                            		even
00008FEA                            SoundC9:	incbin	sound\soundC9.bin
00009018                            		even
00009018                            SoundCA:	incbin	sound\soundCA.bin
00009046                            		even
00009046                            SoundCB:	incbin	sound\soundCB.bin
00009092                            		even
00009092                            SoundCC:	incbin	sound\soundCC.bin
000090CC                            		even
000090CC                            SoundCD:	incbin	sound\soundCD.bin
000090DA                            		even
000090DA                            SoundCE:	incbin	sound\soundCE.bin
00009108                            		even
00009108                            SoundCF:	incbin	sound\soundCF.bin
00009140                            		even
00009140                            SoundD0:	incbin	sound\soundD0.bin
0000917A                            		even
0000917A                            		
0000917A                            ; Spin Dash charge (Sonic 2)
0000917A 0000 0101                  SoundD1:	dc.w @0-SoundD1,$0101
0000917E 8005 0000 FD00             		dc.w $8005,@2-SoundD1,$FE00-$100
00009184 EF00                       @2		dc.b	$EF,$00
00009186 FC01                       		dc.b	$FC,$01		; ++ rev sound
00009188 F000 0120 F6               		dc.b	$F0,$00,$01,$20,$F6
0000918D C416 E7F4 D018 E7          		dc.b	$C4,$16,$E7,$F4,$D0,$18,$E7
00009194 04E7 E6                    @1		dc.b	$04,$E7,$E6
00009197 03F7 0010 FFFC             		dc.w	$03F7,$0010,@1-*-1
0000919D F2                         		dc.b	$F2
0000919E 3400 0C03 099F 8C8F 9500+  @0:		dc.b $34,$00,$0C,$03,$09,$9F,$8C,$8F,$95,$00,$00,$00		; 02/03 swap
000091AA 0000 0000 000F 0F0F 0F00+  		dc.b $00,$00,$00,$00,$00,$0F,$0F,$0F,$0F,$00,$00,$1D,$00	; 17/18 swap
000091B8 00                         		even
000091B8                            		
000091B8                            ; Bullet sound (Sonic 3)
000091B8                            SoundD2:	incbin	sound\soundD2.bin
000091E6 00                         		even
000091E6                            
000091E6                            ; Rising lava sound (SWA original)
000091E6                            SoundD3:	incbin	sound\soundD3.bin
00009234                            		even
00009234                            		
00009234                            ; Error sound (Sonic 2)
00009234 0000 0101                  SoundD4:	dc.w @0-SoundD4,$0101
00009238 8005 0000 0004             		dc.w $8005,@1-SoundD4,$0004
0000923E EF00 B006 8006 B018 F2     @1:		dc.b $EF,$00,$B0,$06,$80,$06,$B0,$18,$F2
00009247 3800 0000 001F 1F1F 1F00+  @0:		dc.b $38,$00,$00,$00,$00,$1F,$1F,$1F,$1F,$00,$00,$00		; 02/03 swap
00009253 0000 0000 000F 0F0F 0F1F+  		dc.b $00,$00,$00,$00,$00,$0F,$0F,$0F,$0F,$1F,$17,$0C,$00	; 17/18 swap
00009260                            
00009260                            ; Metal Sonic Buzz saw (Sonic 2, modification)
00009260 0000 0101                  SoundD5:	dc.w SoundD5_voice-SoundD5,$0101
00009264 8005 0000 0000             		dc.w $8005,SoundD5_track-SoundD5,$0000
0000926A EF00                       SoundD5_track	dc.b	$EF, $00	; smpsFMVoice 0
0000926C C614 E7                    		dc.b	$C6,$14,$E7	; $24 --> $14
0000926F C604 E7E6 08               @2		dc.b	$C6,$04,$E7, $E6,$08
00009274 F700 04                    		dc.b	$F7,$00,04	; smpsLoop
00009277 FFF7                       		dc.w	@2-*-1
00009279 F2                         		dc.b	$F2		; smpsStop
0000927A 3300 0010 311F 1D1E 0E00+  SoundD5_voice	dc.b $33,$00,$00,$10,$31,$1F,$1D,$1E,$0E,$00,$0C,$1D		; 02/03 swap
00009286 0000 0001 000F 0F0F 0F08+  		dc.b $00,$00,$00,$01,$00,$0F,$0F,$0F,$0F,$08,$07,$06,$80	; 17/18 swap
00009294 00                         		even
00009294                            
00009294                            ; Metal Sonic Buzz saw, far away (Sonic 2, modification)
00009294 0000 0101                  SoundD6:	dc.w SoundD6_voice-SoundD6,$0101
00009298 8005 0000 0006             		dc.w $8005,@0-SoundD6,$0006
0000929E E080                       @0		dc.b	$E0, $80	; pan-L
000092A0 F6                         		dc.b	$F6
000092A1 FFC8                       		dc.w	SoundD5_track-*-1
000092A3 3300 0010 311F 1D1E 0E00+  SoundD6_voice	dc.b $33,$00,$00,$10,$31,$1F,$1D,$1E,$0E,$00,$0C,$1D		; 02/03 swap
000092AF 0000 0001 000F 0F0F 0F08+  		dc.b $00,$00,$00,$01,$00,$0F,$0F,$0F,$0F,$08,$07,$06,$80	; 17/18 swap
000092BC                            		even
000092BC                            
000092BC                            ; Metal Sonic Stomp sound (Sonic 3)
000092BC 0000 0101                  SoundD7: 	dc.w @0-SoundD7,$0101
000092C0 8005 0000 EC00             		dc.w $8005,@1-SoundD7,$EC00
000092C6 EF00                       @1:		dc.b	$EF, $00	; smpsFMVoice 0
000092C8 A310                       		dc.b	$A3, $10
000092CA F2                         		dc.b	$F2		; smpsStop
000092CB 20                         @0:		dc.b	$20
000092CC 0000 0000 1F1F 1F1F 0011+  		dc.b	$00, $00, $00, $00,	$1F, $1F, $1F, $1F, 	$00, $11, $00, $00
000092D8 0000 0009 0FFF FF0F 0310+  		dc.b	$00, $00, $00, $09,	$0F, $FF, $FF, $0F, 	$03, $10, $1A, $80
000092E4                            		even
000092E4                            		even
000092E4                            		include	'_proc\swa.megapcm.asm'
000092E4                            
000092E4                            ; ===============================================================
000092E4                            ; Mega PCM Driver Include File
000092E4                            ; (c) 2012, Vladikcomper
000092E4                            ; ===============================================================
000092E4                            
000092E4                            ; ---------------------------------------------------------------
000092E4                            ; Variables used in DAC table
000092E4                            ; ---------------------------------------------------------------
000092E4                            
000092E4                            ; flags
000092E4 =000000C0                  panLR	= $C0
000092E4 =00000080                  panL	= $80
000092E4 =00000040                  panR	= $40
000092E4 =00000000                  pcm	= 0
000092E4 =00000004                  dpcm	= 4
000092E4 =00000002                  loop	= 2
000092E4 =00000001                  pri	= 1
000092E4                            
000092E4                            ; ---------------------------------------------------------------
000092E4                            ; Macros
000092E4                            ; ---------------------------------------------------------------
000092E4                            
000092E4                            z80word macro Value
000092E4                            	dc.w	((\Value)&$FF)<<8|((\Value)&$FF00)>>8
000092E4                            	endm
000092E4                            
000092E4                            DAC_Entry macro Pitch,Offset,Flags
000092E4                            	dc.b	\Flags			; 00h	- Flags
000092E4                            	dc.b	\Pitch			; 01h	- Pitch
000092E4                            	dc.b	(\Offset>>15)&$FF	; 02h	- Start Bank
000092E4                            	dc.b	(\Offset\_End>>15)&$FF	; 03h	- End Bank
000092E4                            	z80word	(\Offset)|$8000		; 04h	- Start Offset (in Start bank)
000092E4                            	z80word	(\Offset\_End-1)|$8000	; 06h	- End Offset (in End bank)
000092E4                            	endm
000092E4                            	
000092E4                            IncludeDAC macro Name,Extension
000092E4                            \Name:
000092E4                            	if strcmp('\extension','wav')
000092E4                            		incbin	'dac/\Name\.\Extension\',$3A
000092E4                            	else
000092E4                            		incbin	'dac/\Name\.\Extension\'
000092E4                            	endc
000092E4                            \Name\_End:
000092E4                            	endm
000092E4                            
000092E4                            ; ---------------------------------------------------------------
000092E4                            ; Driver's code
000092E4                            ; ---------------------------------------------------------------
000092E4                            
000092E4                            MegaPCM:
000092E4                            	incbin	'MegaPCM.z80'
000094F4                            
000094F4 0001 0000 0000 0000        	DAC_Entry   $01, Kick, pcm				; $81	- Kick
000094FC 0001 0000 0000 0000        	DAC_Entry   $01, Snare, pcm				; $82	- Snare
00009504 041B 0000 0000 0000        	DAC_Entry	$1B, Timpani, dpcm			; $83	- Timpani
0000950C 0000 0000 0000 0000        	dc.l	0,0								; $84	- <Free>
00009514 0000 0000 0000 0000        	dc.l	0,0								; $85	- <Free>
0000951C 0000 0000 0000 0000        	dc.l	0,0								; $86	- <Free>
00009524 0412 0000 0000 0000        	DAC_Entry	$12, Timpani, dpcm			; $87	- Hi-Timpani
0000952C 0415 0000 0000 0000        	DAC_Entry	$15, Timpani, dpcm			; $88	- Mid-Timpani
00009534 041B 0000 0000 0000        	DAC_Entry	$1B, Timpani, dpcm			; $88	- Mid-Low-Timpani
0000953C 041D 0000 0000 0000        	DAC_Entry	$1D, Timpani, dpcm			; $8A	- Low-Timpani
00009544                            
00009544                            MegaPCM_End:
00009544                            
00009544                            ; ---------------------------------------------------------------
00009544                            ; DAC Samples Files
00009544                            ; ---------------------------------------------------------------
00009544                            
0000C24C 00                         	even
0000C24C 00                         	even
0000C24C                            
0000C24C                            
0000C24C                            		
0000C24C                            EndOfRom:
